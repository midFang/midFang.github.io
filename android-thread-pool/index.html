<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>线程池参数详解 - midFang&#39;s Blog</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="midFang" />
  <meta name="description" content="这里直接拿 OKHttp 源码中的线程池举例：
1 2 3 4 5 6 7 8 9 10 11 12 13  public synchronized ExecutorService executorService() { if (executorService == null) { executorService = new ThreadPoolExecutor( 0, // 核心线程  Integer.MAX_VALUE, // 最大线程  60,	// 空闲线程闲置时间  TimeUnit.SECONDS,	// 闲置时间单位  new SynchronousQueue&amp;lt;Runnable&amp;gt;(), // 线程等待队列  Util.threadFactory(&amp;#34;OkHttp Dispatcher&amp;#34;, false) // 线程创建工厂  ); } return executorService; }  " />

  <meta name="keywords" content="Hugo, theme, jane" />






<meta name="generator" content="Hugo 0.58.3" />


<link rel="canonical" href="https://midFang.github.io/android-thread-pool/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.af20b78e95c84de86b00a0242a4a77bd2601700e1b250edf27537d957ac0041d.css" integrity="sha256-ryC3jpXITehrAKAkKkp3vSYBcA4bJQ7fJ1N9lXrABB0=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="线程池参数详解" />
<meta property="og:description" content="这里直接拿 OKHttp 源码中的线程池举例：


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13


public synchronized ExecutorService executorService() {
    if (executorService == null) {
      executorService = new ThreadPoolExecutor(
          									0, // 核心线程
                            Integer.MAX_VALUE,  // 最大线程
                            60,					// 空闲线程闲置时间
                            TimeUnit.SECONDS,	// 闲置时间单位
                            new SynchronousQueue&lt;Runnable&gt;(), // 线程等待队列
                            Util.threadFactory(&#34;OkHttp Dispatcher&#34;, false) // 线程创建工厂
      );
    }
    return executorService;
}

" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://midFang.github.io/android-thread-pool/" />
<meta property="article:published_time" content="2021-05-05T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-05-05T00:00:00+00:00" />
<meta itemprop="name" content="线程池参数详解">
<meta itemprop="description" content="这里直接拿 OKHttp 源码中的线程池举例：


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13


public synchronized ExecutorService executorService() {
    if (executorService == null) {
      executorService = new ThreadPoolExecutor(
          									0, // 核心线程
                            Integer.MAX_VALUE,  // 最大线程
                            60,					// 空闲线程闲置时间
                            TimeUnit.SECONDS,	// 闲置时间单位
                            new SynchronousQueue&lt;Runnable&gt;(), // 线程等待队列
                            Util.threadFactory(&#34;OkHttp Dispatcher&#34;, false) // 线程创建工厂
      );
    }
    return executorService;
}

">


<meta itemprop="datePublished" content="2021-05-05T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2021-05-05T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="2102">



<meta itemprop="keywords" content="Android,OKHttp,线程," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="线程池参数详解"/>
<meta name="twitter:description" content="这里直接拿 OKHttp 源码中的线程池举例：


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13


public synchronized ExecutorService executorService() {
    if (executorService == null) {
      executorService = new ThreadPoolExecutor(
          									0, // 核心线程
                            Integer.MAX_VALUE,  // 最大线程
                            60,					// 空闲线程闲置时间
                            TimeUnit.SECONDS,	// 闲置时间单位
                            new SynchronousQueue&lt;Runnable&gt;(), // 线程等待队列
                            Util.threadFactory(&#34;OkHttp Dispatcher&#34;, false) // 线程创建工厂
      );
    }
    return executorService;
}

"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">midFang's Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/">首页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/post/">全部文章</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/about/">关于</a>
          
        
      </li>
    

    
      <li class="mobile-menu-item">
        <a id="openSearchMobile" class="mobile-menu-item-link menu-item-search" href="#">
          <i class="iconfont">
            <svg version="1.1" viewBox="0 0 1024 1024"
  xmlns="http://www.w3.org/2000/svg" width="18" height="18"
  xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M973.81454219 973.81454219a91.78207815 91.78207815 0 0 1-129.80999631 0l-161.97482118-161.97482118a425.48527711 425.48527711 0 0 1-230.35931791 68.16531768 428.3346319 428.3346319 0 1 1 428.3346319-428.3346319 425.48527711 425.48527711 0 0 1-68.16531768 230.35931791l162.02961656 161.97482118a91.83687354 91.83687354 0 0 1-0.05479538 129.80999631zM451.67040679 145.69361559a305.97679241 305.97679241 0 1 0 0 611.95358361 305.97679241 305.97679241 0 0 0 0-611.95358361z">
  </path>
</svg>

          </i>
        </a>
      </li>
    
  </ul>
</nav>


  

  
    
<div class="modal-dialog">
    
    <div class="modal-content">
      <div id="closeSearch" title="Close" class="close">X</div>
      <div class="modal-header">
        <div class="modal-title">Search</div>
      </div>
      <div class="modal-body">
          <script>
            (function() {
              var cx = '57787f7f4d21d54fc';
              var gcse = document.createElement('script');
              gcse.type = 'text/javascript';
              gcse.async = true;
              gcse.src = (document.location.protocol == 'https:' ? 'https:' :
                  'http:') +
                '//cse.google.com/cse.js?cx=' + cx;
              var s = document.getElementsByTagName('script')[0];
              s.parentNode.insertBefore(gcse, s);
            })();
          </script>
          <gcse:search></gcse:search>
      </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      midFang's Blog
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/">首页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/post/">全部文章</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/about/">关于</a>
          

        

      </li>
    

    
    

    
      <li class="menu-item">
        <a id="openSearch" class="menu-item-link menu-item-search" href="#">
          <i class="iconfont">
            <svg version="1.1" viewBox="0 0 1024 1024"
  xmlns="http://www.w3.org/2000/svg" width="18" height="18"
  xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M973.81454219 973.81454219a91.78207815 91.78207815 0 0 1-129.80999631 0l-161.97482118-161.97482118a425.48527711 425.48527711 0 0 1-230.35931791 68.16531768 428.3346319 428.3346319 0 1 1 428.3346319-428.3346319 425.48527711 425.48527711 0 0 1-68.16531768 230.35931791l162.02961656 161.97482118a91.83687354 91.83687354 0 0 1-0.05479538 129.80999631zM451.67040679 145.69361559a305.97679241 305.97679241 0 1 0 0 611.95358361 305.97679241 305.97679241 0 0 0 0-611.95358361z">
  </path>
</svg>

          </i>
        </a>
      </li>
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">线程池参数详解</h1>
      
      <div class="post-meta">
        <time datetime="2021-05-05" class="post-time">
          2021-05-05
        </time>
        <div class="post-category">
            <a href="https://midFang.github.io/categories/android/"> Android </a>
            <a href="https://midFang.github.io/categories/okhttp/"> OKHttp </a>
            <a href="https://midFang.github.io/categories/%E7%BA%BF%E7%A8%8B/"> 线程 </a>
            
          </div>
        

        
        
          <span id="busuanzi_container_page_pv">
            | 阅读 <span id="busuanzi_value_page_pv"></span>
          </span>
        

        
        
          <span id="/android-thread-pool/" class="leancloud_visitors" data-flag-title="线程池参数详解">
            <span class="post-meta-item-text"> | 阅读 </span>
            <span class="leancloud-visitors-count"></span>
          </span>
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#情况一">情况一</a></li>
<li><a href="#情况二">情况二</a></li>
<li><a href="#情况三">情况三</a></li>
<li><a href="#情况四">情况四</a></li>
<li><a href="#情况五">情况五</a></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <p>这里直接拿 OKHttp 源码中的线程池举例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">synchronized</span> <span class="n">ExecutorService</span> <span class="nf">executorService</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">executorService</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">executorService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span>
          									<span class="n">0</span><span class="p">,</span> <span class="c1">// 核心线程
</span><span class="c1"></span>                            <span class="n">Integer</span><span class="p">.</span><span class="na">MAX_VALUE</span><span class="p">,</span>  <span class="c1">// 最大线程
</span><span class="c1"></span>                            <span class="n">60</span><span class="p">,</span>					<span class="c1">// 空闲线程闲置时间
</span><span class="c1"></span>                            <span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">,</span>	<span class="c1">// 闲置时间单位
</span><span class="c1"></span>                            <span class="k">new</span> <span class="n">SynchronousQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span><span class="p">(),</span> <span class="c1">// 线程等待队列
</span><span class="c1"></span>                            <span class="n">Util</span><span class="p">.</span><span class="na">threadFactory</span><span class="p">(</span><span class="s">&#34;OkHttp Dispatcher&#34;</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span> <span class="c1">// 线程创建工厂
</span><span class="c1"></span>      <span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">executorService</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>每个线程的参数都在上面注释了，然后再看下这几个参数都分别起着什么样的作用，他们的工作流程先看下这个图，大致是这样的：</p>

<p><img src="https://raw.githubusercontent.com/midFang/imgSource/main/202401141018721.png" alt="" /></p>

<p>当一个任务通过execute(Runnable)方法添加到线程池时：</p>

<ul>
<li>线程数量小于核心线程数时，新建线程(核心)来处理被添加的任务</li>
<li>线程数量大于等于 corePoolSize，存在空闲线程，使用空闲线程执行新任务</li>
<li>线程数量大于等于 corePoolSize，不存在空闲线程，新任务将被添加到等待队列，添加成功则等待空闲线程执行任务，添加失败：

<ul>
<li>线程数量小于最大线程数，新建线程执行新任务</li>
<li>线程数量大于最大线程数，拒绝此任务</li>
</ul></li>
</ul>

<p>现在用代码的例子来解释一下上述的情况：</p>

<h4 id="情况一">情况一</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">val</span> <span class="py">threadPoolExecutor</span> <span class="p">=</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span>
        <span class="m">1</span><span class="p">,</span> <span class="n">Int</span><span class="p">.</span><span class="n">MAX_VALUE</span><span class="p">,</span>
        <span class="m">60</span><span class="p">,</span> <span class="n">TimeUnit</span><span class="p">.</span><span class="n">SECONDS</span><span class="p">,</span>
        <span class="n">LinkedBlockingDeque</span><span class="p">&lt;</span><span class="n">Runnable</span><span class="p">&gt;()</span>
    <span class="p">)</span>
    <span class="n">threadPoolExecutor</span><span class="p">.</span><span class="n">execute</span> <span class="p">{</span>
        <span class="n">println</span><span class="p">(</span><span class="s">&#34;任务一&#34;</span><span class="p">)</span>
        <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">){}</span>
    <span class="p">}</span>
    <span class="n">threadPoolExecutor</span><span class="p">.</span><span class="n">execute</span> <span class="p">{</span>
        <span class="n">println</span><span class="p">(</span><span class="s">&#34;任务二&#34;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>执行结果</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">任务一</pre></td></tr></table>
</div>
</div>
<p>只有任务一会被执行，其余的任务不会被执行，这是因为核心线程数是 1 ，最大线程数量为 Int 的最大数，当执行任务一的时候，任务一执行成功，但是任务并没有结束，然后执行任务二的时候，任务会被成功添加到等待队列中，但是由于核心线程数只有一个的关系，根据上图的关系，只有等待空闲线程才会执行任务二。</p>

<h4 id="情况二">情况二</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">val</span> <span class="py">threadPoolExecutor</span> <span class="p">=</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span>
        <span class="m">1</span><span class="p">,</span> <span class="n">Int</span><span class="p">.</span><span class="n">MAX_VALUE</span><span class="p">,</span>
        <span class="m">60</span><span class="p">,</span> <span class="n">TimeUnit</span><span class="p">.</span><span class="n">SECONDS</span><span class="p">,</span>
        <span class="n">ArrayBlockingQueue</span><span class="p">&lt;</span><span class="n">Runnable</span><span class="p">&gt;(</span><span class="m">1</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">threadPoolExecutor</span><span class="p">.</span><span class="n">execute</span> <span class="p">{</span>
        <span class="n">println</span><span class="p">(</span><span class="s">&#34;任务一&#34;</span><span class="p">)</span>
        <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">){}</span>
    <span class="p">}</span>
    <span class="n">threadPoolExecutor</span><span class="p">.</span><span class="n">execute</span> <span class="p">{</span>
        <span class="n">println</span><span class="p">(</span><span class="s">&#34;任务二&#34;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>这个打印的结果和情况一是一样的，不一样的情况就是使用的队列是 ArrayBlockingQueue 大小为一个，如果按照正常情况的解释是如果执行任务情况一将添加到了队列中，然后启动核心线程执行任务，那么执行任务二的时候就添加到队列中失败了，因为满了，那么又因为线程数量小于最大线程数，所以会再创建一个线程去执行。按理说任务一和任务二都会执行的。理论上是这样的，其实不是，在执行任务一的时候，并没有添加到这个队列中去，而是直接执行任务了。看如下 execute 源码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"> <span class="kd">public</span> <span class="nf">void</span> <span class="n">execute</span><span class="p">(</span><span class="n">Runnable</span> <span class="nf">var1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">var1</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kt">int</span> <span class="nf">var2</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">ctl</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">workerCountOf</span><span class="p">(</span><span class="n">var2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="na">corePoolSize</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">addWorker</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="kc">true</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">return</span><span class="p">;</span> <span class="c1">// 执行任务一的时候没有添加到 workQueue 中，而是直接执行任务了
</span><span class="c1"></span>                <span class="p">}</span>

                <span class="n">var2</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">ctl</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
            <span class="p">}</span>
						<span class="c1">// 执行任务二的时候才添加到这个队列中了，是添加成功的
</span><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">isRunning</span><span class="p">(</span><span class="n">var2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="na">workQueue</span><span class="p">.</span><span class="na">offer</span><span class="p">(</span><span class="n">var1</span><span class="p">))</span> <span class="p">{</span>
                <span class="kt">int</span> <span class="nf">var3</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">ctl</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isRunning</span><span class="p">(</span><span class="n">var3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">var1</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="na">reject</span><span class="p">(</span><span class="n">var1</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">workerCountOf</span><span class="p">(</span><span class="n">var3</span><span class="p">)</span> <span class="o">==</span> <span class="n">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="na">addWorker</span><span class="p">((</span><span class="n">Runnable</span><span class="p">)</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="na">addWorker</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="kc">false</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="na">reject</span><span class="p">(</span><span class="n">var1</span><span class="p">);</span>
            <span class="p">}</span>

        <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>执行任务一的时候，会执行第 7 行直接执行这个任务然后就被 return 掉了，并没有添加到 workQueue 中，然后执行任务二的时候则会添加成功，但是在经过第 16 行 isRunning 当前线程是正在运行的，所以条件不成立，会执行 workerCountOf，而当前运行的线程并不为 0 ，所以这里没有调用 addWorker 方法，所以任务二没有被执行。</p>

<h4 id="情况三">情况三</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">val</span> <span class="py">threadPoolExecutor</span> <span class="p">=</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span>
        <span class="m">1</span><span class="p">,</span> <span class="n">Int</span><span class="p">.</span><span class="n">MAX_VALUE</span><span class="p">,</span>
        <span class="m">60</span><span class="p">,</span> <span class="n">TimeUnit</span><span class="p">.</span><span class="n">SECONDS</span><span class="p">,</span>
        <span class="n">ArrayBlockingQueue</span><span class="p">&lt;</span><span class="n">Runnable</span><span class="p">&gt;(</span><span class="m">1</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">threadPoolExecutor</span><span class="p">.</span><span class="n">execute</span> <span class="p">{</span>
        <span class="n">println</span><span class="p">(</span><span class="s">&#34;任务一&#34;</span><span class="p">)</span>
<span class="c1">//        while (true){}
</span><span class="c1"></span>    <span class="p">}</span>
    <span class="n">threadPoolExecutor</span><span class="p">.</span><span class="n">execute</span> <span class="p">{</span>
        <span class="n">println</span><span class="p">(</span><span class="s">&#34;任务二&#34;</span><span class="p">)</span>
    <span class="p">}</span>

<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>执行结果</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span></pre></td>
<td class="lntd">
<pre class="chroma">任务一
任务二</pre></td></tr></table>
</div>
</div>
<p>任务一和任务二都能够被执行，这是因为在执行任务二的时候，任务一执行完毕了，已经有空闲线程了，那么就会去执行任务二了。</p>

<h4 id="情况四">情况四</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">val</span> <span class="py">threadPoolExecutor</span> <span class="p">=</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span>
        <span class="m">1</span><span class="p">,</span> <span class="n">Int</span><span class="p">.</span><span class="n">MAX_VALUE</span><span class="p">,</span>
        <span class="m">60</span><span class="p">,</span> <span class="n">TimeUnit</span><span class="p">.</span><span class="n">SECONDS</span><span class="p">,</span>
        <span class="n">ArrayBlockingQueue</span><span class="p">&lt;</span><span class="n">Runnable</span><span class="p">&gt;(</span><span class="m">1</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">threadPoolExecutor</span><span class="p">.</span><span class="n">execute</span> <span class="p">{</span>
        <span class="n">println</span><span class="p">(</span><span class="s">&#34;任务一&#34;</span><span class="p">)</span>
        <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">){}</span>
    <span class="p">}</span>
    <span class="n">threadPoolExecutor</span><span class="p">.</span><span class="n">execute</span> <span class="p">{</span>
        <span class="n">println</span><span class="p">(</span><span class="s">&#34;任务二&#34;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">threadPoolExecutor</span><span class="p">.</span><span class="n">execute</span> <span class="p">{</span>
        <span class="n">println</span><span class="p">(</span><span class="s">&#34;任务三&#34;</span><span class="p">)</span>
    <span class="p">}</span>

<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>执行结果</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></pre></td>
<td class="lntd">
<pre class="chroma">任务一
任务三
任务二</pre></td></tr></table>
</div>
</div>
<p>任务都能够被执行，这里的执行循序是 1 3 2 ，这是因为任务一直接会被执行，然后将任务二添加到队列中，等待空闲线程才会去执行。紧接着任务三会尝试添加到队列中，但是这个时候队列满了，添加失败，由于线程数量小于最大线程数，然后会创建一个新的线程去执行任务三，任务三执行完之后就有空闲线程了，就会去执行任务二了。</p>

<h4 id="情况五">情况五</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">val</span> <span class="py">threadPoolExecutor</span> <span class="p">=</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span>
        <span class="m">0</span><span class="p">,</span> <span class="n">Int</span><span class="p">.</span><span class="n">MAX_VALUE</span><span class="p">,</span>
        <span class="m">60</span><span class="p">,</span> <span class="n">TimeUnit</span><span class="p">.</span><span class="n">SECONDS</span><span class="p">,</span>
        <span class="n">SynchronousQueue</span><span class="p">&lt;</span><span class="n">Runnable</span><span class="p">&gt;()</span>
    <span class="p">)</span>
    <span class="n">threadPoolExecutor</span><span class="p">.</span><span class="n">execute</span> <span class="p">{</span>
        <span class="n">println</span><span class="p">(</span><span class="s">&#34;任务一&#34;</span><span class="p">)</span>
        <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">){}</span>
    <span class="p">}</span>
    <span class="n">threadPoolExecutor</span><span class="p">.</span><span class="n">execute</span> <span class="p">{</span>
        <span class="n">println</span><span class="p">(</span><span class="s">&#34;任务二&#34;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">threadPoolExecutor</span><span class="p">.</span><span class="n">execute</span> <span class="p">{</span>
        <span class="n">println</span><span class="p">(</span><span class="s">&#34;任务三&#34;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>执行结果</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></pre></td>
<td class="lntd">
<pre class="chroma">任务一
任务二
任务三</pre></td></tr></table>
</div>
</div>
<p>任务都能够被执行，其实这里的参数配置和 OKHttp 的线程池配置是一样的了，注意这里的核心线程数虽然是 0，使用的是 SynchronousQueue 队列，至于为什么都能够被执行之前，先简单了解一下 3 个队列的区别</p>

<ul>
<li>ArrayBlockingQueue

<ul>
<li>基于数组的阻塞队列，初始化需要指定固定大小</li>
</ul></li>
<li>LinkedBlockingDeque

<ul>
<li>基于链表实现的阻塞队列，初始化可以指定大小，也可以不指定</li>
</ul></li>
<li>SynchronousQueue

<ul>
<li>无容量的队列</li>
</ul></li>
</ul>

<p>这 3 个队列的区别大概就是这些了，因为 SynchronousQueue 是无容量的队列，即使核心线程数是 0 的情况下，每次添加任务的时候都会失败，由于线程数量小于最大线程数，所以每次都会创建新线程去执行任务（如果没有空闲线程的情况下），这就是为什么都能够执行任务， <a href="https://www.midfang.com/okhttp-source-code-analysis/">也是为什么 OKHttp 会这么配置的原因</a>，这样可以保证<strong>最大的并发量</strong>，一有任务就能够立即被执行。</p>

<p>源码地址：<a href="https://github.com/midFang/blogSource/tree/main/Thread">https://github.com/midFang/blogSource/tree/main/Thread</a></p>
    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">midFang</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
      2021-05-05
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://midFang.github.io/tags/android/">Android</a>
          <a href="https://midFang.github.io/tags/okhttp/">OKHttp</a>
          <a href="https://midFang.github.io/tags/%E7%BA%BF%E7%A8%8B/">线程</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/compose-animation-basics/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">Compose 动画基础篇之各种 Spec</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/android-socket-long-connection/">
            <span class="next-text nav-default">Socket 长连接通信实践与 NAT 超时</span>
            <span class="prev-text nav-mobile">Next</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "midFang/blog-comments"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="https://github.com/midFang" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="https://stackoverflow.com/users/14331888/midfang" rel="me noopener" class="iconfont"
      title="stack-overflow"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M809.714286 932.571429l-638.857143 0 0-274.285714-91.428571 0 0 365.714286 821.714286 0 0-365.714286-91.428571 0 0 274.285714zm-538.285714-299.428571l18.857143-89.714286 447.428571 94.285714-18.857143 89.142857zm58.857143-213.714286l38.285714-83.428571 414.285714 193.714286-38.285714 82.857143zm114.857143-203.428571l58.285714-70.285714 350.857143 293.142857-58.285714 70.285714zm226.857143-216l272.571429 366.285714-73.142857 54.857143-272.571429-366.285714zm-410.285714 840.571429l0-90.857143 457.142857 0 0 90.857143-457.142857 0z"></path>
</svg>

    </a>
  
    <a href="https://www.douban.com/people/194654920/" rel="me noopener" class="iconfont"
      title="douban"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M926.917973 37.80608C959.65184 37.80608 986.19392 64.34816 986.19392 97.082027L986.19392 926.917973C986.19392 959.65184 959.65184 986.19392 926.917973 986.19392L97.082027 986.19392C64.34816 986.19392 37.80608 959.65184 37.80608 926.917973L37.80608 97.082027C37.80608 64.34816 64.34816 37.80608 97.082027 37.80608zM176.653653 176.19968 176.653653 252.678827 825.658027 252.678827 825.658027 176.19968zM217.719467 316.146347 217.719467 628.08064 273.524053 628.08064 341.292373 770.39616 157.259093 770.39616 157.259093 845.417813 842.949973 845.417813 842.949973 770.39616 654.226773 770.39616 722.899627 628.08064 783.67744 628.08064 783.67744 316.146347zM684.885333 392.891733 684.885333 553.987413 312.576 553.987413 312.576 392.891733zM570.770773 770.39616 426.653013 770.39616 359.621973 628.08064 639.443627 628.08064z"></path>
</svg>

    </a>


<a href="https://midFang.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2020 -
    2024
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        midFang
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>















  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script type="text/javascript">
    AV.initialize( null ,  null );
  </script>

  <script>
    function showHitCount(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push($(this).attr("id").trim());
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var hits = item.get('hits');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(hits);
          }
          for (var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if (countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function (results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("hits");
            counter.save(null, {
              success: function (counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('hits'));
              },
              error: function (counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
             
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
             
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("hits", 1);
            newcounter.save(null, {
              success: function (newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('hits'));
              },
              error: function (newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function (error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function () {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        
        addCount(Counter);
      } else if ($('.post-link').length > 1) {
        
        showHitCount(Counter);
      }
    });
  </script>





  <script>
    $("#openSearch, #openSearchMobile").click(function(){
      $(".modal-dialog").addClass("visible");
    });

    $("#closeSearch").click(function(){
      $(".modal-dialog").removeClass("visible");
    });

    $(document).click(function(event) {
    
      if (!$(event.target).closest(".modal-content, #openSearch, #openSearchMobile").length) {
        $("body").find(".modal-dialog").removeClass("visible");
      }
    });
  </script>





</body>
</html>
