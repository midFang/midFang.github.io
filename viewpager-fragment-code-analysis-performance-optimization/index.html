<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>ViewPager &#43; Fragment 源码解析与性能优化 - midFang&#39;s Blog</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="midFang" />
  <meta name="description" content="在很多项目中都有 Banner 广告页或者是 Tab 切换页，如果是如下布局的情况，那么肯定遇到过这个问题，那就是这个 ViewPager 并不会包裹内容填充，而是会填充满整个布局，" />

  <meta name="keywords" content="Hugo, theme, jane" />






<meta name="generator" content="Hugo 0.58.3" />


<link rel="canonical" href="https://midFang.github.io/viewpager-fragment-code-analysis-performance-optimization/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.af20b78e95c84de86b00a0242a4a77bd2601700e1b250edf27537d957ac0041d.css" integrity="sha256-ryC3jpXITehrAKAkKkp3vSYBcA4bJQ7fJ1N9lXrABB0=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="ViewPager &#43; Fragment 源码解析与性能优化" />
<meta property="og:description" content="在很多项目中都有 Banner 广告页或者是 Tab 切换页，如果是如下布局的情况，那么肯定遇到过这个问题，那就是这个 ViewPager 并不会包裹内容填充，而是会填充满整个布局，" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://midFang.github.io/viewpager-fragment-code-analysis-performance-optimization/" />
<meta property="article:published_time" content="2021-04-03T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-04-03T00:00:00+00:00" />
<meta itemprop="name" content="ViewPager &#43; Fragment 源码解析与性能优化">
<meta itemprop="description" content="在很多项目中都有 Banner 广告页或者是 Tab 切换页，如果是如下布局的情况，那么肯定遇到过这个问题，那就是这个 ViewPager 并不会包裹内容填充，而是会填充满整个布局，">


<meta itemprop="datePublished" content="2021-04-03T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2021-04-03T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="2899">



<meta itemprop="keywords" content="Android,源码分析,性能优化," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ViewPager &#43; Fragment 源码解析与性能优化"/>
<meta name="twitter:description" content="在很多项目中都有 Banner 广告页或者是 Tab 切换页，如果是如下布局的情况，那么肯定遇到过这个问题，那就是这个 ViewPager 并不会包裹内容填充，而是会填充满整个布局，"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">midFang's Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/">首页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/post/">全部文章</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/about/">关于</a>
          
        
      </li>
    

    
      <li class="mobile-menu-item">
        <a id="openSearchMobile" class="mobile-menu-item-link menu-item-search" href="#">
          <i class="iconfont">
            <svg version="1.1" viewBox="0 0 1024 1024"
  xmlns="http://www.w3.org/2000/svg" width="18" height="18"
  xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M973.81454219 973.81454219a91.78207815 91.78207815 0 0 1-129.80999631 0l-161.97482118-161.97482118a425.48527711 425.48527711 0 0 1-230.35931791 68.16531768 428.3346319 428.3346319 0 1 1 428.3346319-428.3346319 425.48527711 425.48527711 0 0 1-68.16531768 230.35931791l162.02961656 161.97482118a91.83687354 91.83687354 0 0 1-0.05479538 129.80999631zM451.67040679 145.69361559a305.97679241 305.97679241 0 1 0 0 611.95358361 305.97679241 305.97679241 0 0 0 0-611.95358361z">
  </path>
</svg>

          </i>
        </a>
      </li>
    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  
    
<div class="modal-dialog">
    
    <div class="modal-content">
      <div id="closeSearch" title="Close" class="close">X</div>
      <div class="modal-header">
        <div class="modal-title">Search</div>
      </div>
      <div class="modal-body">
          <script>
            (function() {
              var cx = '57787f7f4d21d54fc';
              var gcse = document.createElement('script');
              gcse.type = 'text/javascript';
              gcse.async = true;
              gcse.src = (document.location.protocol == 'https:' ? 'https:' :
                  'http:') +
                '//cse.google.com/cse.js?cx=' + cx;
              var s = document.getElementsByTagName('script')[0];
              s.parentNode.insertBefore(gcse, s);
            })();
          </script>
          <gcse:search></gcse:search>
      </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      midFang's Blog
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/">首页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/post/">全部文章</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/about/">关于</a>
          

        

      </li>
    

    
    

    
      <li class="menu-item">
        <a id="openSearch" class="menu-item-link menu-item-search" href="#">
          <i class="iconfont">
            <svg version="1.1" viewBox="0 0 1024 1024"
  xmlns="http://www.w3.org/2000/svg" width="18" height="18"
  xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M973.81454219 973.81454219a91.78207815 91.78207815 0 0 1-129.80999631 0l-161.97482118-161.97482118a425.48527711 425.48527711 0 0 1-230.35931791 68.16531768 428.3346319 428.3346319 0 1 1 428.3346319-428.3346319 425.48527711 425.48527711 0 0 1-68.16531768 230.35931791l162.02961656 161.97482118a91.83687354 91.83687354 0 0 1-0.05479538 129.80999631zM451.67040679 145.69361559a305.97679241 305.97679241 0 1 0 0 611.95358361 305.97679241 305.97679241 0 0 0 0-611.95358361z">
  </path>
</svg>

          </i>
        </a>
      </li>
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">ViewPager &#43; Fragment 源码解析与性能优化</h1>
      
      <div class="post-meta">
        <time datetime="2021-04-03" class="post-time">
          2021-04-03
        </time>
        <div class="post-category">
            <a href="https://midFang.github.io/categories/android/"> Android </a>
            <a href="https://midFang.github.io/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"> 源码分析 </a>
            <a href="https://midFang.github.io/categories/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"> 性能优化 </a>
            
          </div>
        

        
        
          <span id="busuanzi_container_page_pv">
            | 阅读 <span id="busuanzi_value_page_pv"></span>
          </span>
        

        
        
          <span id="/viewpager-fragment-code-analysis-performance-optimization/" class="leancloud_visitors" data-flag-title="ViewPager &#43; Fragment 源码解析与性能优化">
            <span class="post-meta-item-text"> | 阅读 </span>
            <span class="leancloud-visitors-count"></span>
          </span>
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#懒加载">懒加载</a></li>
<li><a href="#setuservisiblehint">setUserVisibleHint</a></li>
<li><a href="#onhiddenchanged">onHiddenChanged</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      

<p>在很多项目中都有 Banner 广告页或者是 Tab 切换页，如果是如下布局的情况，那么肯定遇到过这个问题，那就是这个 ViewPager 并不会包裹内容填充，而是会填充满整个布局，如下：</p>

<p><img src="https://raw.githubusercontent.com/checkFang/img/master/20210328125749.png" alt="" /></p>

<p>看一下 ViewPager 中的绘制源码</p>

<p><img src="https://raw.githubusercontent.com/checkFang/img/master/20210328130946.png" alt="" /></p>

<p>View 的自身的宽高是和父 View 的剩余大小有关系的，那么在这个地方，由于 ViewPager 的父 View 是填充满整个屏幕的，所以 ViewPager 中的测量规格也是填充满整个屏幕的，而且也直接通过 setMeasuredDimension 设置了。所以也是填充满整个屏幕的。解决方式的话，可以通过自定义 View 的方式，测量子 View 的大小，然后再给定测量规格，代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"> <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="nf">void</span> <span class="n">onMeasure</span><span class="p">(</span><span class="kt">int</span> <span class="nf">widthMeasureSpec</span><span class="p">,</span> <span class="kt">int</span> <span class="nf">heightMeasureSpec</span><span class="p">)</span> <span class="p">{</span>

        <span class="kt">int</span> <span class="nf">height</span> <span class="o">=</span> <span class="n">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="nf">i</span> <span class="o">=</span> <span class="n">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">getChildCount</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">View</span> <span class="nf">child</span> <span class="o">=</span> <span class="n">getChildAt</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
            <span class="n">child</span><span class="p">.</span><span class="na">measure</span><span class="p">(</span><span class="n">widthMeasureSpec</span><span class="p">,</span> <span class="n">MeasureSpec</span><span class="p">.</span><span class="na">makeMeasureSpec</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="n">MeasureSpec</span><span class="p">.</span><span class="na">UNSPECIFIED</span><span class="p">));</span>
            <span class="kt">int</span> <span class="nf">h</span> <span class="o">=</span> <span class="n">child</span><span class="p">.</span><span class="na">getMeasuredHeight</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">&gt;</span> <span class="n">height</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">height</span> <span class="o">=</span> <span class="n">h</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">heightMeasureSpec</span> <span class="o">=</span> <span class="n">MeasureSpec</span><span class="p">.</span><span class="na">makeMeasureSpec</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">MeasureSpec</span><span class="p">.</span><span class="na">EXACTLY</span><span class="p">);</span>

        <span class="kd">super</span><span class="p">.</span><span class="na">onMeasure</span><span class="p">(</span><span class="n">widthMeasureSpec</span><span class="p">,</span> <span class="n">heightMeasureSpec</span><span class="p">);</span>
    <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>接着再看看 setOffscreenPageLimit 这个方法，在早期的时候，我们可能为了 Fragment 可以提前加载好数据，或者在切换到第二个界面的时候，这个数据就已经加载好了。这里会遇到一个问题，就是即使我们设置的这个值是 0 那么也是无法起到作用的，因为源码中如果设置比 1 还小的数，最终也会设置为 1 个缓存的数量，如下源码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="nf">void</span> <span class="n">setOffscreenPageLimit</span><span class="p">(</span><span class="kt">int</span> <span class="nf">limit</span><span class="p">)</span> <span class="p">{</span>
      	<span class="c1">// DEFAULT_OFFSCREEN_PAGES 默认值就是 1 
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&lt;</span> <span class="n">DEFAULT_OFFSCREEN_PAGES</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Log</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s">&#34;Requested offscreen page limit &#34;</span> <span class="o">+</span> <span class="n">limit</span> <span class="o">+</span> <span class="s">&#34; too small; defaulting to &#34;</span>
                    <span class="o">+</span> <span class="n">DEFAULT_OFFSCREEN_PAGES</span><span class="p">);</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="n">DEFAULT_OFFSCREEN_PAGES</span><span class="p">;</span> <span class="c1">// DEFAULT_OFFSCREEN_PAGES 默认值是 1； 
</span><span class="c1"></span>        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">!=</span> <span class="n">mOffscreenPageLimit</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">mOffscreenPageLimit</span> <span class="o">=</span> <span class="n">limit</span><span class="p">;</span>
            <span class="n">populate</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>那么现在就引出了另外一个问题，那么就是当界面不可见的时候，用户就不想去加载数据，用户想在当前界面可见的时候才去加载数据，假设有一个 App 是如下类似这样的，其实也就是懒加载的情况了</p>

<p><img src="https://raw.githubusercontent.com/checkFang/img/master/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202021-04-01%20%E4%B8%8A%E5%8D%8812.08.06.png" alt="" /></p>

<p>其实这里还有个极端一点的情况，那么就是当 ViewPager + fragment 显示的时候，fragment 1 内部有一个 Banner，这个 fragment1  是用户启动 App 的时候就处于可见，那么假如 fragment2 内部也有一个 Banner，由于 ViewPager 的预加载特性，那么 Fragment2 中的数据也会被提前加载好了，其实是可以不必要的</p>

<h3 id="懒加载">懒加载</h3>

<blockquote>
<p>要掌握 Fragment 的懒加载，首先要了解一下 Fragment 的生命周期的变化，然后观察从哪个方法可以入手懒加载数据</p>
</blockquote>

<p>Fragment 生命周期：onAttach -&gt; onCreate -&gt; onCreatedView -&gt; onActivityCreated -&gt; onStart -&gt; onResume -&gt; onPause -&gt; onStop -&gt; onDestroyView -&gt; onDestroy -&gt; onDetach</p>

<p>Fragment 的生命周期就是这些方法了，显而易见如果在这几个方法中做数据的懒加载，那么肯定是实现不了的。所以这里先了解一下 Fragment 不涉及生命周期的其他方法</p>

<h3 id="setuservisiblehint">setUserVisibleHint</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/**
</span><span class="cm">     * Set a hint to the system about whether this fragment&#39;s UI is currently visible
</span><span class="cm">     * to the user. This hint defaults to true and is persistent across fragment instance
</span><span class="cm">     * state save and restore.
</span><span class="cm">     *
</span><span class="cm">     * &lt;p&gt;An app may set this to false to indicate that the fragment&#39;s UI is
</span><span class="cm">     * scrolled out of visibility or is otherwise not directly visible to the user.
</span><span class="cm">     * This may be used by the system to prioritize operations such as fragment lifecycle updates
</span><span class="cm">     * or loader ordering behavior.&lt;/p&gt;
</span><span class="cm">     *
</span><span class="cm">     * &lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; This method may be called outside of the fragment lifecycle.
</span><span class="cm">     * and thus has no ordering guarantees with regard to fragment lifecycle method calls.&lt;/p&gt;
</span><span class="cm">     *
</span><span class="cm">     * @param isVisibleToUser true if this fragment&#39;s UI is currently visible to the user (default),
</span><span class="cm">     *                        false if it is not.
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="nf">void</span> <span class="n">setUserVisibleHint</span><span class="p">(</span><span class="kt">boolean</span> <span class="nf">isVisibleToUser</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mUserVisibleHint</span> <span class="o">&amp;&amp;</span> <span class="n">isVisibleToUser</span> <span class="o">&amp;&amp;</span> <span class="n">mState</span> <span class="o">&lt;</span> <span class="n">STARTED</span>
                <span class="o">&amp;&amp;</span> <span class="n">mFragmentManager</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">isAdded</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">mFragmentManager</span><span class="p">.</span><span class="na">performPendingDeferredStart</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">mUserVisibleHint</span> <span class="o">=</span> <span class="n">isVisibleToUser</span><span class="p">;</span>
        <span class="n">mDeferStart</span> <span class="o">=</span> <span class="n">mState</span> <span class="o">&lt;</span> <span class="n">STARTED</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isVisibleToUser</span><span class="p">;</span>
    <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>这个方法一般只会在 ViewPager 和 FragmentPagerAdapter 一起使用时才会触发。我们可以通过 getUserVisibleHint 来得到这个状态。isVisibleToUser 的值表示 Fragment 对用户是否可见，默认为 false</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="cm">/**
</span><span class="cm">     * @return The current value of the user-visible hint on this fragment.
</span><span class="cm">     * @see #setUserVisibleHint(boolean)
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="nf">boolean</span> <span class="n">getUserVisibleHint</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">mUserVisibleHint</span><span class="p">;</span>
    <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="onhiddenchanged">onHiddenChanged</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/**
</span><span class="cm">     * Called when the hidden state (as returned by {@link #isHidden()} of
</span><span class="cm">     * the fragment has changed.  Fragments start out not hidden; this will
</span><span class="cm">     * be called whenever the fragment changes state from that.
</span><span class="cm">     * @param hidden True if the fragment is now hidden, false otherwise.
</span><span class="cm">     *
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="nf">void</span> <span class="n">onHiddenChanged</span><span class="p">(</span><span class="kt">boolean</span> <span class="nf">hidden</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>在我们使用show（fragment）和 hide（fragment）改变了 fragment 的显示状态时，会触发此函数，并且可以通过 isHidden() 来获取当前显示隐藏的状态，默认为 false</p>

<p>加入了这两个方法以后，再看一下 ViewPager + Fragment 生命周期是如何变化的，假设当前的界面是这样的：</p>

<p><img src="https://raw.githubusercontent.com/checkFang/img/master/20210406162753.png" alt="" /></p>

<blockquote>
<p>首次启动 App， 该 Fragment1 和 Fragment2 的生命周期</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></pre></td>
<td class="lntd">
<pre class="chroma">1 fragment setUserVisibleHint: false
2 fragment setUserVisibleHint: false
1 fragment setUserVisibleHint: true
1 fragment onAttach: 
1 fragment onCreate: 
2 fragment onAttach: 
2 fragment onCreate: 
1 fragment onCreateView: 
1 fragment onResume: 
2 fragment onCreateView: 
2 fragment onResume: </pre></td></tr></table>
</div>
</div>
<blockquote>
<p>点击 Fragment 2 的生命周期</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></pre></td>
<td class="lntd">
<pre class="chroma">3 fragment setUserVisibleHint: false
1 fragment setUserVisibleHint: false
2 fragment setUserVisibleHint: true
3 fragment onAttach: 
3 fragment onCreate: 
3 fragment onCreateView: 
3 fragment onResume: </pre></td></tr></table>
</div>
</div>
<blockquote>
<p>点击 Fragment 3 的生命周期</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></pre></td>
<td class="lntd">
<pre class="chroma">4 fragment setUserVisibleHint: false
2 fragment setUserVisibleHint: false
3 fragment setUserVisibleHint: true
4 fragment onAttach: 
4 fragment onCreate: 
1 fragment onPause: 
4 fragment onCreateView: 
4 fragment onResume: </pre></td></tr></table>
</div>
</div>
<blockquote>
<p>点击 Fragment5 的生命周期</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></pre></td>
<td class="lntd">
<pre class="chroma">5 fragment setUserVisibleHint: false
3 fragment setUserVisibleHint: false
5 fragment setUserVisibleHint: true
5 fragment onAttach: 
5 fragment onCreate: 
5 fragment onCreateView: 
5 fragment onResume: 
3 fragment onPause: 
2 fragment onPause: </pre></td></tr></table>
</div>
</div>
<blockquote>
<p>回到 Fragment2 的生命周期</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></pre></td>
<td class="lntd">
<pre class="chroma">2 fragment setUserVisibleHint: false
1 fragment setUserVisibleHint: false
3 fragment setUserVisibleHint: false
5 fragment setUserVisibleHint: false
2 fragment setUserVisibleHint: true
2 fragment onCreateView: 
2 fragment onResume: 
1 fragment onCreateView: 
3 fragment onCreateView: 
1 fragment onResume: 
3 fragment onResume: 
4 fragment onPause: 
5 fragment onPause: </pre></td></tr></table>
</div>
</div>
<blockquote>
<p>首次进入 Fragment1，然后直接点击跳转到 Fragment5 的变化</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></pre></td>
<td class="lntd">
<pre class="chroma">// 首次进入 App
1 fragment setUserVisibleHint: false
2 fragment setUserVisibleHint: false
1 fragment setUserVisibleHint: true
1 fragment onAttach: 
1 fragment onCreate: 
2 fragment onAttach: 
2 fragment onCreate: 
1 fragment onCreateView: 
1 fragment onResume: 
2 fragment onCreateView: 
2 fragment onResume: 
// 跳转到 Fragment5 
5 fragment setUserVisibleHint: false
4 fragment setUserVisibleHint: false
1 fragment setUserVisibleHint: false
5 fragment setUserVisibleHint: true
5 fragment onAttach: 
5 fragment onCreate: 
4 fragment onAttach: 
4 fragment onCreate: 
5 fragment onCreateView: 
5 fragment onResume: 
4 fragment onCreateView: 
4 fragment onResume: 
2 fragment onPause: 
1 fragment onPause: </pre></td></tr></table>
</div>
</div>
<p>通过观察这几个 Fragment 的变化，可以发现都会伴随着 setUserVisibleHint 的一个方法的调用，最终发现一些规律：</p>

<ul>
<li>setUserVisibleHint 会优先于 Fragment 的生命周期的调用</li>
<li>相邻的 Fragment 会调用 setUserVisibleHint 并且 isVisibleToUser 的值为 false，当前可见的 Fragment isVisibleToUser 会为 true</li>
<li>如果当前的 Fragment 未被（缓存/创建），并且相邻的 Fragment 都未被（缓存/创建），都会调用 setUserVisibleHint 方法，当前的 Fragment 的 isVisibleToUser 会为 true，并且相邻之间的 Fragment 都会调用生命周期方法</li>
</ul>

<p>所以如果设计 Fragment 的懒加载，需要 setUserVisibleHint 方法的配合来使用，最终的方案如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">abstract</span> <span class="kd">class</span> <span class="nf">LazyFragment</span> <span class="kd">extends</span> <span class="nf">Fragment</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="nf">static</span> <span class="kd">final</span> <span class="nf">String</span> <span class="n">TAG</span> <span class="o">=</span> <span class="s">&#34;LazyFragment&#34;</span><span class="p">;</span>

    <span class="kd">protected</span> <span class="nf">View</span> <span class="n">rootView</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="c1">// view 是否已经创建
</span><span class="c1"></span>    <span class="kt">boolean</span> <span class="nf">isViewCreated</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="c1">// 是否第一次创建的标志位
</span><span class="c1"></span>    <span class="kt">boolean</span> <span class="nf">mIsFirstVisible</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

    <span class="c1">// 记录当前的 Fragment 可见状态
</span><span class="c1"></span>    <span class="kt">boolean</span> <span class="nf">currentVisibleState</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

    <span class="nd">@Nullable</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nf">View</span> <span class="n">onCreateView</span><span class="p">(</span><span class="nd">@NonNull</span> <span class="n">LayoutInflater</span> <span class="nf">inflater</span><span class="p">,</span> <span class="nd">@Nullable</span> <span class="n">ViewGroup</span> <span class="nf">container</span><span class="p">,</span> <span class="nd">@Nullable</span> <span class="n">Bundle</span> <span class="nf">savedInstanceState</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">super</span><span class="p">.</span><span class="na">onCreateView</span><span class="p">(</span><span class="n">inflater</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">savedInstanceState</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rootView</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">rootView</span> <span class="o">=</span> <span class="n">inflater</span><span class="p">.</span><span class="na">inflate</span><span class="p">(</span><span class="n">getLayoutRes</span><span class="p">(),</span> <span class="n">container</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
        <span class="p">}</span>
        
        <span class="n">initView</span><span class="p">(</span><span class="n">rootView</span><span class="p">);</span>
        <span class="n">isViewCreated</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      
      	<span class="c1">// isHidden() 表示当前的 Fragment 是否隐藏默认为 false
</span><span class="c1"></span>        <span class="c1">// getUserVisibleHint 获取 Fragment 是否显示，当前首次为 true
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isHidden</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">getUserVisibleHint</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">dispatchUserVisibleHint</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">rootView</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">protected</span> <span class="nf">abstract</span> <span class="kt">int</span> <span class="nf">getLayoutRes</span><span class="p">();</span>

    <span class="kd">protected</span> <span class="nf">abstract</span> <span class="kt">void</span> <span class="nf">initView</span><span class="p">(</span><span class="n">View</span> <span class="nf">view</span><span class="p">);</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nf">void</span> <span class="n">setUserVisibleHint</span><span class="p">(</span><span class="kt">boolean</span> <span class="nf">isVisibleToUser</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">super</span><span class="p">.</span><span class="na">setUserVisibleHint</span><span class="p">(</span><span class="n">isVisibleToUser</span><span class="p">);</span>
        <span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s">&#34;setUserVisibleHint: &#34;</span><span class="p">);</span>
        <span class="c1">// 1.由于 setUserVisibleHint 会优先于生命周期方法的调用，所以需要判断 View 是否创建过
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">isViewCreated</span><span class="p">)</span> <span class="p">{</span>
          	<span class="c1">// 2.该处是判断 Fragment 的可见状态到不可见状态，或者是不可见状态到可见状态
</span><span class="c1"></span>          
            <span class="k">if</span> <span class="p">(</span><span class="n">isVisibleToUser</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">currentVisibleState</span> <span class="p">)</span> <span class="p">{</span>
                <span class="c1">// 2.1 不可见状态 -&gt; 可见状态
</span><span class="c1"></span>                <span class="n">dispatchUserVisibleHint</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isVisibleToUser</span> <span class="o">&amp;&amp;</span> <span class="n">currentVisibleState</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// 2.2 可见状态 -&gt; 不可见状态
</span><span class="c1"></span>                <span class="n">dispatchUserVisibleHint</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/**
</span><span class="cm">     * 统一处理用户可见信息分发
</span><span class="cm">     * 分第一次可见、可见、不可见分发
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="nf">void</span> <span class="n">dispatchUserVisibleHint</span><span class="p">(</span><span class="kt">boolean</span> <span class="nf">isVisible</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">currentVisibleState</span> <span class="o">==</span> <span class="n">isVisible</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
        <span class="n">currentVisibleState</span> <span class="o">=</span> <span class="n">isVisible</span><span class="p">;</span>
      
        <span class="k">if</span> <span class="p">(</span><span class="n">isVisible</span><span class="p">)</span> <span class="p">{</span>
          	<span class="c1">// 第一次可见
</span><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">mIsFirstVisible</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">mIsFirstVisible</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                <span class="n">onFragmentFirstVisible</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="n">onVisible</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">onInVisible</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/**
</span><span class="cm">     * 用 FragmentTransaction 来控制 Fragment 的 hide 和 show 时，
</span><span class="cm">     * 那么这个方法就会被调用。每当你对某个 Fragment 使用 hide
</span><span class="cm">     * 或者是 show 的时候，那么这个 Fragment 就会自动调用这个方法。
</span><span class="cm">     * https://blog.csdn.net/u013278099/article/details/72869175
</span><span class="cm">     *
</span><span class="cm">     * 你会发现使用 hide 和 show 这时 Fragment 的生命周期不再执行，
</span><span class="cm">     * 不走任何的生命周期，
</span><span class="cm">     * 这样在有的情况下，数据将无法通过生命周期方法进行刷新，
</span><span class="cm">     * 所以你可以使用 onHiddenChanged 方法来解决这问题。
</span><span class="cm">     * @param hidden
</span><span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nf">void</span> <span class="n">onHiddenChanged</span><span class="p">(</span><span class="kt">boolean</span> <span class="nf">hidden</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">super</span><span class="p">.</span><span class="na">onHiddenChanged</span><span class="p">(</span><span class="n">hidden</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">hidden</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">dispatchUserVisibleHint</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">dispatchUserVisibleHint</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">protected</span> <span class="nf">abstract</span> <span class="kt">void</span> <span class="nf">onFragmentFirstVisible</span><span class="p">();</span>

    <span class="kd">protected</span> <span class="nf">void</span> <span class="n">onVisible</span><span class="p">()</span> <span class="p">{</span>
    <span class="p">}</span>

    <span class="kd">protected</span> <span class="nf">void</span> <span class="n">onInVisible</span><span class="p">()</span> <span class="p">{</span>
    <span class="p">}</span>



    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nf">void</span> <span class="n">onResume</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">super</span><span class="p">.</span><span class="na">onResume</span><span class="p">();</span>
      	<span class="c1">// onResume 并不代表 fragment 可见
</span><span class="c1"></span>
        <span class="c1">// 起过滤作用，处理回退到 Activity 的时候，如果从未加载过 Fragment，就不调用 dispatchUserVisibleHint(true)
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mIsFirstVisible</span><span class="p">)</span> <span class="p">{</span>
          	<span class="c1">// isHidden() 兼容 hide 和 show 的方法
</span><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isHidden</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">currentVisibleState</span> <span class="o">&amp;&amp;</span> <span class="n">getUserVisibleHint</span><span class="p">())</span> <span class="p">{</span>
              	<span class="c1">// 由于会存在当前的 Activity1 缓存了多个 Fragment，此时跳转到 Activity2，那么 Activity1 中的Fragment 都被缓存起来了
</span><span class="c1"></span>                <span class="c1">// 所以当从其他 Activity2 中回来 Activity1 的时候，只有当前的 Fragment 才去加载，其余相邻缓存的 Fragment 不做处理 （处理回退的情况）
</span><span class="c1"></span>                <span class="n">dispatchUserVisibleHint</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/**
</span><span class="cm">     * 只有当当前页面由可见状态转变到不可见状态时才需要调用 dispatchUserVisibleHint
</span><span class="cm">     * currentVisibleState &amp;&amp; getUserVisibleHint() 能够限定是当前可见的 Fragment
</span><span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nf">void</span> <span class="n">onPause</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">super</span><span class="p">.</span><span class="na">onPause</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">currentVisibleState</span> <span class="o">&amp;&amp;</span> <span class="n">getUserVisibleHint</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">dispatchUserVisibleHint</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>


    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nf">void</span> <span class="n">onDestroyView</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">super</span><span class="p">.</span><span class="na">onDestroyView</span><span class="p">();</span>
        <span class="n">isViewCreated</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="n">mIsFirstVisible</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>好了，代码就如上所示了，源码注释都有相关的注释说明，如果需要懒加载只需要继承 LazyFragment ，然后再 onVisible 界面可见的时候加载需要的数据，界面不可见的时候停止相关操作</p>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">midFang</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
      2021-04-03
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://midFang.github.io/tags/android/">Android</a>
          <a href="https://midFang.github.io/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a>
          <a href="https://midFang.github.io/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">性能优化</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/gradle-task-plugin/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">Gradle 自定义 plugin 以及项目优化实践</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/android-process-ipc/">
            <span class="next-text nav-default">独立进程通信之悬浮下拉状态栏实践</span>
            <span class="prev-text nav-mobile">Next</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "midFang/blog-comments"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="https://github.com/midFang" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="https://stackoverflow.com/users/14331888/midfang" rel="me noopener" class="iconfont"
      title="stack-overflow"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M809.714286 932.571429l-638.857143 0 0-274.285714-91.428571 0 0 365.714286 821.714286 0 0-365.714286-91.428571 0 0 274.285714zm-538.285714-299.428571l18.857143-89.714286 447.428571 94.285714-18.857143 89.142857zm58.857143-213.714286l38.285714-83.428571 414.285714 193.714286-38.285714 82.857143zm114.857143-203.428571l58.285714-70.285714 350.857143 293.142857-58.285714 70.285714zm226.857143-216l272.571429 366.285714-73.142857 54.857143-272.571429-366.285714zm-410.285714 840.571429l0-90.857143 457.142857 0 0 90.857143-457.142857 0z"></path>
</svg>

    </a>
  
    <a href="https://www.douban.com/people/194654920/" rel="me noopener" class="iconfont"
      title="douban"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M926.917973 37.80608C959.65184 37.80608 986.19392 64.34816 986.19392 97.082027L986.19392 926.917973C986.19392 959.65184 959.65184 986.19392 926.917973 986.19392L97.082027 986.19392C64.34816 986.19392 37.80608 959.65184 37.80608 926.917973L37.80608 97.082027C37.80608 64.34816 64.34816 37.80608 97.082027 37.80608zM176.653653 176.19968 176.653653 252.678827 825.658027 252.678827 825.658027 176.19968zM217.719467 316.146347 217.719467 628.08064 273.524053 628.08064 341.292373 770.39616 157.259093 770.39616 157.259093 845.417813 842.949973 845.417813 842.949973 770.39616 654.226773 770.39616 722.899627 628.08064 783.67744 628.08064 783.67744 316.146347zM684.885333 392.891733 684.885333 553.987413 312.576 553.987413 312.576 392.891733zM570.770773 770.39616 426.653013 770.39616 359.621973 628.08064 639.443627 628.08064z"></path>
</svg>

    </a>


<a href="https://midFang.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2020 -
    2021
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        midFang
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  




  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script type="text/javascript">
    AV.initialize( null ,  null );
  </script>

  <script>
    function showHitCount(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push($(this).attr("id").trim());
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var hits = item.get('hits');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(hits);
          }
          for (var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if (countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function (results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("hits");
            counter.save(null, {
              success: function (counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('hits'));
              },
              error: function (counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
             
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
             
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("hits", 1);
            newcounter.save(null, {
              success: function (newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('hits'));
              },
              error: function (newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function (error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function () {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        
        addCount(Counter);
      } else if ($('.post-link').length > 1) {
        
        showHitCount(Counter);
      }
    });
  </script>





  <script>
    $("#openSearch, #openSearchMobile").click(function(){
      $(".modal-dialog").addClass("visible");
    });

    $("#closeSearch").click(function(){
      $(".modal-dialog").removeClass("visible");
    });

    $(document).click(function(event) {
    
      if (!$(event.target).closest(".modal-content, #openSearch, #openSearchMobile").length) {
        $("body").find(".modal-dialog").removeClass("visible");
      }
    });
  </script>





</body>
</html>
