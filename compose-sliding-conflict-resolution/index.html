<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Compose 滑动冲突解决 - midFang&#39;s Blog</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="midFang" />
  <meta name="description" content="在 Compose 中， 处理滑动冲突的 Api 是 Modifier.nestedScroll() 下面就让我们来看看 Compose 中是如何处理的 一般来说，滑动冲突本质是，滑动冲突是因为内外层组件在同一方向上都滑动，而系统并" />

  <meta name="keywords" content="Hugo, theme, jane" />






<meta name="generator" content="Hugo 0.58.3" />


<link rel="canonical" href="https://midFang.github.io/compose-sliding-conflict-resolution/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.af20b78e95c84de86b00a0242a4a77bd2601700e1b250edf27537d957ac0041d.css" integrity="sha256-ryC3jpXITehrAKAkKkp3vSYBcA4bJQ7fJ1N9lXrABB0=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="Compose 滑动冲突解决" />
<meta property="og:description" content="在 Compose 中， 处理滑动冲突的 Api 是 Modifier.nestedScroll() 下面就让我们来看看 Compose 中是如何处理的 一般来说，滑动冲突本质是，滑动冲突是因为内外层组件在同一方向上都滑动，而系统并" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://midFang.github.io/compose-sliding-conflict-resolution/" />
<meta property="article:published_time" content="2023-10-13T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-10-13T00:00:00+00:00" />
<meta itemprop="name" content="Compose 滑动冲突解决">
<meta itemprop="description" content="在 Compose 中， 处理滑动冲突的 Api 是 Modifier.nestedScroll() 下面就让我们来看看 Compose 中是如何处理的 一般来说，滑动冲突本质是，滑动冲突是因为内外层组件在同一方向上都滑动，而系统并">


<meta itemprop="datePublished" content="2023-10-13T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2023-10-13T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="3967">



<meta itemprop="keywords" content="Android,Compose," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Compose 滑动冲突解决"/>
<meta name="twitter:description" content="在 Compose 中， 处理滑动冲突的 Api 是 Modifier.nestedScroll() 下面就让我们来看看 Compose 中是如何处理的 一般来说，滑动冲突本质是，滑动冲突是因为内外层组件在同一方向上都滑动，而系统并"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">midFang's Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/">首页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/post/">全部文章</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/categories/">分类</a>
          
        
      </li>
    

    
      <li class="mobile-menu-item">
        <a id="openSearchMobile" class="mobile-menu-item-link menu-item-search" href="#">
          <i class="iconfont">
            <svg version="1.1" viewBox="0 0 1024 1024"
  xmlns="http://www.w3.org/2000/svg" width="18" height="18"
  xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M973.81454219 973.81454219a91.78207815 91.78207815 0 0 1-129.80999631 0l-161.97482118-161.97482118a425.48527711 425.48527711 0 0 1-230.35931791 68.16531768 428.3346319 428.3346319 0 1 1 428.3346319-428.3346319 425.48527711 425.48527711 0 0 1-68.16531768 230.35931791l162.02961656 161.97482118a91.83687354 91.83687354 0 0 1-0.05479538 129.80999631zM451.67040679 145.69361559a305.97679241 305.97679241 0 1 0 0 611.95358361 305.97679241 305.97679241 0 0 0 0-611.95358361z">
  </path>
</svg>

          </i>
        </a>
      </li>
    
  </ul>
</nav>


  

  
    
<div class="modal-dialog">
    
    <div class="modal-content">
      <div id="closeSearch" title="Close" class="close">X</div>
      <div class="modal-header">
        <div class="modal-title">Search</div>
      </div>
      <div class="modal-body">
          <script>
            (function() {
              var cx = '57787f7f4d21d54fc';
              var gcse = document.createElement('script');
              gcse.type = 'text/javascript';
              gcse.async = true;
              gcse.src = (document.location.protocol == 'https:' ? 'https:' :
                  'http:') +
                '//cse.google.com/cse.js?cx=' + cx;
              var s = document.getElementsByTagName('script')[0];
              s.parentNode.insertBefore(gcse, s);
            })();
          </script>
          <gcse:search></gcse:search>
      </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      midFang's Blog
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/">首页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/post/">全部文章</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/categories/">分类</a>
          

        

      </li>
    

    
    

    
      <li class="menu-item">
        <a id="openSearch" class="menu-item-link menu-item-search" href="#">
          <i class="iconfont">
            <svg version="1.1" viewBox="0 0 1024 1024"
  xmlns="http://www.w3.org/2000/svg" width="18" height="18"
  xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M973.81454219 973.81454219a91.78207815 91.78207815 0 0 1-129.80999631 0l-161.97482118-161.97482118a425.48527711 425.48527711 0 0 1-230.35931791 68.16531768 428.3346319 428.3346319 0 1 1 428.3346319-428.3346319 425.48527711 425.48527711 0 0 1-68.16531768 230.35931791l162.02961656 161.97482118a91.83687354 91.83687354 0 0 1-0.05479538 129.80999631zM451.67040679 145.69361559a305.97679241 305.97679241 0 1 0 0 611.95358361 305.97679241 305.97679241 0 0 0 0-611.95358361z">
  </path>
</svg>

          </i>
        </a>
      </li>
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">Compose 滑动冲突解决</h1>
      
      <div class="post-meta">
        <time datetime="2023-10-13" class="post-time">
          2023-10-13
        </time>
        <div class="post-category">
            <a href="https://midFang.github.io/categories/compose/"> Compose </a>
            
          </div>
        

        
        
          <span id="busuanzi_container_page_pv">
            | 阅读 <span id="busuanzi_value_page_pv"></span>
          </span>
        

        
        
          <span id="/compose-sliding-conflict-resolution/" class="leancloud_visitors" data-flag-title="Compose 滑动冲突解决">
            <span class="post-meta-item-text"> | 阅读 </span>
            <span class="leancloud-visitors-count"></span>
          </span>
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#nestedscroll">nestedScroll</a></li>
<li><a href="#nestedscrollconnection">NestedScrollConnection</a></li>
<li><a href="#nestedscrolldispatcher">NestedScrollDispatcher</a></li>
<li><a href="#总结">总结</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      

<p>在 <code>Compose</code> 中， 处理滑动冲突的 <code>Api</code> 是 <code>Modifier.nestedScroll()</code> 下面就让我们来看看 <code>Compose</code> 中是如何处理的</p>

<p>一般来说，滑动冲突本质是，滑动冲突是因为内外层组件在同一方向上都滑动，而系统并不能确定应该响应哪个组件的滑动事件，一般滑动冲突的场景有这几种</p>

<p><img src="https://raw.githubusercontent.com/midFang/imgSource/main/20201204000730.png" alt="" /></p>

<p>首先来看一个正常的例子，列表嵌套列表的情况</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="n">@Preview</span>
<span class="n">@Composable</span>
<span class="k">fun</span> <span class="nf">Sample1</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">LazyColumn</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">height</span><span class="p">(</span><span class="m">200.</span><span class="n">dp</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">items</span><span class="p">(</span><span class="m">20</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Text</span><span class="p">(</span><span class="n">text</span> <span class="p">=</span> <span class="s">&#34;列表项 $it&#34;</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">item</span> <span class="p">{</span>
            <span class="n">LazyColumn</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">height</span><span class="p">(</span><span class="m">100.</span><span class="n">dp</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">items</span><span class="p">(</span><span class="m">10</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">Text</span><span class="p">(</span><span class="n">text</span> <span class="p">=</span> <span class="s">&#34;内部列表项 $it&#34;</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p><img src="https://raw.githubusercontent.com/midFang/imgSource/main/PixPin_2024-03-09_16-51-42.gif" alt="" /></p>

<p>在这个列表中，可以发现，内部列表滑动到最顶部了，在往下拖拽，会拉着外层列表滑动，或者是滑动到最底部了，再往下拖拽同样也会拉着外层列表滑动，所以这个场景中，是没有滑动冲突的
而之所以这个场景没有滑动冲突的，是因为这里的内外层组件使用的都是官方的 <code>LazyColumn</code> 它的内部是对滑动冲突进行了处理的，包括 <code>lazyRow</code> 等等，接下来，我们将外层的 <code>LazyColumn</code> 替换成 <code>Column</code> 来看看</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="n">@Preview</span>
<span class="n">@Composable</span>
<span class="k">fun</span> <span class="nf">NestedScrollSample</span><span class="p">()</span> <span class="p">{</span>
    <span class="p">/**</span>
   <span class="p">*</span>  <span class="err">默认</span> <span class="n">Compose</span> <span class="err">的</span> <span class="n">lazyRow</span> <span class="err">和</span> <span class="n">lazyColum</span> <span class="err">是提供了嵌套滑动处理的</span>
   <span class="p">/</span>

    <span class="k">var</span> <span class="py">offsetY</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="m">0f</span><span class="p">)</span> <span class="p">}</span>
    
    <span class="n">Column</span><span class="p">(</span>
        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
            <span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">()</span>
            <span class="p">.</span><span class="n">offset</span> <span class="p">{</span> <span class="n">IntOffset</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">offsetY</span><span class="p">.</span><span class="n">roundToInt</span><span class="p">())</span> <span class="p">}</span>
            <span class="p">.</span><span class="n">draggable</span><span class="p">(</span><span class="n">rememberDraggableState</span><span class="p">(</span><span class="n">onDelta</span> <span class="p">=</span> <span class="p">{</span> <span class="n">delta</span> <span class="p">-&gt;</span>
                <span class="n">offsetY</span> <span class="p">+=</span> <span class="n">delta</span> <span class="c1">// 拖拽滑动
</span><span class="c1"></span>            <span class="p">}),</span> <span class="n">orientation</span> <span class="p">=</span> <span class="n">Orientation</span><span class="p">.</span><span class="n">Vertical</span><span class="p">)</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="p">(</span><span class="m">1.</span><span class="p">.</span><span class="m">10</span><span class="p">).</span><span class="n">forEach</span> <span class="p">{</span>
            <span class="n">Text</span><span class="p">(</span><span class="n">text</span> <span class="p">=</span> <span class="s">&#34;第 $it 个&#34;</span><span class="p">)</span>
        <span class="p">}</span>


        <span class="c1">// 处理嵌套滑动
</span><span class="c1"></span>        <span class="n">LazyColumn</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">height</span><span class="p">(</span><span class="m">60.</span><span class="n">dp</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">items</span><span class="p">(</span><span class="m">10</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">Text</span><span class="p">(</span><span class="n">text</span> <span class="p">=</span> <span class="s">&#34;第 $it 个项目&#34;</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>这里的代码和上个例子基本类似，就是将 <code>LazyColumn</code> 换成 <code>Column</code> 了，然后自己定义了 <code>offsetY</code> 变量，这个变量用来做这个组件滑动的偏移，运行后是这样的</p>

<p><img src="https://raw.githubusercontent.com/midFang/imgSource/main/PixPin_2024-03-09_17-04-04.gif" alt="" /></p>

<p>由于 <code>Column</code> 没有处理滑动冲突，所以不管内层列表滑到最顶部还是最底部，外层都无法拖动，接下来看看如何滑动冲突的，首先我们有几个前置知识必须了解</p>

<ul>
<li>在 <code>Compose</code> 中处理事件和 <code>Android</code> 原生中有所不同，在 Android 原生中，所有的事件是从父组件开始响应的，由父组件来决定要不要拦截事件，是否分发事件给子组件</li>
<li>而在 <code>Compose</code> 中，事件首先由最深层的子组件接收（子组件会最先接受到事件），子组件开始响应的时候，先询问父组件是否需要先消费事件，然后父组件再根据需要去消费事件，然后消费事件后，再回到子组件自身进行消费，子组件消费完成后，如果自己还有没有消费完的，会再次询问父组件是否需要消费事件</li>
</ul>

<p>所以它们充当着一种“发送者”和“接收者”的角色的一种模式， <code>NestedScrollDispatcher</code> 用于分发事件，而 <code>NestedScrollConnection</code> 用于接收和处理这些事件</p>

<h2 id="nestedscroll">nestedScroll</h2>

<p><code>Modifier.nestedScroll()</code> 一共有两个参数可设置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="k">fun</span> <span class="nf">Modifier</span><span class="p">.</span><span class="n">nestedScroll</span><span class="p">(</span>
    <span class="n">connection</span><span class="p">:</span> <span class="n">NestedScrollConnection</span><span class="p">,</span>
    <span class="n">dispatcher</span><span class="p">:</span> <span class="n">NestedScrollDispatcher</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
<span class="p">):</span> <span class="n">Modifier</span> <span class="p">=</span> <span class="k">this</span> <span class="n">then</span> <span class="n">NestedScrollElement</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">dispatcher</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>NestedScrollConnection： 用于父组件处理来自子组件的滚动事件的机制。（通过实现 NestedScrollConnection 中的方法，会收到子组件发送过来的事件回调，父组件可以在滚动事件发生前后做出响应，比如调整自己的状态或者处理滚动偏移 ）</p>

<p>NestedScrollDispatcher： 用于子组件向父组件分发滚动事件的场景。（当子组件在用户滑动时需要通知父组件，可以通过 NestedScrollDispatcher 来实现这种通信。这意味着，如果你的组件需要向上游组件报告滚动事件，你可以使用 dispatcher 参数。这个参数是可空的）</p>

<p>所以它们充当着一种“发送者”和“接收者”的角色的一种模式， <code>NestedScrollDispatcher</code> 用于分发事件，而 <code>NestedScrollConnection</code> 用于接收和处理这些事件</p>

<h2 id="nestedscrollconnection">NestedScrollConnection</h2>

<p>NestedScrollConnection 内部的方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="k">interface</span> <span class="nc">NestedScrollConnection</span> <span class="p">{</span>
    <span class="cm">/**
</span><span class="cm">    *  子组件在事件响应之前触发的回调（也就是子组件在响应事件之前，会先询问父组件是否需要消费事件）
</span><span class="cm">    *  @param available 当前可用的滑动事件偏移量
</span><span class="cm">       @param source 滑动事件的类型
</span><span class="cm">     *
</span><span class="cm">     *  @return 当前组件消费的滑动事件偏移量，如果不想消费可返回Offset.Zero
</span><span class="cm">     */</span>
   <span class="k">fun</span> <span class="nf">onPreScroll</span><span class="p">(</span><span class="n">available</span><span class="p">:</span> <span class="n">Offset</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="n">NestedScrollSource</span><span class="p">):</span> <span class="n">Offset</span> <span class="p">=</span> <span class="n">Offset</span><span class="p">.</span><span class="n">Zero</span>

    <span class="cm">/**
</span><span class="cm">     * 子组件处理后的滑动事件回调（也就是子组件在消费自己的事件后，会再次询问父组件是否需要消费事件)
</span><span class="cm">     * @param consumed 之前消费的所有滑动事件偏移量
</span><span class="cm">     * @param available 当前剩下还可用的滑动事件偏移量
</span><span class="cm">     * @param source 滑动事件的类型
</span><span class="cm">     * @return 当前组件消费的滑动事件偏移量，如果不想消费可返回 Offset.Zero ，则剩下偏移量会继续交由当前布局的父布局进行处理
</span><span class="cm">     */</span>
    <span class="k">fun</span> <span class="nf">onPostScroll</span><span class="p">(</span>
        <span class="n">consumed</span><span class="p">:</span> <span class="n">Offset</span><span class="p">,</span>
        <span class="n">available</span><span class="p">:</span> <span class="n">Offset</span><span class="p">,</span>
        <span class="n">source</span><span class="p">:</span> <span class="n">NestedScrollSource</span>
    <span class="p">):</span> <span class="n">Offset</span> <span class="p">=</span> <span class="n">Offset</span><span class="p">.</span><span class="n">Zero</span>
    
    <span class="cm">/**
</span><span class="cm">     * 触发快速滑动操作之前调用 
</span><span class="cm">     * @param available 开始时的速度
</span><span class="cm">     * @return 当前组件消费的速度，如果不想消费可返回 Velocity.Zero
</span><span class="cm">     */</span>
    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">onPreFling</span><span class="p">(</span><span class="n">available</span><span class="p">:</span> <span class="n">Velocity</span><span class="p">):</span> <span class="n">Velocity</span> <span class="p">=</span> <span class="n">Velocity</span><span class="p">.</span><span class="n">Zero</span>
    
    <span class="cm">/**
</span><span class="cm">     * 快速滑动操作结束后调用
</span><span class="cm">     * @param consumed 之前消费的所有速度
</span><span class="cm">     * @param available 当前剩下还可用的速度
</span><span class="cm">     * @return 当前组件消费的速度，如果不想消费可返回Velocity.Zero，剩下速度会继续交由当前布局的父布局进行处理。
</span><span class="cm">     */</span>
    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">onPostFling</span><span class="p">(</span><span class="n">consumed</span><span class="p">:</span> <span class="n">Velocity</span><span class="p">,</span> <span class="n">available</span><span class="p">:</span> <span class="n">Velocity</span><span class="p">):</span> <span class="n">Velocity</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">Velocity</span><span class="p">.</span><span class="n">Zero</span>
    <span class="p">}</span>

<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>有了这些前奏知识，也了解 nestedScroll 的相关属性和方法，接下来我们开始处理滑动冲突了</p>

<p>首先明白目标需求</p>

<ol>
<li>在内层 LazyColumn 滑动到最顶部的时候，如果往下拉，需要滑动外层 Column 往下滑动</li>
</ol>

<p>所以实现这个逻辑的步骤是</p>

<ol>
<li>创建一个 NestedScrollConnection 实例，用于监听来自子组件 LazyColumn 的滑动事件回调

<ul>
<li>实现 onPostScroll 方法（监听子组件滑动后状态-因为这里的场景是 LazyColumn 滑动到顶部或者底部，让外层拖动）</li>
</ul></li>
<li>在 NestedScrollConnection 中，根据 LazyColumn 的滑动位置决定是否消费滑动事件，如果 LazyColumn 已经滑动到最顶部或最底部，允许外层 Column 响应接下来的滑动事件，否则，LazyColumn 自身消费滑动事件</li>
<li>将 NestedScrollConnection 和外层 Column 的 Modifier 通过 nestedScroll 方法连接起来</li>
</ol>

<p>这里顺带提一下为什么是要实现 onPostScroll 方法 ？
因为 onPostScroll 方法是监听子组件滑动后响应的回调，也就是监听 LazyColumn 滑动后的状态，然后决定是否需要让外层 Column 接管滑动。这样，当LazyColumn 滑动到顶部或底部时，如果用户继续滑动，外层 Column 可以接管滑动事件，从而解决滑动冲突，修改后的代码如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="n">@Preview</span>
<span class="n">@Composable</span>
<span class="k">fun</span> <span class="nf">NestedScrollSample</span><span class="p">()</span> <span class="p">{</span>
    <span class="cm">/**
</span><span class="cm">     *  默认 Compose 的 lazyRow 和 lazyColum 是提供了嵌套滑动处理的
</span><span class="cm">     */</span>

    <span class="k">var</span> <span class="py">offsetY</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="m">0f</span><span class="p">)</span> <span class="p">}</span>
    
    <span class="k">val</span>  <span class="py">connection</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span>
        <span class="k">object</span> <span class="err">: </span><span class="nc">NestedScrollConnection</span> <span class="p">{</span>
    
            <span class="k">override</span> <span class="k">fun</span> <span class="nf">onPostScroll</span><span class="p">(</span><span class="n">consumed</span><span class="p">:</span> <span class="n">Offset</span><span class="p">,</span> <span class="n">available</span><span class="p">:</span> <span class="n">Offset</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="n">NestedScrollSource</span><span class="p">):</span> <span class="n">Offset</span> <span class="p">{</span>
                <span class="n">offsetY</span> <span class="p">+=</span> <span class="n">available</span><span class="p">.</span><span class="n">y</span>
                <span class="k">return</span> <span class="n">available</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="n">Column</span><span class="p">(</span>
        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
            <span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">()</span>
            <span class="p">.</span><span class="n">offset</span> <span class="p">{</span> <span class="n">IntOffset</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">offsetY</span><span class="p">.</span><span class="n">roundToInt</span><span class="p">())</span> <span class="p">}</span>
            <span class="p">.</span><span class="n">nestedScroll</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
            <span class="p">.</span><span class="n">draggable</span><span class="p">(</span><span class="n">rememberDraggableState</span><span class="p">(</span><span class="n">onDelta</span> <span class="p">=</span> <span class="p">{</span> <span class="n">delta</span> <span class="p">-&gt;</span>
                <span class="n">offsetY</span> <span class="p">+=</span> <span class="n">delta</span> <span class="c1">// 拖拽滑动
</span><span class="c1"></span>            <span class="p">}),</span> <span class="n">orientation</span> <span class="p">=</span> <span class="n">Orientation</span><span class="p">.</span><span class="n">Vertical</span><span class="p">)</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="p">(</span><span class="m">1.</span><span class="p">.</span><span class="m">10</span><span class="p">).</span><span class="n">forEach</span> <span class="p">{</span>
            <span class="n">Text</span><span class="p">(</span><span class="n">text</span> <span class="p">=</span> <span class="s">&#34;第 $it 个&#34;</span><span class="p">)</span>
        <span class="p">}</span>


        <span class="c1">// 处理嵌套滑动
</span><span class="c1"></span>        <span class="n">LazyColumn</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">height</span><span class="p">(</span><span class="m">60.</span><span class="n">dp</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">items</span><span class="p">(</span><span class="m">10</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">Text</span><span class="p">(</span><span class="n">text</span> <span class="p">=</span> <span class="s">&#34;第 $it 个项目&#34;</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p><img src="https://raw.githubusercontent.com/midFang/imgSource/main/PixPin_2024-03-09_17-04-04.gif" alt="" /></p>

<p>代码运行后，就是这个样子了，可以发现，LazyColumn  滑动顶部或者底部的时候，已经可以让外层的 Column 滑动了，已经解决滑动冲突了</p>

<p>接下来我们再看看另外一个例子，有点不一样的是，我们实现的是  onPreScroll 方法了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="n">@Preview</span>
<span class="n">@Composable</span>
<span class="k">fun</span> <span class="nf">NestedScrollSample3</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">val</span> <span class="py">toolbarHeight</span> <span class="p">=</span> <span class="m">68.</span><span class="n">dp</span>
    <span class="k">val</span> <span class="py">toolbarHeightPx</span> <span class="p">=</span> <span class="n">with</span><span class="p">(</span><span class="n">LocalDensity</span><span class="p">.</span><span class="n">current</span><span class="p">)</span> <span class="p">{</span> <span class="n">toolbarHeight</span><span class="p">.</span><span class="n">roundToPx</span><span class="p">().</span><span class="n">toFloat</span><span class="p">()</span> <span class="p">}</span>
    <span class="c1">// toolbar 的偏移量
</span><span class="c1"></span>    <span class="k">val</span> <span class="py">toolbarOffsetHeightPx</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="m">0f</span><span class="p">)</span> <span class="p">}</span>
    
    <span class="c1">// 监听子组件的滑动事件
</span><span class="c1"></span>    <span class="k">val</span> <span class="py">nestedScrollConnection</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span>
        <span class="k">object</span> <span class="err">: </span><span class="nc">NestedScrollConnection</span> <span class="p">{</span>
            <span class="c1">// 列表在滑动之前回调
</span><span class="c1"></span>            <span class="k">override</span> <span class="k">fun</span> <span class="nf">onPreScroll</span><span class="p">(</span><span class="n">available</span><span class="p">:</span> <span class="n">Offset</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="n">NestedScrollSource</span><span class="p">):</span> <span class="n">Offset</span> <span class="p">{</span>
                <span class="c1">// try to consume before LazyColumn to collapse toolbar if needed, hence pre-scroll
</span><span class="c1"></span>                <span class="k">val</span> <span class="py">delta</span> <span class="p">=</span> <span class="n">available</span><span class="p">.</span><span class="n">y</span>
                <span class="k">val</span> <span class="py">newOffset</span> <span class="p">=</span> <span class="n">toolbarOffsetHeightPx</span><span class="p">.</span><span class="n">value</span> <span class="p">+</span> <span class="n">delta</span>
                <span class="n">toolbarOffsetHeightPx</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">newOffset</span><span class="p">.</span><span class="n">coerceIn</span><span class="p">(-</span><span class="n">toolbarHeightPx</span><span class="p">,</span> <span class="m">0f</span><span class="p">)</span>
                <span class="c1">// here&#39;s the catch: let&#39;s pretend we consumed 0 in any case, since we want
</span><span class="c1"></span>                <span class="c1">// LazyColumn to scroll anyway for good UX
</span><span class="c1"></span>                <span class="c1">// We&#39;re basically watching scroll without taking it
</span><span class="c1"></span>                <span class="k">return</span> <span class="n">Offset</span><span class="p">.</span><span class="n">Zero</span> <span class="c1">// 这里返回的是父组件是否需要消费多少偏移量事件，这里我们默认返回 0，事件全给给子组件 LazyColumn，让它在任何情况下都能滚动
</span><span class="c1"></span>            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">Box</span><span class="p">(</span>
        <span class="n">Modifier</span>
            <span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
            <span class="c1">// 当前组件作为父组件接受子组件的回调
</span><span class="c1"></span>            <span class="p">.</span><span class="n">nestedScroll</span><span class="p">(</span><span class="n">nestedScrollConnection</span><span class="p">)</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 内部组件 LazyColumn 已经对滑动冲突做了处理，所以它会回调在 nestedScrollConnection 中
</span><span class="c1"></span>        <span class="n">LazyColumn</span><span class="p">(</span><span class="n">contentPadding</span> <span class="p">=</span> <span class="n">PaddingValues</span><span class="p">(</span><span class="n">top</span> <span class="p">=</span> <span class="n">toolbarHeight</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">items</span><span class="p">(</span><span class="m">100</span><span class="p">)</span> <span class="p">{</span> <span class="n">index</span> <span class="p">-&gt;</span>
                <span class="n">Text</span><span class="p">(</span>
                    <span class="s">&#34;I&#39;m item $index&#34;</span><span class="p">,</span> <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
                        <span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">()</span>
                        <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">TopAppBar</span><span class="p">(</span>
            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
                <span class="p">.</span><span class="n">height</span><span class="p">(</span><span class="n">toolbarHeight</span><span class="p">)</span>
                <span class="p">.</span><span class="n">offset</span> <span class="p">{</span> <span class="n">IntOffset</span><span class="p">(</span><span class="n">x</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span> <span class="n">y</span> <span class="p">=</span> <span class="n">toolbarOffsetHeightPx</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">roundToInt</span><span class="p">())</span> <span class="p">},</span>
            <span class="n">title</span> <span class="p">=</span> <span class="p">{</span> <span class="n">Text</span><span class="p">(</span><span class="s">&#34;toolbar offset is ${toolbarOffsetHeightPx.value}&#34;</span><span class="p">)</span> <span class="p">}</span>
        <span class="p">)</span>
    <span class="p">}</span>

<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>代码注释都写的非常清楚了，大体上就是使用 nestedScrollConnection 类来监听子组件的回调，然后将回调的结果处理 TopAppBar 的隐藏和显示，这个例子唯一区别不同的是使用的是 onPreScroll 方法，因为子组件列表在滑动之前就需要接受回调，并且处理 TopAppBar 的显示和隐藏，代码运行后效果如下</p>

<p><img src="https://raw.githubusercontent.com/midFang/imgSource/main/PixPin_2024-03-09_18-44-48.gif" alt="" /></p>

<p>所以一般情况下，NestedScrollConnection 是用来处理当前组件作为父组件接受子组件的回调，然后根据子组件滚动做出反应，例如，具有可滚动项的 LazyColumn 或 LazyRow 和可折叠标题的布局，或者上面的例子， 而 NestedScrollDispatcher 作为子组件，在事件响应前和响应后，通知给父组件的回调</p>

<h2 id="nestedscrolldispatcher">NestedScrollDispatcher</h2>

<p>上面说了这么多，那 NestedScrollDispatcher 又是怎么使用的呢 ？在这里我们回顾一下上面讲到的例子是都是使用的 NestedScrollConnection，而它的作用是作为父组件的时候，接受子组件的回调，这个接受子组件的组件回调，是因为我们目前子组件都是使用的 LazyColumn
而 LazyColumn 是内部使用 NestedScrollDispatcher 向我们发送了通知，所以 NestedScrollConnection 才能够接受的到，感兴趣的可以看下 LazyColumn 内部的源码，代码很多，这里不展示了，回到我们的第二个例子中，我们是没有处理 NestedScrollDispatcher 事件通知的，假设
我们将第二个例子外部再包裹一层可滑动的组件的话，那么仍然会有滑动冲突的问题，同时就算外部一样的逻辑编写 NestedScrollConnection 处理也是无效的，因为内部组件并没有分发事件，接下来，我们来处理一下这个场景</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="n">@Preview</span>
<span class="n">@Composable</span>
<span class="k">fun</span> <span class="nf">NestedScrollSample2</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">val</span> <span class="py">connection</span> <span class="p">=</span> <span class="err">和之前的一致</span>
    
    <span class="k">val</span> <span class="py">dispatcher</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">NestedScrollDispatcher</span><span class="p">()</span> <span class="p">}</span>
    
    <span class="n">Column</span><span class="p">(</span>
        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
            <span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">()</span>
            <span class="p">.</span><span class="n">offset</span> <span class="p">{</span> <span class="n">IntOffset</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">offsetY</span><span class="p">.</span><span class="n">roundToInt</span><span class="p">())</span> <span class="p">}</span>
            <span class="p">.</span><span class="n">nestedScroll</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">dispatcher</span><span class="p">)</span>
            <span class="p">.</span><span class="n">draggable</span><span class="p">(</span><span class="n">rememberDraggableState</span><span class="p">(</span><span class="n">onDelta</span> <span class="p">=</span> <span class="p">{</span> <span class="n">delta</span> <span class="p">-&gt;</span>
                <span class="c1">// 滑动前
</span><span class="c1"></span>    			<span class="k">val</span> <span class="py">parentsConsumed</span> <span class="p">=</span> <span class="n">dispatcher</span><span class="p">.</span><span class="n">dispatchPreScroll</span><span class="p">(</span><span class="n">Offset</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="n">delta</span><span class="p">),</span> <span class="n">NestedScrollSource</span><span class="p">.</span><span class="n">Drag</span><span class="p">)</span>
    			<span class="c1">// 自己需要消费的
</span><span class="c1"></span>    			<span class="k">var</span> <span class="py">weConsumed</span>  <span class="p">=</span> <span class="n">delta</span> <span class="p">-</span> <span class="n">parentsConsumed</span><span class="p">.</span><span class="n">y</span> 
    			<span class="n">offsetY</span> <span class="p">=</span> <span class="n">weConsumed</span>
    			<span class="c1">// 剩余可用的偏移量
</span><span class="c1"></span>    			<span class="k">val</span> <span class="py">adjustedAvailable</span> <span class="p">=</span> <span class="n">delta</span> <span class="p">-</span> <span class="n">parentsConsumed</span><span class="p">.</span><span class="n">y</span>
    			<span class="c1">// 一共消费了多少偏移量 （父组件偏移量 + 子组件的偏移量）
</span><span class="c1"></span>    			<span class="k">val</span> <span class="py">totalConsumed</span> <span class="p">=</span> <span class="n">Offset</span><span class="p">(</span><span class="n">x</span> <span class="p">=</span> <span class="m">0f</span><span class="p">,</span> <span class="n">y</span> <span class="p">=</span> <span class="n">weConsumed</span><span class="p">)</span> <span class="p">+</span> <span class="n">parentsConsumed</span>
    			<span class="c1">// 最后还剩下多少偏移量
</span><span class="c1"></span>    			<span class="k">val</span> <span class="py">left</span> <span class="p">=</span> <span class="n">adjustedAvailable</span> <span class="p">-</span> <span class="n">weConsumed</span>
    			<span class="c1">// 最后询问父组件还需要消费多少事件
</span><span class="c1"></span>    			<span class="n">dispatcher</span><span class="p">.</span><span class="n">dispatchPostScroll</span><span class="p">(</span><span class="n">totalConsumed</span><span class="p">,</span> <span class="n">Offset</span><span class="p">(</span><span class="n">x</span> <span class="p">=</span> <span class="m">0f</span><span class="p">,</span> <span class="n">y</span> <span class="p">=</span> <span class="n">left</span><span class="p">),,</span> <span class="n">NestedScrollSource</span><span class="p">.</span><span class="n">Drag</span><span class="p">)</span>
    
            <span class="p">}),</span> <span class="n">orientation</span> <span class="p">=</span> <span class="n">Orientation</span><span class="p">.</span><span class="n">Vertical</span><span class="p">)</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="p">(</span><span class="m">1.</span><span class="p">.</span><span class="m">10</span><span class="p">).</span><span class="n">forEach</span> <span class="p">{</span>
            <span class="n">Text</span><span class="p">(</span><span class="n">text</span> <span class="p">=</span> <span class="s">&#34;第 $it 个&#34;</span><span class="p">)</span>
        <span class="p">}</span>


        <span class="c1">// 处理嵌套滑动
</span><span class="c1"></span>        <span class="n">LazyColumn</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">height</span><span class="p">(</span><span class="m">60.</span><span class="n">dp</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">items</span><span class="p">(</span><span class="m">10</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">Text</span><span class="p">(</span><span class="n">text</span> <span class="p">=</span> <span class="s">&#34;第 $it 个项目&#34;</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>整体代码就是这样，增加的逻辑不多，需要关注的就是下面这个部分，在子组件事件响应的前后通知父组件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="c1">// 滑动前-通知父组件
</span><span class="c1"></span><span class="k">val</span> <span class="py">parentsConsumed</span> <span class="p">=</span> <span class="n">dispatcher</span><span class="p">.</span><span class="n">dispatchPreScroll</span><span class="p">(</span><span class="n">Offset</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="n">delta</span><span class="p">),</span> <span class="n">NestedScrollSource</span><span class="p">.</span><span class="n">Drag</span><span class="p">)</span>
<span class="c1">// 自己需要消费的偏移量
</span><span class="c1"></span><span class="k">var</span> <span class="py">weConsumed</span>  <span class="p">=</span> <span class="n">delta</span> <span class="p">-</span> <span class="n">parentsConsumed</span><span class="p">.</span><span class="n">y</span> 
<span class="n">offsetY</span> <span class="p">=</span> <span class="n">weConsumed</span>
<span class="c1">// 剩余可用的偏移量
</span><span class="c1"></span><span class="k">val</span> <span class="py">adjustedAvailable</span> <span class="p">=</span> <span class="n">delta</span> <span class="p">-</span> <span class="n">parentsConsumed</span><span class="p">.</span><span class="n">y</span>
<span class="c1">// 一共消费了多少偏移量 （父组件偏移量 + 子组件的偏移量）
</span><span class="c1"></span><span class="k">val</span> <span class="py">totalConsumed</span> <span class="p">=</span> <span class="n">Offset</span><span class="p">(</span><span class="n">x</span> <span class="p">=</span> <span class="m">0f</span><span class="p">,</span> <span class="n">y</span> <span class="p">=</span> <span class="n">weConsumed</span><span class="p">)</span> <span class="p">+</span> <span class="n">parentsConsumed</span>
<span class="c1">// 最后还剩下多少偏移量
</span><span class="c1"></span><span class="k">val</span> <span class="py">left</span> <span class="p">=</span> <span class="n">adjustedAvailable</span> <span class="p">-</span> <span class="n">weConsumed</span>
<span class="c1">// 最后通知父组件是否消费剩下的偏移量
</span><span class="c1"></span><span class="n">dispatcher</span><span class="p">.</span><span class="n">dispatchPostScroll</span><span class="p">(</span><span class="n">totalConsumed</span><span class="p">,</span> <span class="n">Offset</span><span class="p">(</span><span class="n">x</span> <span class="p">=</span> <span class="m">0f</span><span class="p">,</span> <span class="n">y</span> <span class="p">=</span> <span class="n">left</span><span class="p">),,</span> <span class="n">NestedScrollSource</span><span class="p">.</span><span class="n">Drag</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>到了这里，是不是就和我们上面讲到的逻辑是一样的，Compose 的事件分发的规则是：子组件开始响应的时候，先询问父组件是否需要先消费事件，然后父组件再根据需要去消费事件，然后消费事件后，再回到子组件自身进行消费，子组件消费完成后，如果自己还有没有消费完的，会再次询问父组件是否需要消费事件</p>

<h2 id="总结">总结</h2>

<p>所以，一个组件的滑动冲突处理，必须要包含两个处理，那就是 NestedScrollDispatcher 子组件通知父组件事件偏移量，和 NestedScrollConnection 接受来自子组件的事件回调</p>

<p>引用链接：<a href="https://stackoverflow.com/questions/68145818/jetpack-compose-nestedscrollconnection-vs-nestedscrolldispatcher">https://stackoverflow.com/questions/68145818/jetpack-compose-nestedscrollconnection-vs-nestedscrolldispatcher</a>
<a href="https://developer.android.com/reference/kotlin/androidx/compose/ui/input/nestedscroll/package-summary.html#(androidx.compose.ui.Modifier).nestedScroll(androidx.compose.ui.input.nestedscroll.NestedScrollConnection,androidx.compose.ui.input.nestedscroll.NestedScrollDispatcher">https://developer.android.com/reference/kotlin/androidx/compose/ui/input/nestedscroll/package-summary.html#(androidx.compose.ui.Modifier).nestedScroll(androidx.compose.ui.input.nestedscroll.NestedScrollConnection,androidx.compose.ui.input.nestedscroll.NestedScrollDispatcher</a>)</p>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">midFang</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
      2023-10-13
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://midFang.github.io/tags/android/">Android</a>
          <a href="https://midFang.github.io/tags/compose/">Compose</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/compose-canvas-analysis/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">Compose 绘制功能全解析</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/compose-custom-drawing/">
            <span class="next-text nav-default">Compose 自定义绘制</span>
            <span class="prev-text nav-mobile">Next</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "midFang/blog-comments"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="https://github.com/midFang" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="https://stackoverflow.com/users/14331888/midfang" rel="me noopener" class="iconfont"
      title="stack-overflow"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M809.714286 932.571429l-638.857143 0 0-274.285714-91.428571 0 0 365.714286 821.714286 0 0-365.714286-91.428571 0 0 274.285714zm-538.285714-299.428571l18.857143-89.714286 447.428571 94.285714-18.857143 89.142857zm58.857143-213.714286l38.285714-83.428571 414.285714 193.714286-38.285714 82.857143zm114.857143-203.428571l58.285714-70.285714 350.857143 293.142857-58.285714 70.285714zm226.857143-216l272.571429 366.285714-73.142857 54.857143-272.571429-366.285714zm-410.285714 840.571429l0-90.857143 457.142857 0 0 90.857143-457.142857 0z"></path>
</svg>

    </a>
  
    <a href="https://www.douban.com/people/194654920/" rel="me noopener" class="iconfont"
      title="douban"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M926.917973 37.80608C959.65184 37.80608 986.19392 64.34816 986.19392 97.082027L986.19392 926.917973C986.19392 959.65184 959.65184 986.19392 926.917973 986.19392L97.082027 986.19392C64.34816 986.19392 37.80608 959.65184 37.80608 926.917973L37.80608 97.082027C37.80608 64.34816 64.34816 37.80608 97.082027 37.80608zM176.653653 176.19968 176.653653 252.678827 825.658027 252.678827 825.658027 176.19968zM217.719467 316.146347 217.719467 628.08064 273.524053 628.08064 341.292373 770.39616 157.259093 770.39616 157.259093 845.417813 842.949973 845.417813 842.949973 770.39616 654.226773 770.39616 722.899627 628.08064 783.67744 628.08064 783.67744 316.146347zM684.885333 392.891733 684.885333 553.987413 312.576 553.987413 312.576 392.891733zM570.770773 770.39616 426.653013 770.39616 359.621973 628.08064 639.443627 628.08064z"></path>
</svg>

    </a>


<a href="https://midFang.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2020 -
    2024
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        midFang
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>















  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script type="text/javascript">
    AV.initialize( null ,  null );
  </script>

  <script>
    function showHitCount(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push($(this).attr("id").trim());
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var hits = item.get('hits');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(hits);
          }
          for (var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if (countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function (results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("hits");
            counter.save(null, {
              success: function (counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('hits'));
              },
              error: function (counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
             
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
             
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("hits", 1);
            newcounter.save(null, {
              success: function (newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('hits'));
              },
              error: function (newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function (error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function () {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        
        addCount(Counter);
      } else if ($('.post-link').length > 1) {
        
        showHitCount(Counter);
      }
    });
  </script>





  <script>
    $("#openSearch, #openSearchMobile").click(function(){
      $(".modal-dialog").addClass("visible");
    });

    $("#closeSearch").click(function(){
      $(".modal-dialog").removeClass("visible");
    });

    $(document).click(function(event) {
    
      if (!$(event.target).closest(".modal-content, #openSearch, #openSearchMobile").length) {
        $("body").find(".modal-dialog").removeClass("visible");
      }
    });
  </script>





</body>
</html>
