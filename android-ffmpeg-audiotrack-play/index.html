<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Android 使用 ffmpeg &#43; AudioTrack 音频播放 - midFang&#39;s Blog</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="midFang" />
  <meta name="description" content="在之前的文章中，我们已经编译好了 ffmpeg so 库了，本章中，我们开始使用它进行编解码音频播放，需要先了解一些前置知识 音视频前置知识和之前写的一些 C 代码" />

  <meta name="keywords" content="Hugo, theme, jane" />






<meta name="generator" content="Hugo 0.58.3" />


<link rel="canonical" href="https://midFang.github.io/android-ffmpeg-audiotrack-play/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.af20b78e95c84de86b00a0242a4a77bd2601700e1b250edf27537d957ac0041d.css" integrity="sha256-ryC3jpXITehrAKAkKkp3vSYBcA4bJQ7fJ1N9lXrABB0=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="Android 使用 ffmpeg &#43; AudioTrack 音频播放" />
<meta property="og:description" content="在之前的文章中，我们已经编译好了 ffmpeg so 库了，本章中，我们开始使用它进行编解码音频播放，需要先了解一些前置知识 音视频前置知识和之前写的一些 C 代码" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://midFang.github.io/android-ffmpeg-audiotrack-play/" />
<meta property="article:published_time" content="2024-03-30T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-03-30T00:00:00+00:00" />
<meta itemprop="name" content="Android 使用 ffmpeg &#43; AudioTrack 音频播放">
<meta itemprop="description" content="在之前的文章中，我们已经编译好了 ffmpeg so 库了，本章中，我们开始使用它进行编解码音频播放，需要先了解一些前置知识 音视频前置知识和之前写的一些 C 代码">


<meta itemprop="datePublished" content="2024-03-30T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2024-03-30T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="3303">



<meta itemprop="keywords" content="NDK,FFmpeg," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Android 使用 ffmpeg &#43; AudioTrack 音频播放"/>
<meta name="twitter:description" content="在之前的文章中，我们已经编译好了 ffmpeg so 库了，本章中，我们开始使用它进行编解码音频播放，需要先了解一些前置知识 音视频前置知识和之前写的一些 C 代码"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">midFang's Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/">首页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/post/">全部文章</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/about/">关于</a>
          
        
      </li>
    

    
      <li class="mobile-menu-item">
        <a id="openSearchMobile" class="mobile-menu-item-link menu-item-search" href="#">
          <i class="iconfont">
            <svg version="1.1" viewBox="0 0 1024 1024"
  xmlns="http://www.w3.org/2000/svg" width="18" height="18"
  xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M973.81454219 973.81454219a91.78207815 91.78207815 0 0 1-129.80999631 0l-161.97482118-161.97482118a425.48527711 425.48527711 0 0 1-230.35931791 68.16531768 428.3346319 428.3346319 0 1 1 428.3346319-428.3346319 425.48527711 425.48527711 0 0 1-68.16531768 230.35931791l162.02961656 161.97482118a91.83687354 91.83687354 0 0 1-0.05479538 129.80999631zM451.67040679 145.69361559a305.97679241 305.97679241 0 1 0 0 611.95358361 305.97679241 305.97679241 0 0 0 0-611.95358361z">
  </path>
</svg>

          </i>
        </a>
      </li>
    
  </ul>
</nav>


  

  
    
<div class="modal-dialog">
    
    <div class="modal-content">
      <div id="closeSearch" title="Close" class="close">X</div>
      <div class="modal-header">
        <div class="modal-title">Search</div>
      </div>
      <div class="modal-body">
          <script>
            (function() {
              var cx = '57787f7f4d21d54fc';
              var gcse = document.createElement('script');
              gcse.type = 'text/javascript';
              gcse.async = true;
              gcse.src = (document.location.protocol == 'https:' ? 'https:' :
                  'http:') +
                '//cse.google.com/cse.js?cx=' + cx;
              var s = document.getElementsByTagName('script')[0];
              s.parentNode.insertBefore(gcse, s);
            })();
          </script>
          <gcse:search></gcse:search>
      </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      midFang's Blog
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/">首页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/post/">全部文章</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/about/">关于</a>
          

        

      </li>
    

    
    

    
      <li class="menu-item">
        <a id="openSearch" class="menu-item-link menu-item-search" href="#">
          <i class="iconfont">
            <svg version="1.1" viewBox="0 0 1024 1024"
  xmlns="http://www.w3.org/2000/svg" width="18" height="18"
  xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M973.81454219 973.81454219a91.78207815 91.78207815 0 0 1-129.80999631 0l-161.97482118-161.97482118a425.48527711 425.48527711 0 0 1-230.35931791 68.16531768 428.3346319 428.3346319 0 1 1 428.3346319-428.3346319 425.48527711 425.48527711 0 0 1-68.16531768 230.35931791l162.02961656 161.97482118a91.83687354 91.83687354 0 0 1-0.05479538 129.80999631zM451.67040679 145.69361559a305.97679241 305.97679241 0 1 0 0 611.95358361 305.97679241 305.97679241 0 0 0 0-611.95358361z">
  </path>
</svg>

          </i>
        </a>
      </li>
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">Android 使用 ffmpeg &#43; AudioTrack 音频播放</h1>
      
      <div class="post-meta">
        <time datetime="2024-03-30" class="post-time">
          2024-03-30
        </time>
        <div class="post-category">
            <a href="https://midFang.github.io/categories/ndk/"> NDK </a>
            <a href="https://midFang.github.io/categories/ffmpeg/"> FFmpeg </a>
            
          </div>
        

        
        
          <span id="busuanzi_container_page_pv">
            | 阅读 <span id="busuanzi_value_page_pv"></span>
          </span>
        

        
        
          <span id="/android-ffmpeg-audiotrack-play/" class="leancloud_visitors" data-flag-title="Android 使用 ffmpeg &#43; AudioTrack 音频播放">
            <span class="post-meta-item-text"> | 阅读 </span>
            <span class="leancloud-visitors-count"></span>
          </span>
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#读取音频文件">读取音频文件</a></li>
<li><a href="#播放">播放</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      

<p>在之前的文章中，我们已经编译好了 ffmpeg so 库了，本章中，我们开始使用它进行编解码音频播放，需要先了解一些前置知识</p>

<p><a href="https://github.com/midFang/AwesomeAndroid/blob/master/ffmpeg/%E9%9F%B3%E8%A7%86%E9%A2%91%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86.md">音视频前置知识</a>和之前写的一些 <a href="https://github.com/midFang/AwesomeAndroid">C 代码</a></p>

<p>其实，简单总结的概括就是，我们要播放的音频文件，是一个压缩封装好的一种音频文件，需要对他进行解封装，这一步的目的就是查看音频文件格式，码率，一些解码规则和算法等信息，然后对其进行解码，
然后重采样，然后将解码好的数据丢给硬件去播放，大概就是这个流程，对应到 ffmpeg 代码中，有这几个流程</p>

<p><img src="https://raw.githubusercontent.com/midFang/imgSource/main/202408211137543.png" alt="网上找的一个图" /></p>

<h2 id="读取音频文件">读取音频文件</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="k">class</span> <span class="nc">Player</span> <span class="p">{</span>
    <span class="k">companion</span> <span class="k">object</span> <span class="p">{</span>
        <span class="n">init</span> <span class="p">{</span> <span class="n">System</span><span class="p">.</span><span class="n">loadLibrary</span><span class="p">(</span><span class="s">&#34;player&#34;</span><span class="p">)</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">var</span> <span class="py">url</span><span class="p">:</span> <span class="n">String</span> <span class="p">=</span> <span class="s">&#34;&#34;</span>

    <span class="c1">// 实现回调方法
</span><span class="c1"></span>    <span class="k">private</span> <span class="k">var</span> <span class="py">mErrorListener</span><span class="p">:</span> <span class="n">MediaErrorListener</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>

    <span class="k">fun</span> <span class="nf">setOnErrorListener</span><span class="p">(</span><span class="n">mErrorListener</span><span class="p">:</span> <span class="n">MediaErrorListener</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">mErrorListener</span> <span class="p">=</span> <span class="n">mErrorListener</span>
    <span class="p">}</span>

    <span class="c1">// called from jni  让 JNI 调用的方法
</span><span class="c1"></span>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">onError</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mErrorListener</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">mErrorListener</span><span class="o">!!</span><span class="p">.</span><span class="n">onError</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="nf">setDataSource</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">url</span> <span class="p">=</span> <span class="n">url</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="nf">play</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">url</span><span class="p">.</span><span class="n">isBlank</span><span class="p">())</span> <span class="n">error</span><span class="p">(</span><span class="s">&#34;url is null&#34;</span><span class="p">)</span>
        <span class="n">nPlay</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">external</span> <span class="k">fun</span> <span class="nf">nPlay</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="c1">// 调用 native 方法
</span><span class="c1"></span><span class="p">}</span>

<span class="k">class</span> <span class="nc">MainActivity</span> <span class="p">:</span> <span class="n">ComponentActivity</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">private</span> <span class="k">val</span> <span class="py">play</span> <span class="k">by</span> <span class="n">lazy</span> <span class="p">{</span> <span class="n">Player</span><span class="p">()</span> <span class="p">}</span>
    <span class="k">private</span> <span class="k">val</span> <span class="py">mMusicFile</span><span class="p">:</span> <span class="n">File</span> <span class="p">=</span> <span class="n">File</span><span class="p">(</span><span class="n">Environment</span><span class="p">.</span><span class="n">getExternalStorageDirectory</span><span class="p">(),</span> <span class="s">&#34;input.mp3&#34;</span><span class="p">)</span> <span class="c1">// 注意需要获取权限
</span><span class="c1"></span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
        <span class="n">setContent</span> <span class="p">{</span>

            <span class="n">PlayerTheme</span> <span class="p">{</span>
                <span class="n">Surface</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">(),</span> <span class="n">color</span> <span class="p">=</span> <span class="n">MaterialTheme</span><span class="p">.</span><span class="n">colorScheme</span><span class="p">.</span><span class="n">background</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">play</span><span class="p">.</span><span class="n">setDataSource</span><span class="p">(</span><span class="n">mMusicFile</span><span class="p">.</span><span class="n">absolutePath</span><span class="p">)</span>
                    <span class="n">play</span><span class="p">.</span><span class="n">play</span><span class="p">()</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>这里的步骤大概是读取 mp3 文件，加载 so 库，将 url 丢给 native 中去处理，然后拿到 url 后，就是 jni 中去处理了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;jni.h&gt;</span><span class="cp">
</span><span class="cp"></span><span class="c1">// 因为当前是 .cpp 是 C++ 的编译环境，而 ffmpeg 是 c 写的，所以这里是告诉 C++ 编译器按照 C 语言的规则来进行编译
</span><span class="c1"></span><span class="k">extern</span> <span class="s">&#34;C&#34;</span> <span class="p">{</span>
<span class="cp">#include</span> <span class="cpf">&#34;libavformat/avformat.h&#34;</span><span class="cp">
</span><span class="cp"></span><span class="p">}</span>

<span class="c1">// 创建全局变量
</span><span class="c1"></span><span class="n">MyJNICall</span> <span class="o">*</span><span class="n">myJniCall</span><span class="p">;</span>
<span class="n">FFmpegHelper</span> <span class="o">*</span><span class="n">fFmpegHelper</span><span class="p">;</span>

<span class="k">extern</span> <span class="s">&#34;C&#34;</span>
<span class="n">JNIEXPORT</span> <span class="kt">void</span> <span class="n">JNICALL</span>
<span class="n">Java_com_fang_player_Player_nPlay</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">instance</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">url_</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">myJniCall</span> <span class="o">=</span> <span class="n">new</span> <span class="n">MyJNICall</span><span class="p">(</span><span class="n">nullptr</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">instance</span><span class="p">);</span> 

    <span class="c1">//获取 java 中的字符串，jstring 转换回 c 中的字符来使用
</span><span class="c1"></span>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetStringUTFChars</span><span class="p">(</span><span class="n">url_</span><span class="p">,</span> <span class="n">nullptr</span><span class="p">);</span>

    <span class="n">fFmpegHelper</span> <span class="o">=</span> <span class="n">new</span> <span class="n">FFmpegHelper</span><span class="p">(</span><span class="n">myJniCall</span><span class="p">,</span> <span class="n">url</span><span class="p">);</span>

    <span class="n">fFmpegHelper</span><span class="o">-&gt;</span><span class="n">play</span><span class="p">();</span>

    <span class="n">env</span><span class="o">-&gt;</span><span class="n">ReleaseStringUTFChars</span><span class="p">(</span><span class="n">url_</span><span class="p">,</span> <span class="n">url</span><span class="p">);</span> <span class="c1">// 释放副本占用的内存
</span><span class="c1"></span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>首先这里创建了几个全局变量，注意，他是通过 new 创建的，使用完成之后，需要 delete，然后创建 FFmpegHelper 对象，然后再调用 play 方法，还有需要注意的点是这里的 url 是通过 GetStringUTFChars 来获取的（或者通过GetStringChars）
获取了一个 java 的字符串在c里面使用，其实这里是拷贝了一个字符串的副本，所以记得需要调用 ReleaseStringUTFChars 来释放这块副本所占用的内存</p>

<h2 id="播放">播放</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="n">FFmpegHelper</span><span class="o">::</span><span class="n">play</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">av_register_all</span><span class="p">();</span> <span class="c1">// 初始化所有的编解码器
</span><span class="c1"></span>    <span class="n">avformat_network_init</span><span class="p">();</span>

    <span class="kt">int</span> <span class="n">formatOpenInputRes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">formatFindStreamInfoRes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">audioStreamIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">AVCodecParameters</span> <span class="o">*</span><span class="n">pCodecParameters</span><span class="p">;</span>
    <span class="n">AVCodec</span> <span class="o">*</span><span class="n">pCodec</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">codecParametersToContextRes</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">codecOpenRes</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">AVPacket</span> <span class="o">*</span><span class="n">pPacket</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">;</span>
    <span class="n">AVFrame</span> <span class="o">*</span><span class="n">pFrame</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">;</span>

    <span class="c1">// 打开输入流，读取文件信息，因为音视频前置知识中了解到，一个音视频的组成，包含了这些，要先读取这些信息，才能知道如何解码，所以这是第一步需要做的事情，读取到的信息都会存储在 AVFormatContext 中， 内部说明，需要调用 close 释放资源
</span><span class="c1"></span>    <span class="n">formatOpenInputRes</span> <span class="o">=</span> <span class="n">avformat_open_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pFormatContext</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">nullptr</span><span class="p">,</span> <span class="n">nullptr</span><span class="p">);</span>

    <span class="c1">// 第一步
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">formatOpenInputRes</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 打开读取文件失败
</span><span class="c1"></span>        <span class="c1">// 失败，需要告知 java 层，需要释放流资源
</span><span class="c1"></span>        <span class="n">LOGE</span><span class="p">(</span><span class="s">&#34;format open input error: %s&#34;</span><span class="p">,</span> <span class="n">av_err2str</span><span class="p">(</span><span class="n">formatOpenInputRes</span><span class="p">));</span>
        <span class="n">callPlayerJniError</span><span class="p">(</span><span class="n">formatOpenInputRes</span><span class="p">,</span> <span class="n">av_err2str</span><span class="p">(</span><span class="n">formatOpenInputRes</span><span class="p">));</span>
        <span class="k">return</span><span class="p">;</span> <span class="c1">// 因为 return 了，之前打开的相关操作，需要释放
</span><span class="c1"></span>    <span class="p">}</span>

    <span class="c1">// 第二步，读取流信息，并将读取到的信息，封装在 pFormatContext 中
</span><span class="c1"></span>    <span class="n">formatFindStreamInfoRes</span> <span class="o">=</span> <span class="n">avformat_find_stream_info</span><span class="p">(</span><span class="n">pFormatContext</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">formatFindStreamInfoRes</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">LOGE</span><span class="p">(</span><span class="s">&#34;format find stream info error: %s&#34;</span><span class="p">,</span> <span class="n">av_err2str</span><span class="p">(</span><span class="n">formatFindStreamInfoRes</span><span class="p">));</span>
        <span class="n">callPlayerJniError</span><span class="p">(</span><span class="n">formatFindStreamInfoRes</span><span class="p">,</span> <span class="n">av_err2str</span><span class="p">(</span><span class="n">formatFindStreamInfoRes</span><span class="p">));</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 第三步：查找音频流的 index, 为什么要找 ？因为一个文件中，含有多一个流 （可能是视频流，可能是音频流，这里我们要找的就是音频流）
</span><span class="c1"></span>    <span class="n">audioStreamIndex</span> <span class="o">=</span> <span class="n">av_find_best_stream</span><span class="p">(</span><span class="n">pFormatContext</span><span class="p">,</span> <span class="n">AVMediaType</span><span class="o">::</span><span class="n">AVMEDIA_TYPE_AUDIO</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">nullptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">audioStreamIndex</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">LOGE</span><span class="p">(</span><span class="s">&#34;format audio stream error: %d, %s&#34;</span><span class="p">,</span> <span class="n">audioStreamIndex</span><span class="p">,</span> <span class="n">av_err2str</span><span class="p">(</span><span class="n">audioStreamIndex</span><span class="p">));</span>
        <span class="n">callPlayerJniError</span><span class="p">(</span><span class="n">audioStreamIndex</span><span class="p">,</span> <span class="n">av_err2str</span><span class="p">(</span><span class="n">audioStreamIndex</span><span class="p">));</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>


    <span class="c1">// 4. 查找解码器
</span><span class="c1"></span>    <span class="n">pCodecParameters</span> <span class="o">=</span> <span class="n">pFormatContext</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">audioStreamIndex</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">codecpar</span><span class="p">;</span>
    <span class="n">pCodec</span> <span class="o">=</span> <span class="n">avcodec_find_decoder</span><span class="p">(</span><span class="n">pCodecParameters</span><span class="o">-&gt;</span><span class="n">codec_id</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pCodec</span> <span class="o">==</span> <span class="n">nullptr</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">LOGE</span><span class="p">(</span><span class="s">&#34;codec find audio decoder error&#34;</span><span class="p">);</span>
        <span class="c1">// 使用自定义的错误码
</span><span class="c1"></span>        <span class="n">callPlayerJniError</span><span class="p">(</span><span class="n">CODEC_FIND_DECODER_ERROR_CODE</span><span class="p">,</span> <span class="s">&#34;codec find audio decoder error&#34;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 打开解码器
</span><span class="c1"></span>    <span class="n">pCodecContext</span> <span class="o">=</span> <span class="n">avcodec_alloc_context3</span><span class="p">(</span><span class="n">pCodec</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pCodecContext</span> <span class="o">==</span> <span class="n">nullptr</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">LOGE</span><span class="p">(</span><span class="s">&#34;codec alloc context error&#34;</span><span class="p">);</span>
        <span class="n">callPlayerJniError</span><span class="p">(</span><span class="n">CODEC_ALLOC_CONTEXT_ERROR_CODE</span><span class="p">,</span> <span class="s">&#34;codec alloc context error&#34;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 设置编码器的上下文
</span><span class="c1"></span>    <span class="n">codecParametersToContextRes</span> <span class="o">=</span> <span class="n">avcodec_parameters_to_context</span><span class="p">(</span><span class="n">pCodecContext</span><span class="p">,</span> <span class="n">pCodecParameters</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">codecParametersToContextRes</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">LOGE</span><span class="p">(</span><span class="s">&#34;codec parameters to context error: %s&#34;</span><span class="p">,</span> <span class="n">av_err2str</span><span class="p">(</span><span class="n">codecParametersToContextRes</span><span class="p">));</span>
        <span class="n">callPlayerJniError</span><span class="p">(</span><span class="n">codecParametersToContextRes</span><span class="p">,</span> <span class="n">av_err2str</span><span class="p">(</span><span class="n">codecParametersToContextRes</span><span class="p">));</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 打开编码器
</span><span class="c1"></span>    <span class="n">codecOpenRes</span> <span class="o">=</span> <span class="n">avcodec_open2</span><span class="p">(</span><span class="n">pCodecContext</span><span class="p">,</span> <span class="n">pCodec</span><span class="p">,</span> <span class="n">nullptr</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">codecOpenRes</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">LOGE</span><span class="p">(</span><span class="s">&#34;codec audio open error: %s&#34;</span><span class="p">,</span> <span class="n">av_err2str</span><span class="p">(</span><span class="n">codecOpenRes</span><span class="p">));</span>
        <span class="n">callPlayerJniError</span><span class="p">(</span><span class="n">codecOpenRes</span><span class="p">,</span> <span class="n">av_err2str</span><span class="p">(</span><span class="n">codecOpenRes</span><span class="p">));</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 重采样， 从采样是什么 ？如果不重采样，播放的音频，会有呲呲呲的声音
</span><span class="c1"></span>    <span class="c1">// 音频重采样（audio resampling）是指将音频信号从一个采样率转换为另一个采样率的过程。采样率决定了每秒记录的采样点数量，通常以赫兹 (Hz) 表示，例如 44.1kHz、48kHz 等
</span><span class="c1"></span>
    <span class="c1">// 开始进行 音频重采样 
</span><span class="c1"></span>    <span class="c1">// 输出采样率
</span><span class="c1"></span>    <span class="n">int64_t</span> <span class="n">out_ch_layout</span> <span class="o">=</span> <span class="n">AV_CH_LAYOUT_STEREO</span><span class="p">;</span> <span class="c1">// 立体声
</span><span class="c1"></span>    <span class="k">enum</span> <span class="n">AVSampleFormat</span> <span class="n">out_sample_fmt</span> <span class="o">=</span> <span class="n">AVSampleFormat</span><span class="o">::</span><span class="n">AV_SAMPLE_FMT_S16</span><span class="p">;</span> <span class="c1">// 采样格式
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">out_sample_rate</span> <span class="o">=</span> <span class="n">AUDIO_SAMPLE_RATE</span><span class="p">;</span> <span class="c1">// 采样率
</span><span class="c1"></span>
    <span class="c1">// 输入采样率，从解码器中读取文件信息
</span><span class="c1"></span>    <span class="n">int64_t</span> <span class="n">in_ch_layout</span> <span class="o">=</span> <span class="n">pCodecContext</span><span class="o">-&gt;</span><span class="n">channel_layout</span><span class="p">;</span>  <span class="c1">// 输入音频的声道布局
</span><span class="c1"></span>    <span class="k">enum</span> <span class="n">AVSampleFormat</span> <span class="n">in_sample_fmt</span> <span class="o">=</span> <span class="n">pCodecContext</span><span class="o">-&gt;</span><span class="n">sample_fmt</span><span class="p">;</span> <span class="c1">// 输入音频的采样格式
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">in_sample_rate</span> <span class="o">=</span> <span class="n">pCodecContext</span><span class="o">-&gt;</span><span class="n">sample_rate</span><span class="p">;</span> <span class="c1">// 输入音频的采样率
</span><span class="c1"></span>
    <span class="c1">// 重采样方法参数设置:
</span><span class="c1"></span>    <span class="n">swrContext</span> <span class="o">=</span> <span class="n">swr_alloc_set_opts</span><span class="p">(</span><span class="n">nullptr</span><span class="p">,</span> <span class="n">out_ch_layout</span><span class="p">,</span> <span class="n">out_sample_fmt</span><span class="p">,</span> <span class="n">out_sample_rate</span><span class="p">,</span> <span class="n">in_ch_layout</span><span class="p">,</span> <span class="n">in_sample_fmt</span><span class="p">,</span> <span class="n">in_sample_rate</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nullptr</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">swrContext</span> <span class="o">==</span> <span class="n">nullptr</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 提示错误
</span><span class="c1"></span>        <span class="n">callPlayerJniError</span><span class="p">(</span><span class="n">SWR_ALLOC_SET_OPTS_ERROR_CODE</span><span class="p">,</span> <span class="s">&#34;swr alloc set opts error&#34;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">swr_init</span><span class="p">(</span><span class="n">swrContext</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">callPlayerJniError</span><span class="p">(</span><span class="n">SWR_CONTEXT_INIT_ERROR_CODE</span><span class="p">,</span> <span class="s">&#34;swr context swr init error&#34;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>


    <span class="c1">// 设置数组要存储的采样率数据大小，可以理解为就是一帧的数据 （根据输出采样率来设置）
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">outChannels</span> <span class="o">=</span> <span class="n">av_get_channel_layout_nb_channels</span><span class="p">(</span><span class="n">out_ch_layout</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">dataSize</span> <span class="o">=</span> <span class="n">av_samples_get_buffer_size</span><span class="p">(</span><span class="n">nullptr</span><span class="p">,</span> <span class="n">outChannels</span><span class="p">,</span> <span class="n">pCodecParameters</span><span class="o">-&gt;</span><span class="n">frame_size</span><span class="p">,</span> <span class="n">out_sample_fmt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">resampleOutBuffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="n">dataSize</span><span class="p">);</span>

    <span class="n">jbyteArray</span> <span class="n">jPcmByteArray</span> <span class="o">=</span> <span class="n">pJniCall</span><span class="o">-&gt;</span><span class="n">jniEnv</span><span class="o">-&gt;</span><span class="n">NewByteArray</span><span class="p">(</span><span class="n">dataSize</span><span class="p">);</span>
    <span class="n">jbyte</span> <span class="o">*</span><span class="n">jPcmData</span> <span class="o">=</span> <span class="n">pJniCall</span><span class="o">-&gt;</span><span class="n">jniEnv</span><span class="o">-&gt;</span><span class="n">GetByteArrayElements</span><span class="p">(</span><span class="n">jPcmByteArray</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span> <span class="c1">// 数据回调给 java audioTrack 的数据，在循环外创建，防止循环中多次创建数组，导致内存上涨
</span><span class="c1"></span>
    <span class="n">pPacket</span> <span class="o">=</span> <span class="n">av_packet_alloc</span><span class="p">();</span> <span class="c1">// 压缩数据
</span><span class="c1"></span>    <span class="n">pFrame</span> <span class="o">=</span> <span class="n">av_frame_alloc</span><span class="p">();</span> <span class="c1">// 解码出来的数据
</span><span class="c1"></span>
    <span class="c1">// 开始解码
</span><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="n">av_read_frame</span><span class="p">(</span><span class="n">pFormatContext</span><span class="p">,</span> <span class="n">pPacket</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> 
        <span class="k">if</span> <span class="p">(</span><span class="n">pPacket</span><span class="o">-&gt;</span><span class="n">stream_index</span> <span class="o">==</span> <span class="n">audioStreamIndex</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 判断是否是音频流
</span><span class="c1"></span>            <span class="c1">// Packet 包，压缩的数据，解码成 pcm 数据
</span><span class="c1"></span>            <span class="c1">// 有个中间缓存，一个解码的放在里面，一个在不断的读取
</span><span class="c1"></span>            <span class="kt">int</span> <span class="n">codecSendPacketRes</span> <span class="o">=</span> <span class="n">avcodec_send_packet</span><span class="p">(</span><span class="n">pCodecContext</span><span class="p">,</span> <span class="n">pPacket</span><span class="p">);</span> <span class="c1">// 做什么的 --&gt; 将压缩数据发送给解码器
</span><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">codecSendPacketRes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">int</span> <span class="n">codecReceiveFrameRes</span> <span class="o">=</span> <span class="n">avcodec_receive_frame</span><span class="p">(</span><span class="n">pCodecContext</span><span class="p">,</span> <span class="n">pFrame</span><span class="p">);</span> <span class="c1">// 做什么的, 将压缩数据转为frame
</span><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="n">codecReceiveFrameRes</span> <span class="o">==</span> <span class="n">AVERROR</span><span class="p">(</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="o">||</span> <span class="n">codecReceiveFrameRes</span> <span class="o">==</span> <span class="n">AVERROR_EOF</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">LOGE</span><span class="p">(</span><span class="s">&#34;解码出现错误&#34;</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">codecReceiveFrameRes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// AVPacket -&gt; AVFrame
</span><span class="c1"></span>                    <span class="n">index</span><span class="o">++</span><span class="p">;</span>

                    <span class="c1">// 第一个参数： 分配好的 SwrContext 上下文，它包含了转换操作所需的所有参数（如输入输出的声道布局、采样格式和采样率
</span><span class="c1"></span>                    <span class="c1">// 第二个参数： 输出缓冲区，用来存储转换后的音频数据。如果是打包音频数据，则只需要设置第一个缓冲区
</span><span class="c1"></span>                    <span class="c1">// 第三个参数：每个声道中可用的输出空间，单位为样本数。例如，如果你希望输出 1024 个样本，你将设置 out_count 为 1024。
</span><span class="c1"></span>                    <span class="c1">// 第四个参数：输入缓冲区，包含待转换的音频数据。如果打包音频数据，则只需要设置第一个缓冲区。
</span><span class="c1"></span>                    <span class="c1">// 第五个参数：每个声道中可用的输入样本数。这代表待转换音频数据的数量。
</span><span class="c1"></span>                    <span class="n">swr_convert</span><span class="p">(</span><span class="n">swrContext</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resampleOutBuffer</span><span class="p">,</span> <span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">nb_samples</span><span class="p">,</span>
                                <span class="p">(</span><span class="k">const</span> <span class="n">uint8_t</span> <span class="o">**</span><span class="p">)</span> <span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">nb_samples</span><span class="p">);</span>

                    <span class="n">memcpy</span><span class="p">(</span><span class="n">jPcmData</span><span class="p">,</span> <span class="n">resampleOutBuffer</span><span class="p">,</span> <span class="n">dataSize</span><span class="p">);</span> <span class="c1">// 数据拷贝到 jPcmData 中
</span><span class="c1"></span>                    <span class="n">LOGE</span><span class="p">(</span><span class="s">&#34;解码第 %d 帧，大小 = %d&#34;</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">dataSize</span><span class="p">);</span>

                    <span class="c1">// 0 把 c 的数组的数据同步到 jbyteArray , 然后释放native数组 （这里涉及到是数据同步）
</span><span class="c1"></span>                    <span class="c1">// JNI_COMMIT 会同步数据给 jPcmByteArray ，但是不会释放 jPcmData
</span><span class="c1"></span>                    <span class="n">pJniCall</span><span class="o">-&gt;</span><span class="n">jniEnv</span><span class="o">-&gt;</span><span class="n">ReleaseByteArrayElements</span><span class="p">(</span><span class="n">jPcmByteArray</span><span class="p">,</span> <span class="n">jPcmData</span><span class="p">,</span> <span class="n">JNI_COMMIT</span><span class="p">);</span>
                    <span class="n">pJniCall</span><span class="o">-&gt;</span><span class="n">callAudioTrackWrite</span><span class="p">(</span><span class="n">jPcmByteArray</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dataSize</span><span class="p">);</span> <span class="c1">// 写入 audioTrack，调用 write 方法
</span><span class="c1"></span>                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="c1">// 解引用：解引用是什么意思， 意思就是解除引用，才能回收
</span><span class="c1"></span>        <span class="n">av_packet_unref</span><span class="p">(</span><span class="n">pPacket</span><span class="p">);</span>
        <span class="n">av_frame_unref</span><span class="p">(</span><span class="n">pFrame</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// 1. 解引用数据 data ， 2. 销毁 pPacket 结构体内存  3. pPacket = NULL
</span><span class="c1"></span>    <span class="n">av_packet_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pPacket</span><span class="p">);</span>
    <span class="n">av_frame_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pFrame</span><span class="p">);</span>

    <span class="c1">// 解除 jPcmDataArray 的持有，让 javaGC 回收
</span><span class="c1"></span>    <span class="n">pJniCall</span><span class="o">-&gt;</span><span class="n">jniEnv</span><span class="o">-&gt;</span><span class="n">ReleaseByteArrayElements</span><span class="p">(</span><span class="n">jPcmByteArray</span><span class="p">,</span> <span class="n">jPcmData</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">pJniCall</span><span class="o">-&gt;</span><span class="n">jniEnv</span><span class="o">-&gt;</span><span class="n">DeleteLocalRef</span><span class="p">(</span><span class="n">jPcmByteArray</span><span class="p">);</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>这里的代码就是整个音频播放的核心代码了，基本上需要调用的方法，就是上面图中需要调用的几个方法，需要什么参数再往前推就可以了，需要注意的是，这里需要对音频进行重新采样，如果不采样的话，播放的声音
可能是呲呲呲的，那为什么要进行重采样呢 ？</p>

<ul>
<li>什么是音频重采样？采样率是什么 ？
<br /></li>
</ul>

<blockquote>
<p>想象你在录制一段声音，比如你在唱歌。录音设备会在每秒钟收集很多点来代表这段声音，这些点就像一系列快照。这些每秒钟收集的点的数量就是采样率。例如：
44100Hz：每秒钟收集 44100 个点
48000Hz：每秒钟收集 48000 个点
音频重采样就是把这个“每秒钟收集点的数量”从一个数换成另一个数。</p>
</blockquote>

<ul>
<li>为什么要重采样？
<br /></li>
</ul>

<blockquote>
<p>兼容性：不同的设备和软件有时候只能处理特定的采样率。比如，你的麦克风可能录制的是 44100Hz，但你的音频编辑软件可能要求文件是 48000Hz。
优化效果：有时候在处理音频时，我们希望用更高的采样率来获得更好的效果，然后再转换回需要的采样率。
文件大小：更高的采样率会产生更大的文件，有时候我们会需要降低采样率以减小文件大小。</p>
</blockquote>

<p>所以，这里我们要保证输出采样率是能够让硬件能够播放的，可以理解为格式转换，然后在 while 中进行解码，解码好的数据丢给 AudioTrack 进行播放即可，需要注意的是
这里是 while 中，注意不要在循环中创建数组，不然会导致内存频繁的上涨，可以在循环外创建通过 GetByteArrayElements 创建 java 的数据，然后循环内配合 ReleaseByteArrayElements 将
数据同步给 Java 的数组</p>

<p>相关的 AudioTrack 播放代码如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="n">MyJNICall</span><span class="o">::</span><span class="n">MyJNICall</span><span class="p">(</span><span class="n">JavaVM</span> <span class="o">*</span><span class="n">javaVM</span><span class="p">,</span> <span class="n">JNIEnv</span> <span class="o">*</span><span class="n">jniEnv</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">jPlayerObj</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">this</span><span class="o">-&gt;</span><span class="n">javaVM</span> <span class="o">=</span> <span class="n">javaVM</span><span class="p">;</span>
    <span class="n">this</span><span class="o">-&gt;</span><span class="n">jniEnv</span> <span class="o">=</span> <span class="n">jniEnv</span><span class="p">;</span>
    <span class="n">this</span><span class="o">-&gt;</span><span class="n">jPlayerObj</span> <span class="o">=</span> <span class="n">jPlayerObj</span><span class="p">;</span>

    <span class="n">initCrateAudioTrack</span><span class="p">();</span> <span class="c1">// 创建 java 的 audioTrack 对象
</span><span class="c1"></span>
    <span class="c1">// 创建 MediaErrorListener 回调方法， 将错误信息回调给 java 层级
</span><span class="c1"></span>    <span class="n">jclass</span> <span class="n">jPlayClass</span> <span class="o">=</span> <span class="n">jniEnv</span><span class="o">-&gt;</span><span class="n">GetObjectClass</span><span class="p">(</span><span class="n">jPlayerObj</span><span class="p">);</span> <span class="c1">// 找到监听回调的类
</span><span class="c1"></span>    <span class="n">jPlayerErrorMid</span> <span class="o">=</span> <span class="n">jniEnv</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">jPlayClass</span><span class="p">,</span> <span class="s">&#34;onError&#34;</span><span class="p">,</span> <span class="s">&#34;(ILjava/lang/String;)V&#34;</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 析构函数
</span><span class="c1"></span><span class="n">MyJNICall</span><span class="o">::~</span><span class="n">MyJNICall</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">jniEnv</span><span class="o">-&gt;</span><span class="n">DeleteLocalRef</span><span class="p">(</span><span class="n">jAudioTrackObj</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">MyJNICall</span><span class="o">::</span><span class="n">initCrateAudioTrack</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 反射创建对象
</span><span class="c1"></span>    <span class="n">jclass</span> <span class="n">jAudioTrackClass</span> <span class="o">=</span> <span class="n">jniEnv</span><span class="o">-&gt;</span><span class="n">FindClass</span><span class="p">(</span><span class="s">&#34;android/media/AudioTrack&#34;</span><span class="p">);</span>
    <span class="n">jmethodID</span> <span class="n">jAudioTackCMid</span> <span class="o">=</span> <span class="n">jniEnv</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">jAudioTrackClass</span><span class="p">,</span> <span class="s">&#34;&lt;init&gt;&#34;</span><span class="p">,</span> <span class="s">&#34;(IIIIII)V&#34;</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">streamType</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">sampleRateInHz</span> <span class="o">=</span> <span class="n">AUDIO_SAMPLE_RATE</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">channelConfig</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x4</span> <span class="o">|</span> <span class="mh">0x8</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">audioFormat</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="n">jmethodID</span> <span class="n">getMinBufferSizeMid</span> <span class="o">=</span> <span class="n">jniEnv</span><span class="o">-&gt;</span><span class="n">GetStaticMethodID</span><span class="p">(</span><span class="n">jAudioTrackClass</span><span class="p">,</span> <span class="s">&#34;getMinBufferSize&#34;</span><span class="p">,</span> <span class="s">&#34;(III)I&#34;</span><span class="p">);</span>
    <span class="c1">// 调用方法 (getMinBufferSize() 接口，字面意思是返回最小数据缓冲区的大小，它是声音能正常播放的最低保障)
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">bufferSizeInBytes</span> <span class="o">=</span> <span class="n">jniEnv</span><span class="o">-&gt;</span><span class="n">CallStaticIntMethod</span><span class="p">(</span><span class="n">jAudioTrackClass</span><span class="p">,</span> <span class="n">getMinBufferSizeMid</span><span class="p">,</span>
                                                        <span class="n">sampleRateInHz</span><span class="p">,</span> <span class="n">channelConfig</span><span class="p">,</span> <span class="n">audioFormat</span><span class="p">);</span>

    <span class="c1">// 创建对象
</span><span class="c1"></span>    <span class="n">jAudioTrackObj</span> <span class="o">=</span> <span class="n">jniEnv</span><span class="o">-&gt;</span><span class="n">NewObject</span><span class="p">(</span><span class="n">jAudioTrackClass</span><span class="p">,</span> <span class="n">jAudioTackCMid</span><span class="p">,</span> <span class="n">streamType</span><span class="p">,</span>
                                       <span class="n">sampleRateInHz</span><span class="p">,</span> <span class="n">channelConfig</span><span class="p">,</span> <span class="n">audioFormat</span><span class="p">,</span> <span class="n">bufferSizeInBytes</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

    <span class="c1">// play 播放
</span><span class="c1"></span>    <span class="n">jmethodID</span> <span class="n">playMid</span> <span class="o">=</span> <span class="n">jniEnv</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">jAudioTrackClass</span><span class="p">,</span> <span class="s">&#34;play&#34;</span><span class="p">,</span> <span class="s">&#34;()V&#34;</span><span class="p">);</span>
    <span class="n">jniEnv</span><span class="o">-&gt;</span><span class="n">CallVoidMethod</span><span class="p">(</span><span class="n">jAudioTrackObj</span><span class="p">,</span> <span class="n">playMid</span><span class="p">);</span>

    <span class="c1">// write method
</span><span class="c1"></span>    <span class="n">jAudioTrackWriteMid</span> <span class="o">=</span> <span class="n">jniEnv</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">jAudioTrackClass</span><span class="p">,</span> <span class="s">&#34;write&#34;</span><span class="p">,</span> <span class="s">&#34;([BII)I&#34;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">MyJNICall</span><span class="o">::</span><span class="n">callAudioTrackWrite</span><span class="p">(</span><span class="n">jbyteArray</span> <span class="n">audioData</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offsetInBytes</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sizeInBytes</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="n">jniEnv</span><span class="o">-&gt;</span><span class="n">CallIntMethod</span><span class="p">(</span><span class="n">jAudioTrackObj</span><span class="p">,</span> <span class="n">jAudioTrackWriteMid</span><span class="p">,</span> <span class="n">audioData</span><span class="p">,</span> <span class="n">offsetInBytes</span><span class="p">,</span> <span class="n">sizeInBytes</span><span class="p">);</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>这里的逻辑就是反射创建 AudioTrack 对象，然后将上面解码好的数据通过调用 callAudioTrackWrite ，即可完成播放</p>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">midFang</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
      2024-03-30
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://midFang.github.io/tags/ndk/">NDK</a>
          <a href="https://midFang.github.io/tags/ffmpeg/">FFmpeg</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/android-ffmpeg-opensl-es-play/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">Android 使用 OpenSL ES 音频播放</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/android-compile-ffmpeg/">
            <span class="next-text nav-default">Android 编译 ffmpeg</span>
            <span class="prev-text nav-mobile">Next</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "midFang/blog-comments"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="https://github.com/midFang" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="https://stackoverflow.com/users/14331888/midfang" rel="me noopener" class="iconfont"
      title="stack-overflow"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M809.714286 932.571429l-638.857143 0 0-274.285714-91.428571 0 0 365.714286 821.714286 0 0-365.714286-91.428571 0 0 274.285714zm-538.285714-299.428571l18.857143-89.714286 447.428571 94.285714-18.857143 89.142857zm58.857143-213.714286l38.285714-83.428571 414.285714 193.714286-38.285714 82.857143zm114.857143-203.428571l58.285714-70.285714 350.857143 293.142857-58.285714 70.285714zm226.857143-216l272.571429 366.285714-73.142857 54.857143-272.571429-366.285714zm-410.285714 840.571429l0-90.857143 457.142857 0 0 90.857143-457.142857 0z"></path>
</svg>

    </a>
  
    <a href="https://www.douban.com/people/194654920/" rel="me noopener" class="iconfont"
      title="douban"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M926.917973 37.80608C959.65184 37.80608 986.19392 64.34816 986.19392 97.082027L986.19392 926.917973C986.19392 959.65184 959.65184 986.19392 926.917973 986.19392L97.082027 986.19392C64.34816 986.19392 37.80608 959.65184 37.80608 926.917973L37.80608 97.082027C37.80608 64.34816 64.34816 37.80608 97.082027 37.80608zM176.653653 176.19968 176.653653 252.678827 825.658027 252.678827 825.658027 176.19968zM217.719467 316.146347 217.719467 628.08064 273.524053 628.08064 341.292373 770.39616 157.259093 770.39616 157.259093 845.417813 842.949973 845.417813 842.949973 770.39616 654.226773 770.39616 722.899627 628.08064 783.67744 628.08064 783.67744 316.146347zM684.885333 392.891733 684.885333 553.987413 312.576 553.987413 312.576 392.891733zM570.770773 770.39616 426.653013 770.39616 359.621973 628.08064 639.443627 628.08064z"></path>
</svg>

    </a>


<a href="https://midFang.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2020 -
    2024
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        midFang
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>















  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script type="text/javascript">
    AV.initialize( null ,  null );
  </script>

  <script>
    function showHitCount(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push($(this).attr("id").trim());
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var hits = item.get('hits');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(hits);
          }
          for (var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if (countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function (results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("hits");
            counter.save(null, {
              success: function (counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('hits'));
              },
              error: function (counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
             
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
             
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("hits", 1);
            newcounter.save(null, {
              success: function (newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('hits'));
              },
              error: function (newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function (error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function () {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        
        addCount(Counter);
      } else if ($('.post-link').length > 1) {
        
        showHitCount(Counter);
      }
    });
  </script>





  <script>
    $("#openSearch, #openSearchMobile").click(function(){
      $(".modal-dialog").addClass("visible");
    });

    $("#closeSearch").click(function(){
      $(".modal-dialog").removeClass("visible");
    });

    $(document).click(function(event) {
    
      if (!$(event.target).closest(".modal-content, #openSearch, #openSearchMobile").length) {
        $("body").find(".modal-dialog").removeClass("visible");
      }
    });
  </script>





</body>
</html>
