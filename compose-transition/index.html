<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Compose转场动画之 Transition - midFang&#39;s Blog</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="midFang" />
  <meta name="description" content="前言 在上两篇文章中，我们了解了 Compose 中动画的各种 animationSpec 的使用和 anim.xxx 的方法参数使用说明，这节开始学习 Transition 的使用 Transition 可对多个属性值进行动画 在 Android 原生中, Transition 动画是" />

  <meta name="keywords" content="Hugo, theme, jane" />






<meta name="generator" content="Hugo 0.58.3" />


<link rel="canonical" href="https://midFang.github.io/compose-transition/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.af20b78e95c84de86b00a0242a4a77bd2601700e1b250edf27537d957ac0041d.css" integrity="sha256-ryC3jpXITehrAKAkKkp3vSYBcA4bJQ7fJ1N9lXrABB0=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="Compose转场动画之 Transition" />
<meta property="og:description" content="前言 在上两篇文章中，我们了解了 Compose 中动画的各种 animationSpec 的使用和 anim.xxx 的方法参数使用说明，这节开始学习 Transition 的使用 Transition 可对多个属性值进行动画 在 Android 原生中, Transition 动画是" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://midFang.github.io/compose-transition/" />
<meta property="article:published_time" content="2023-06-11T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-06-11T00:00:00+00:00" />
<meta itemprop="name" content="Compose转场动画之 Transition">
<meta itemprop="description" content="前言 在上两篇文章中，我们了解了 Compose 中动画的各种 animationSpec 的使用和 anim.xxx 的方法参数使用说明，这节开始学习 Transition 的使用 Transition 可对多个属性值进行动画 在 Android 原生中, Transition 动画是">


<meta itemprop="datePublished" content="2023-06-11T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2023-06-11T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="3189">



<meta itemprop="keywords" content="Android,动画,Compose," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Compose转场动画之 Transition"/>
<meta name="twitter:description" content="前言 在上两篇文章中，我们了解了 Compose 中动画的各种 animationSpec 的使用和 anim.xxx 的方法参数使用说明，这节开始学习 Transition 的使用 Transition 可对多个属性值进行动画 在 Android 原生中, Transition 动画是"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">midFang's Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/">首页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/post/">全部文章</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/categories/">分类</a>
          
        
      </li>
    

    
      <li class="mobile-menu-item">
        <a id="openSearchMobile" class="mobile-menu-item-link menu-item-search" href="#">
          <i class="iconfont">
            <svg version="1.1" viewBox="0 0 1024 1024"
  xmlns="http://www.w3.org/2000/svg" width="18" height="18"
  xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M973.81454219 973.81454219a91.78207815 91.78207815 0 0 1-129.80999631 0l-161.97482118-161.97482118a425.48527711 425.48527711 0 0 1-230.35931791 68.16531768 428.3346319 428.3346319 0 1 1 428.3346319-428.3346319 425.48527711 425.48527711 0 0 1-68.16531768 230.35931791l162.02961656 161.97482118a91.83687354 91.83687354 0 0 1-0.05479538 129.80999631zM451.67040679 145.69361559a305.97679241 305.97679241 0 1 0 0 611.95358361 305.97679241 305.97679241 0 0 0 0-611.95358361z">
  </path>
</svg>

          </i>
        </a>
      </li>
    
  </ul>
</nav>


  

  
    
<div class="modal-dialog">
    
    <div class="modal-content">
      <div id="closeSearch" title="Close" class="close">X</div>
      <div class="modal-header">
        <div class="modal-title">Search</div>
      </div>
      <div class="modal-body">
          <script>
            (function() {
              var cx = '57787f7f4d21d54fc';
              var gcse = document.createElement('script');
              gcse.type = 'text/javascript';
              gcse.async = true;
              gcse.src = (document.location.protocol == 'https:' ? 'https:' :
                  'http:') +
                '//cse.google.com/cse.js?cx=' + cx;
              var s = document.getElementsByTagName('script')[0];
              s.parentNode.insertBefore(gcse, s);
            })();
          </script>
          <gcse:search></gcse:search>
      </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      midFang's Blog
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/">首页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/post/">全部文章</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/categories/">分类</a>
          

        

      </li>
    

    
    

    
      <li class="menu-item">
        <a id="openSearch" class="menu-item-link menu-item-search" href="#">
          <i class="iconfont">
            <svg version="1.1" viewBox="0 0 1024 1024"
  xmlns="http://www.w3.org/2000/svg" width="18" height="18"
  xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M973.81454219 973.81454219a91.78207815 91.78207815 0 0 1-129.80999631 0l-161.97482118-161.97482118a425.48527711 425.48527711 0 0 1-230.35931791 68.16531768 428.3346319 428.3346319 0 1 1 428.3346319-428.3346319 425.48527711 425.48527711 0 0 1-68.16531768 230.35931791l162.02961656 161.97482118a91.83687354 91.83687354 0 0 1-0.05479538 129.80999631zM451.67040679 145.69361559a305.97679241 305.97679241 0 1 0 0 611.95358361 305.97679241 305.97679241 0 0 0 0-611.95358361z">
  </path>
</svg>

          </i>
        </a>
      </li>
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">Compose转场动画之 Transition</h1>
      
      <div class="post-meta">
        <time datetime="2023-06-11" class="post-time">
          2023-06-11
        </time>
        <div class="post-category">
            <a href="https://midFang.github.io/categories/%E5%8A%A8%E7%94%BB/"> 动画 </a>
            
          </div>
        

        
        
          <span id="busuanzi_container_page_pv">
            | 阅读 <span id="busuanzi_value_page_pv"></span>
          </span>
        

        
        
          <span id="/compose-transition/" class="leancloud_visitors" data-flag-title="Compose转场动画之 Transition">
            <span class="post-meta-item-text"> | 阅读 </span>
            <span class="leancloud-visitors-count"></span>
          </span>
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#前言">前言</a></li>
<li><a href="#transition">Transition</a>
<ul>
<li><a href="#mutabletransitionstate-设置初始状态">MutableTransitionState 设置初始状态</a></li>
</ul></li>
<li><a href="#动画预览">动画预览</a></li>
<li><a href="#rememberinfinitetransition">rememberInfiniteTransition</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      

<h2 id="前言">前言</h2>

<p>在上两篇文章中，我们了解了 Compose 中动画的各种 animationSpec 的使用和 anim.xxx 的方法参数使用说明，这节开始学习 Transition 的使用</p>

<h2 id="transition">Transition</h2>

<blockquote>
<p>可对多个属性值进行动画</p>
</blockquote>

<p>在 Android 原生中,  Transition  动画是用来做 activity 或 Fragment 的转场动画的, 因为 Activity 或 Fragment 是比 View 更外层的，是不能使用 View 的动画, 所以单独使用了 Transition 来做转场动画的, 而在 compose 中, 他和 Activity 和 Fragment 都没有关系, 它只属于 compose 的转场动画</p>

<p>我们先通过一个例子来看看他是如何使用的, 后面再讲讲具体的源码的一些细节</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="n">@Composable</span>
<span class="k">fun</span> <span class="nf">TransitionAnim</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">var</span> <span class="py">big</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="k">false</span><span class="p">)</span> <span class="p">}</span>

    <span class="k">val</span> <span class="py">scaleTransition</span> <span class="p">=</span> <span class="n">updateTransition</span><span class="p">(</span><span class="n">targetState</span> <span class="p">=</span> <span class="n">big</span><span class="p">,</span> <span class="n">label</span> <span class="p">=</span> <span class="s">&#34;scaleTransition&#34;</span><span class="p">)</span>

    <span class="cm">/**  animatexxx 有非常多的方法 , 根据状态的设置**/</span>
    <span class="k">val</span> <span class="py">size</span> <span class="k">by</span> <span class="n">scaleTransition</span><span class="p">.</span><span class="n">animateDp</span><span class="p">(</span>
        <span class="n">transitionSpec</span> <span class="p">=</span> <span class="p">{</span> <span class="n">tween</span><span class="p">(</span><span class="n">durationMillis</span> <span class="p">=</span> <span class="m">2000</span><span class="p">)</span> <span class="p">},</span> <span class="n">label</span> <span class="p">=</span> <span class="s">&#34;size&#34;</span>
    <span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="m">200.</span><span class="n">dp</span> <span class="k">else</span> <span class="m">100.</span><span class="n">dp</span> <span class="p">}</span>

    <span class="k">val</span> <span class="py">corner</span> <span class="k">by</span> <span class="n">scaleTransition</span><span class="p">.</span><span class="n">animateDp</span><span class="p">(</span>
        <span class="n">transitionSpec</span> <span class="p">=</span> <span class="p">{</span> <span class="n">tween</span><span class="p">(</span><span class="n">durationMillis</span> <span class="p">=</span> <span class="m">2000</span><span class="p">)</span> <span class="p">},</span> <span class="n">label</span> <span class="p">=</span> <span class="s">&#34;corner&#34;</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="m">100.</span><span class="n">dp</span> <span class="k">else</span> <span class="m">0.</span><span class="n">dp</span>
    <span class="p">}</span>

    <span class="cm">/**
</span><span class="cm">     * transitionSpec -&gt;  Segment 分段的意思，可以设置分段的动画
</span><span class="cm">     */</span>
    <span class="k">val</span> <span class="py">color</span> <span class="k">by</span> <span class="n">scaleTransition</span><span class="p">.</span><span class="n">animateColor</span><span class="p">(</span>
        <span class="n">transitionSpec</span> <span class="p">=</span> <span class="p">{</span>
            <span class="k">when</span> <span class="p">{</span>
                <span class="cm">/** 初始状态从 false 转换到 true 的目标状态（这里仅仅使用 Boolan 类型，实际情况可以是任意类型的） **/</span>
                <span class="cm">/** 设置 false 到  true  的颜色 tween 渐变 **/</span>
                <span class="k">false</span> <span class="n">isTransitioningTo</span> <span class="k">true</span> <span class="p">-&gt;</span> <span class="n">tween</span><span class="p">(</span><span class="n">durationMillis</span> <span class="p">=</span> <span class="m">3000</span><span class="p">)</span>
                <span class="k">else</span> <span class="p">-&gt;</span> <span class="n">tween</span><span class="p">(</span><span class="n">durationMillis</span> <span class="p">=</span> <span class="m">3000</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">},</span> <span class="n">label</span> <span class="p">=</span> <span class="s">&#34;color&#34;</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="n">Color</span><span class="p">.</span><span class="n">Red</span> <span class="k">else</span> <span class="n">Color</span><span class="p">.</span><span class="n">Green</span>
    <span class="p">}</span>

    <span class="n">Box</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
        <span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="p">.</span><span class="n">clip</span><span class="p">(</span><span class="n">RoundedCornerShape</span><span class="p">(</span><span class="n">corner</span><span class="p">))</span>
        <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
        <span class="p">.</span><span class="n">clickable</span> <span class="p">{</span>
            <span class="n">big</span> <span class="p">=</span> <span class="p">!</span><span class="n">big</span>
        <span class="p">})</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>这段代码的意思是通过 updateTransition 创建了一个 Transition 动画, 并且设置的初始状态是一个 Boolean 的变量为 false, 通过触发点击事件改变这个 Boolean 类型的 big 状态, 从而改变 size , color, corner 属性, 而他们的改变又是通过 Transition.animateXXX 去改变的, 最终开启转场动画, 最终这个动画的效果是这样的</p>

<p><img src="https://raw.githubusercontent.com/midFang/imgSource/main/202312262142988.gif" alt="" /></p>

<p>我们先看看  Transition 是如何通过 updateTransition 创建的，看看源码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="k">fun</span> &lt;T&gt; <span class="nf">updateTransition</span><span class="p">(</span>
    <span class="n">targetState</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span>
    <span class="n">label</span><span class="p">:</span> <span class="n">String</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
<span class="p">):</span> <span class="n">Transition</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="k">val</span> <span class="py">transition</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">Transition</span><span class="p">(</span><span class="n">targetState</span><span class="p">,</span> <span class="n">label</span> <span class="p">=</span> <span class="n">label</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">transition</span><span class="p">.</span><span class="n">animateTo</span><span class="p">(</span><span class="n">targetState</span><span class="p">)</span>
    <span class="n">DisposableEffect</span><span class="p">(</span><span class="n">transition</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">onDispose</span> <span class="p">{</span>
            <span class="c1">// Clean up on the way out, to ensure the observers are not stuck in an in-between
</span><span class="c1"></span>            <span class="c1">// state.
</span><span class="c1"></span>            <span class="n">transition</span><span class="p">.</span><span class="n">onTransitionEnd</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">transition</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>第一个参数是泛型状态的初始状态, 意味着可以传递任意类型, Boolean 或者枚举, 又或者是其他的各种状态, 第二个参数是 label 参数, 这个参数可以认为给这个动画起的一个名称,  后面会再介绍他在哪里具体使用场景</p>

<p>后面使用了 remember 包裹并创建了 Transition 对象, 再看看 Transition 内部</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="k">class</span> <span class="nc">Transition</span><span class="p">&lt;</span><span class="n">S</span><span class="p">&gt;</span> <span class="n">@PublishedApi</span> <span class="k">internal</span> <span class="k">constructor</span><span class="p">(</span>
    <span class="k">private</span> <span class="k">val</span> <span class="py">transitionState</span><span class="p">:</span> <span class="n">MutableTransitionState</span><span class="p">&lt;</span><span class="n">S</span><span class="p">&gt;,</span>
    <span class="k">val</span> <span class="py">label</span><span class="p">:</span> <span class="n">String</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="k">internal</span> <span class="k">constructor</span><span class="p">(</span>
        <span class="n">initialState</span><span class="p">:</span> <span class="n">S</span><span class="p">,</span>
        <span class="n">label</span><span class="p">:</span> <span class="n">String</span><span class="p">?</span>
    <span class="p">)</span> <span class="p">:</span> <span class="k">this</span><span class="p">(</span><span class="n">MutableTransitionState</span><span class="p">(</span><span class="n">initialState</span><span class="p">),</span> <span class="n">label</span><span class="p">)</span>
    
	<span class="c1">// 初始状态
</span><span class="c1"></span>    <span class="k">var</span> <span class="py">currentState</span><span class="p">:</span> <span class="n">S</span>
        <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">transitionState</span><span class="p">.</span><span class="n">currentState</span>
        <span class="k">internal</span> <span class="k">set</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">transitionState</span><span class="p">.</span><span class="n">currentState</span> <span class="p">=</span> <span class="n">value</span>
    <span class="c1">// 目标状态   
</span><span class="c1"></span>    <span class="k">var</span> <span class="py">targetState</span><span class="p">:</span> <span class="n">S</span> <span class="k">by</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">currentState</span><span class="p">)</span>
        <span class="k">internal</span> <span class="k">set</span>

    <span class="cm">/**从初始状态到目标状态的转换
</span><span class="cm">     * [segment] contains the initial state and the target state of the currently on-going
</span><span class="cm">     * transition.
</span><span class="cm">     */</span>
    <span class="k">var</span> <span class="py">segment</span><span class="p">:</span> <span class="n">Segment</span><span class="p">&lt;</span><span class="n">S</span><span class="p">&gt;</span> <span class="k">by</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">SegmentImpl</span><span class="p">(</span><span class="n">currentState</span><span class="p">,</span> <span class="n">currentState</span><span class="p">))</span>
        <span class="k">private</span> <span class="k">set</span>

    <span class="cm">/**
</span><span class="cm">     * Indicates whether there is any animation running in the transition.
</span><span class="cm">     */</span>
    <span class="k">val</span> <span class="py">isRunning</span><span class="p">:</span> <span class="n">Boolean</span>
        <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">startTimeNanos</span> <span class="p">!=</span> <span class="n">AnimationConstants</span><span class="p">.</span><span class="n">UnspecifiedTime</span></code></pre></td></tr></table>
</div>
</div>
<p>Transition 中，它的内部属性维护了一些初始状态和目标状态，和动画是否正在运行等，然后我们传递进来的参数又通过他的构造函数, 又使用 MutableTransitionState 对象进行了包裹一层, 而他的内部, 也维护了一些状态</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="k">class</span> <span class="nc">MutableTransitionState</span><span class="p">&lt;</span><span class="n">S</span><span class="p">&gt;(</span><span class="n">initialState</span><span class="p">:</span> <span class="n">S</span><span class="p">)</span> <span class="p">{</span>
   <span class="c1">// 初始状态
</span><span class="c1"></span>    <span class="k">var</span> <span class="py">currentState</span><span class="p">:</span> <span class="n">S</span> <span class="k">by</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">initialState</span><span class="p">)</span>
        <span class="k">internal</span> <span class="k">set</span>
	<span class="c1">// 目标状态
</span><span class="c1"></span>    <span class="k">var</span> <span class="py">targetState</span><span class="p">:</span> <span class="n">S</span> <span class="k">by</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">initialState</span><span class="p">)</span>
    
    <span class="k">val</span> <span class="py">isIdle</span><span class="p">:</span> <span class="n">Boolean</span> <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="p">(</span><span class="n">currentState</span> <span class="p">==</span> <span class="n">targetState</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">isRunning</span>
    <span class="k">internal</span> <span class="k">var</span> <span class="py">isRunning</span><span class="p">:</span> <span class="n">Boolean</span> <span class="k">by</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="k">false</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>updateTransition 基本介绍完了, 它这里仅仅是瞄准的是状态, 因为我们传递进来的参数就是状态，但是值又是哪里改变的呢 ？</p>

<p>值的改变其实是在 animatexxx 方法中, 这样的方法有很多, 大概有这些</p>

<p><img src="https://raw.githubusercontent.com/midFang/imgSource/main/202312262209568.png" alt="" /></p>

<p>我们选一个 color 配置的看看 animateColor 动画，源码如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="n">@Composable</span>
<span class="k">inline</span> <span class="k">fun</span> &lt;S&gt; <span class="nf">Transition</span><span class="p">&lt;</span><span class="n">S</span><span class="p">&gt;.</span><span class="n">animateColor</span><span class="p">(</span>
    <span class="k">noinline</span> <span class="n">transitionSpec</span><span class="p">:</span>
    <span class="n">@Composable</span> <span class="n">Transition</span><span class="p">.</span><span class="n">Segment</span><span class="p">&lt;</span><span class="n">S</span><span class="p">&gt;.()</span> <span class="p">-&gt;</span> <span class="n">FiniteAnimationSpec</span><span class="p">&lt;</span><span class="n">Color</span><span class="p">&gt;</span> <span class="p">=</span> <span class="p">{</span> <span class="n">spring</span><span class="p">()</span> <span class="p">},</span>
    <span class="n">label</span><span class="p">:</span> <span class="n">String</span> <span class="p">=</span> <span class="s">&#34;ColorAnimation&#34;</span><span class="p">,</span>
    <span class="n">targetValueByState</span><span class="p">:</span> <span class="n">@Composable</span><span class="p">()</span> <span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">S</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Color</span>
<span class="p">):</span> <span class="n">State</span><span class="p">&lt;</span><span class="n">Color</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="k">val</span> <span class="py">colorSpace</span> <span class="p">=</span> <span class="n">targetValueByState</span><span class="p">(</span><span class="n">targetState</span><span class="p">).</span><span class="n">colorSpace</span>
    <span class="k">val</span> <span class="py">typeConverter</span> <span class="p">=</span> <span class="n">remember</span><span class="p">(</span><span class="n">colorSpace</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Color</span><span class="p">.</span><span class="n">VectorConverter</span><span class="p">(</span><span class="n">colorSpace</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">animateValue</span><span class="p">(</span><span class="n">typeConverter</span><span class="p">,</span> <span class="n">transitionSpec</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">targetValueByState</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>第一个参数 transitionSpec 是配置转场动画的, 默认返回 spring 弹簧动画, 返回的类型是 FiniteAnimationSpec, 关于 FiniteAnimationSpec 我们之前的文章有讲到过，通过它的类的继承结构，它可以使用如下这些 Spec</p>

<p><img src="https://raw.githubusercontent.com/midFang/imgSource/main/202312262219729.png" alt="" /></p>

<p>还有一个需要注意的是, 这个 transitionSpec 属性有一个上下文环境 Transition.Segment , 他可以认为是动画的一个段落，他的内部维护了初始状态和目标状态，我们可以看下它是怎么创建的，在 animateColor 源码中，将 transitionSpec 传入到了 animateValue 方法中</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="k">inline</span> <span class="k">fun</span> &lt;S, T, V : AnimationVector&gt; <span class="nf">Transition</span><span class="p">&lt;</span><span class="n">S</span><span class="p">&gt;.</span><span class="n">animateValue</span><span class="p">(</span>
    <span class="n">typeConverter</span><span class="p">:</span> <span class="n">TwoWayConverter</span><span class="p">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">V</span><span class="p">&gt;,</span>
    <span class="k">noinline</span> <span class="n">transitionSpec</span><span class="p">:</span> <span class="n">@Composable</span> <span class="n">Transition</span><span class="p">.</span><span class="n">Segment</span><span class="p">&lt;</span><span class="n">S</span><span class="p">&gt;.()</span> <span class="p">-&gt;</span> <span class="n">FiniteAnimationSpec</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">=</span>
        <span class="p">{</span> <span class="n">spring</span><span class="p">()</span> <span class="p">},</span>
    <span class="n">label</span><span class="p">:</span> <span class="n">String</span> <span class="p">=</span> <span class="s">&#34;ValueAnimation&#34;</span><span class="p">,</span>
    <span class="n">targetValueByState</span><span class="p">:</span> <span class="n">@Composable</span> <span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">S</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">T</span>
<span class="p">):</span> <span class="n">State</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">{</span>

    <span class="k">val</span> <span class="py">initialValue</span> <span class="p">=</span> <span class="n">targetValueByState</span><span class="p">(</span><span class="n">currentState</span><span class="p">)</span> <span class="c1">// 初始状态
</span><span class="c1"></span>    <span class="k">val</span> <span class="py">targetValue</span> <span class="p">=</span> <span class="n">targetValueByState</span><span class="p">(</span><span class="n">targetState</span><span class="p">)</span> <span class="c1">// 目标状态
</span><span class="c1"></span>    <span class="k">val</span> <span class="py">animationSpec</span> <span class="p">=</span> <span class="n">transitionSpec</span><span class="p">(</span><span class="n">segment</span><span class="p">)</span> <span class="c1">// 创建了 animationSpec 对象
</span><span class="c1"></span>
    <span class="k">return</span> <span class="n">createTransitionAnimation</span><span class="p">(</span><span class="n">initialValue</span><span class="p">,</span> <span class="n">targetValue</span><span class="p">,</span> <span class="n">animationSpec</span><span class="p">,</span> <span class="n">typeConverter</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>这里可以看到通过 targetValueByState 创建了一个初始状态和目标状态值，而这里对应例子的代码也就是，初始状态是  Color.Red，目标状态是 Color.Green 然后，将这个值都存储在了 segment 变量中，而 segment 传入到 transitionSpec 表达式中做上下文对象，看看 segment 对象是如何存储的，代码如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="k">var</span> <span class="py">segment</span><span class="p">:</span> <span class="n">Segment</span><span class="p">&lt;</span><span class="n">S</span><span class="p">&gt;</span> <span class="k">by</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">SegmentImpl</span><span class="p">(</span><span class="n">currentState</span><span class="p">,</span> <span class="n">currentState</span><span class="p">))</span>  </code></pre></td></tr></table>
</div>
</div>
<p>这里一个疑问，那就是它不是把动画分成一部分的段落吗，那他是决定那个段落运行的是那段代码呢 ？也就是执行那个动画呢，其实是在 updateTransition 中的 animateTo 中，先看看</p>

<p>updateTransition 中 animateTo 的方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="k">internal</span> <span class="k">fun</span> <span class="nf">animateTo</span><span class="p">(</span><span class="n">targetState</span><span class="p">:</span> <span class="n">S</span><span class="p">)</span> <span class="p">{</span>
  	<span class="k">if</span> <span class="p">(!</span><span class="n">isSeeking</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">updateTarget</span><span class="p">(</span><span class="n">targetState</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>接着再看看 updateTarget 方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin">    <span class="k">internal</span> <span class="k">fun</span> <span class="nf">updateTarget</span><span class="p">(</span><span class="n">targetState</span><span class="p">:</span> <span class="n">S</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">isSeeking</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">targetState</span> <span class="p">!=</span> <span class="n">targetState</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// Starting state should be the &#34;next&#34; state when waypoints are impl&#39;ed
</span><span class="c1"></span>                <span class="n">segment</span> <span class="p">=</span> <span class="n">SegmentImpl</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">targetState</span><span class="p">,</span> <span class="n">targetState</span><span class="p">)</span> <span class="c1">// 设置状态值和目标值
</span><span class="c1"></span>                <span class="n">currentState</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">targetState</span> <span class="c1">// 上一次目前状态设置为当前的初始状态， 也就是动画这一刻的状态就是初始状态
</span><span class="c1"></span>                <span class="k">this</span><span class="p">.</span><span class="n">targetState</span> <span class="p">=</span> <span class="n">targetState</span> <span class="c1">// 设置目标状态
</span><span class="c1"></span>                <span class="k">if</span> <span class="p">(!</span><span class="n">isRunning</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">updateChildrenNeeded</span> <span class="p">=</span> <span class="k">true</span>
                <span class="p">}</span>
                
                <span class="n">_animations</span><span class="p">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">resetAnimation</span><span class="p">()</span> <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>所以这里的整体逻辑就是当我们的 big 状态值发生改变的时候，最终会调用到 updateTransition 方法，最终调用 animateTo 方法，然后内部设置初始值和状态值的改变，也就是 segment 改变，最终回到例子中我们配置的 transitionSpec 是这样的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="cm">/** 初始状态从 false 转换到 true 的目标状态（现实场景中，可能是一个枚举常亮） **/</span>
<span class="cm">/** 设置 false 到  true  的颜色 tween 渐变 **/</span>
<span class="k">false</span> <span class="n">isTransitioningTo</span> <span class="k">true</span> <span class="p">-&gt;</span> <span class="n">tween</span><span class="p">(</span><span class="n">durationMillis</span> <span class="p">=</span> <span class="m">2000</span><span class="p">)</span>
<span class="k">else</span> <span class="p">-&gt;</span> <span class="n">tween</span><span class="p">(</span><span class="n">durationMillis</span> <span class="p">=</span> <span class="m">3000</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>所以从目标状态 false 到 true 状态转变的时候，使用的 tween(durationMillis = 2000) 动画，而 true 到 false 的情况使用的就是 tween(durationMillis = 3000) 动画</p>

<p>最后看下 isTransitioningTo 方法是什么</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin">  <span class="k">infix</span> <span class="k">fun</span> <span class="nf">S</span><span class="p">.</span><span class="n">isTransitioningTo</span><span class="p">(</span><span class="n">targetState</span><span class="p">:</span> <span class="n">S</span><span class="p">):</span> <span class="n">Boolean</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span> <span class="p">==</span> <span class="n">initialState</span> <span class="p">&amp;&amp;</span> <span class="n">targetState</span> <span class="p">==</span> <span class="k">this</span><span class="n">@Segment</span><span class="p">.</span><span class="n">targetState</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>方法也比较简单，他是一个中缀函数，这段代码也等价于 <code>false == this.initialState &amp;&amp; true == this.targetState</code>表示一个状态转换为另外一个状态，是否匹配</p>

<p>第二个参数可以认为是一个名称, 第三个参数 targetValueByState 是根据状态返回目标值, 上面的 color 配置的动画, if (it) Color.Red else Color.Green, 那么就是 true 状态返回红色, false 返回绿色</p>

<h3 id="mutabletransitionstate-设置初始状态">MutableTransitionState 设置初始状态</h3>

<blockquote>
<p>代码进入组合阶段后立即开始播放动画</p>
</blockquote>

<p>通过上面的分析我们都知道，在 Transition 创建的时候，我们传入的初始状态，最终会被传入到 MutableTransitionState 对象中，而上面例子的我们是直接传入的一个初始状态，但是现在我的需求变化了，我需要手动设置初始状态和目标状态，那么就可以使用 MutableTransitionState 对象，他允许我们在代码进入组合阶段后立即开始播放动画，能够在创建对象的时候，显示的设置初始状态和目标状态，他是这么使用的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="k">var</span> <span class="py">currentState</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">MutableTransitionState</span><span class="p">(</span><span class="n">initialState</span><span class="p">)</span> <span class="p">}</span> <span class="c1">// 设置初始状态
</span><span class="c1"></span><span class="n">currentState</span><span class="p">.</span><span class="n">targetState</span> <span class="p">=</span> <span class="n">targetState</span> 
<span class="k">val</span> <span class="py">transition</span> <span class="p">=</span> <span class="n">updateTransition</span><span class="p">(</span><span class="n">currentState</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>改造一下上面的例子, 界面在刚进入组合阶段就开启动画</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="n">@Preview</span>
<span class="n">@Composable</span>
<span class="k">fun</span> <span class="nf">TransitionAnim2</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">var</span> <span class="py">big</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span>
        <span class="n">MutableTransitionState</span><span class="p">(</span><span class="k">true</span><span class="p">).</span><span class="n">apply</span> <span class="p">{</span>
            <span class="c1">// 设置状态 true 到 false 的转变
</span><span class="c1"></span>            <span class="n">targetState</span> <span class="p">=</span> <span class="k">false</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">val</span> <span class="py">scaleTransition</span> <span class="p">=</span> <span class="n">updateTransition</span><span class="p">(</span><span class="n">transitionState</span> <span class="p">=</span> <span class="n">big</span><span class="p">,</span> <span class="n">label</span> <span class="p">=</span> <span class="s">&#34;scaleTransition&#34;</span><span class="p">)</span>

    <span class="k">val</span> <span class="py">size</span> <span class="k">by</span> <span class="n">scaleTransition</span><span class="p">.</span><span class="n">animateDp</span><span class="p">(</span>
        <span class="n">transitionSpec</span> <span class="p">=</span> <span class="p">{</span> <span class="n">tween</span><span class="p">(</span><span class="n">durationMillis</span> <span class="p">=</span> <span class="m">2000</span><span class="p">)</span> <span class="p">},</span> <span class="n">label</span> <span class="p">=</span> <span class="s">&#34;size&#34;</span>
    <span class="p">)</span> <span class="p">{</span>    <span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="m">200.</span><span class="n">dp</span> <span class="k">else</span> <span class="m">100.</span><span class="n">dp</span> <span class="p">}</span>

    <span class="k">val</span> <span class="py">corner</span> <span class="k">by</span> <span class="n">scaleTransition</span><span class="p">.</span><span class="n">animateDp</span><span class="p">(</span>
        <span class="n">transitionSpec</span> <span class="p">=</span> <span class="p">{</span> <span class="n">tween</span><span class="p">(</span><span class="n">durationMillis</span> <span class="p">=</span> <span class="m">2000</span><span class="p">)</span> <span class="p">},</span> <span class="n">label</span> <span class="p">=</span> <span class="s">&#34;corner&#34;</span>
    <span class="p">)</span> <span class="p">{</span>        <span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="m">100.</span><span class="n">dp</span> <span class="k">else</span> <span class="m">0.</span><span class="n">dp</span>    <span class="p">}</span>

    <span class="k">val</span> <span class="py">color</span> <span class="k">by</span> <span class="n">scaleTransition</span><span class="p">.</span><span class="n">animateColor</span><span class="p">(</span>
        <span class="n">transitionSpec</span> <span class="p">=</span> <span class="p">{</span> <span class="n">tween</span><span class="p">(</span><span class="m">2000</span><span class="p">)</span> <span class="p">},</span> <span class="n">label</span> <span class="p">=</span> <span class="s">&#34;color&#34;</span>
    <span class="p">)</span> <span class="p">{</span>        <span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="n">Color</span><span class="p">.</span><span class="n">Red</span> <span class="k">else</span> <span class="n">Color</span><span class="p">.</span><span class="n">Green</span>    <span class="p">}</span>

    <span class="n">Box</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
        <span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="p">.</span><span class="n">clip</span><span class="p">(</span><span class="n">RoundedCornerShape</span><span class="p">(</span><span class="n">corner</span><span class="p">))</span>
        <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
        <span class="p">.</span><span class="n">clickable</span> <span class="p">{</span>            <span class="n">big</span><span class="p">.</span><span class="n">targetState</span> <span class="p">=</span> <span class="p">!</span><span class="n">big</span><span class="p">.</span><span class="n">targetState</span>        <span class="p">})</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>代码基本一致, 只是手动设置了初始状态和目标状态(红色往绿色的渐变动画), 在刚进入界面的时候就开启动画了, 运行代码效果如下</p>

<p><img src="https://raw.githubusercontent.com/midFang/imgSource/main/202312311103992.gif" alt="" /></p>

<p>Transition 动画基本就介绍完成了，仔细观察上面的动画，我们是不是也可以使用 animationxxAsStatus 同样可以做到，也就是需要创建 3 个 asStatus 对象，类似于这样</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="k">val</span> <span class="py">size</span> <span class="k">by</span> <span class="n">animateXXAsState</span><span class="p">()</span>
<span class="k">val</span> <span class="py">corner</span> <span class="k">by</span> <span class="n">animateXXAsState</span><span class="p">()</span>
<span class="k">val</span> <span class="py">color</span> <span class="k">by</span> <span class="n">animateXXAsState</span><span class="p">()</span></code></pre></td></tr></table>
</div>
</div>
<p>这样确实也是可以做到的，就是会比较麻烦，需要改变3 个状态值来做动画效果，而 Transition 不一样，它可以认为将状态统一提升了，视角变得更高了，针对 Transition 的状态来统一对多个属性做动画效果</p>

<h2 id="动画预览">动画预览</h2>

<p>还记得我们上面设置的 label 吗，他就是我们预览的时候，可以看到设置的一个名称，这样预览动画的时候，比较方便，如图，点击 start preview 就可以进入预览模式</p>

<p><img src="https://raw.githubusercontent.com/midFang/imgSource/main/202312302222018.png" alt="" /></p>

<p>进入预览模式后，左下角的操控面板就可以看到我们设置的 label 值，和状态值，过多的就不介绍了，这个面板调试动画还是很方便的</p>

<p><img src="https://raw.githubusercontent.com/midFang/imgSource/main/202312302223149.png" alt="" /></p>

<h2 id="rememberinfinitetransition">rememberInfiniteTransition</h2>

<blockquote>
<p>可对多个属性值进行无线循环的动画</p>
</blockquote>

<p>这个动画比较简单，直接上代码看看效果</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="n">@Composable</span>
<span class="k">fun</span> <span class="nf">RepeatAnim</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">val</span> <span class="py">infiniteTransition</span> <span class="p">=</span> <span class="n">rememberInfiniteTransition</span><span class="p">(</span><span class="n">label</span> <span class="p">=</span> <span class="s">&#34;&#34;</span><span class="p">)</span>
    <span class="k">val</span> <span class="py">color</span> <span class="k">by</span> <span class="n">infiniteTransition</span><span class="p">.</span><span class="n">animateColor</span><span class="p">(</span>
        <span class="n">initialValue</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">Red</span><span class="p">,</span>
        <span class="n">targetValue</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">Green</span><span class="p">,</span>
        <span class="n">animationSpec</span> <span class="p">=</span> <span class="n">infiniteRepeatable</span><span class="p">(</span>
            <span class="n">animation</span> <span class="p">=</span> <span class="n">tween</span><span class="p">(</span><span class="m">1000</span><span class="p">,</span> <span class="n">easing</span> <span class="p">=</span> <span class="n">LinearEasing</span><span class="p">),</span>
            <span class="n">repeatMode</span> <span class="p">=</span> <span class="n">RepeatMode</span><span class="p">.</span><span class="n">Reverse</span>
        <span class="p">),</span> <span class="n">label</span> <span class="p">=</span> <span class="s">&#34;&#34;</span>
    <span class="p">)</span>
    
    <span class="c1">// infiniteTransition.animateDp() ...
</span><span class="c1"></span>
    <span class="n">Box</span><span class="p">(</span>
        <span class="n">Modifier</span>
            <span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
            <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>这个代码使用 rememberInfiniteTransition 创建了 infiniteTransition 对象，其中 rememberInfiniteTransition 并没有什么参数可以配置的， 接着调用了 animateColor 方法，他能配置的参数基本都写出来的，第一个参数是初始状态为红色，第二个参数是目标状态是绿色，所以他是一个红色转为绿色的一个动画第三个参数是 animationSpec ，这个参数返回的是一个 InfiniteRepeatableSpec 对象，目前这个参数只有一个 <em>infiniteRepeatable</em> 的实现，他是一个无限循环动画，他的第一个参数是 animation，返回的对象是 DurationBasedAnimationSpec ，这个是基于时间设置的动画，我在基础篇动画的时候讲过，repeatMode 是重复模式, start, 从起始位置开始重复, Reverse 从目标值开始重复，这个以前也讲过了，所有的配置基本都在这里了</p>

<p>最终它的效果是这样的</p>

<p><img src="https://raw.githubusercontent.com/midFang/imgSource/main/202312262308207.gif" alt="" /></p>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">midFang</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
      2023-06-11
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://midFang.github.io/tags/android/">Android</a>
          <a href="https://midFang.github.io/tags/%E5%8A%A8%E7%94%BB/">动画</a>
          <a href="https://midFang.github.io/tags/compose/">Compose</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/compose-animation-final-chapter-advanced-chapter/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">Compose 动画终章进阶篇</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/compose-animatedecay/">
            <span class="next-text nav-default">Compose之衰减型动画</span>
            <span class="prev-text nav-mobile">Next</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "midFang/blog-comments"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="https://github.com/midFang" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="https://stackoverflow.com/users/14331888/midfang" rel="me noopener" class="iconfont"
      title="stack-overflow"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M809.714286 932.571429l-638.857143 0 0-274.285714-91.428571 0 0 365.714286 821.714286 0 0-365.714286-91.428571 0 0 274.285714zm-538.285714-299.428571l18.857143-89.714286 447.428571 94.285714-18.857143 89.142857zm58.857143-213.714286l38.285714-83.428571 414.285714 193.714286-38.285714 82.857143zm114.857143-203.428571l58.285714-70.285714 350.857143 293.142857-58.285714 70.285714zm226.857143-216l272.571429 366.285714-73.142857 54.857143-272.571429-366.285714zm-410.285714 840.571429l0-90.857143 457.142857 0 0 90.857143-457.142857 0z"></path>
</svg>

    </a>
  
    <a href="https://www.douban.com/people/194654920/" rel="me noopener" class="iconfont"
      title="douban"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M926.917973 37.80608C959.65184 37.80608 986.19392 64.34816 986.19392 97.082027L986.19392 926.917973C986.19392 959.65184 959.65184 986.19392 926.917973 986.19392L97.082027 986.19392C64.34816 986.19392 37.80608 959.65184 37.80608 926.917973L37.80608 97.082027C37.80608 64.34816 64.34816 37.80608 97.082027 37.80608zM176.653653 176.19968 176.653653 252.678827 825.658027 252.678827 825.658027 176.19968zM217.719467 316.146347 217.719467 628.08064 273.524053 628.08064 341.292373 770.39616 157.259093 770.39616 157.259093 845.417813 842.949973 845.417813 842.949973 770.39616 654.226773 770.39616 722.899627 628.08064 783.67744 628.08064 783.67744 316.146347zM684.885333 392.891733 684.885333 553.987413 312.576 553.987413 312.576 392.891733zM570.770773 770.39616 426.653013 770.39616 359.621973 628.08064 639.443627 628.08064z"></path>
</svg>

    </a>


<a href="https://midFang.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2020 -
    2024
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        midFang
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>















  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script type="text/javascript">
    AV.initialize( null ,  null );
  </script>

  <script>
    function showHitCount(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push($(this).attr("id").trim());
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var hits = item.get('hits');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(hits);
          }
          for (var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if (countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function (results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("hits");
            counter.save(null, {
              success: function (counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('hits'));
              },
              error: function (counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
             
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
             
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("hits", 1);
            newcounter.save(null, {
              success: function (newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('hits'));
              },
              error: function (newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function (error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function () {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        
        addCount(Counter);
      } else if ($('.post-link').length > 1) {
        
        showHitCount(Counter);
      }
    });
  </script>





  <script>
    $("#openSearch, #openSearchMobile").click(function(){
      $(".modal-dialog").addClass("visible");
    });

    $("#closeSearch").click(function(){
      $(".modal-dialog").removeClass("visible");
    });

    $(document).click(function(event) {
    
      if (!$(event.target).closest(".modal-content, #openSearch, #openSearchMobile").length) {
        $("body").find(".modal-dialog").removeClass("visible");
      }
    });
  </script>





</body>
</html>
