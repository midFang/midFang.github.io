<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>OkHttp 源码分析及网络优化 - midFang&#39;s Blog</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="midFang" />
  <meta name="description" content="使用 OKHttp 是作为 Android 开发人员使用最多的网络库之一， 接下来从最基础的使用来介绍 OkHttp 源码里面是如何工作的。
首先需要添加OKHttp的依赖
1  implementation &amp;#39;com.squareup.okhttp3:okhttp:3.5.0&amp;#39;   " />

  <meta name="keywords" content="Hugo, theme, jane" />






<meta name="generator" content="Hugo 0.58.3" />


<link rel="canonical" href="https://midFang.github.io/okhttp-source-code-analysis/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.af20b78e95c84de86b00a0242a4a77bd2601700e1b250edf27537d957ac0041d.css" integrity="sha256-ryC3jpXITehrAKAkKkp3vSYBcA4bJQ7fJ1N9lXrABB0=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="OkHttp 源码分析及网络优化" />
<meta property="og:description" content="使用

OKHttp 是作为 Android 开发人员使用最多的网络库之一， 接下来从最基础的使用来介绍 OkHttp 源码里面是如何工作的。

首先需要添加OKHttp的依赖


1


implementation &#39;com.squareup.okhttp3:okhttp:3.5.0&#39; 

" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://midFang.github.io/okhttp-source-code-analysis/" />
<meta property="article:published_time" content="2021-01-28T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-01-28T00:00:00+00:00" />
<meta itemprop="name" content="OkHttp 源码分析及网络优化">
<meta itemprop="description" content="使用

OKHttp 是作为 Android 开发人员使用最多的网络库之一， 接下来从最基础的使用来介绍 OkHttp 源码里面是如何工作的。

首先需要添加OKHttp的依赖


1


implementation &#39;com.squareup.okhttp3:okhttp:3.5.0&#39; 

">


<meta itemprop="datePublished" content="2021-01-28T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2021-01-28T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="5781">



<meta itemprop="keywords" content="Android,源码分析,OKHttp," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="OkHttp 源码分析及网络优化"/>
<meta name="twitter:description" content="使用

OKHttp 是作为 Android 开发人员使用最多的网络库之一， 接下来从最基础的使用来介绍 OkHttp 源码里面是如何工作的。

首先需要添加OKHttp的依赖


1


implementation &#39;com.squareup.okhttp3:okhttp:3.5.0&#39; 

"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">midFang's Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/">首页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/post/">全部文章</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/about/">关于</a>
          
        
      </li>
    

    
      <li class="mobile-menu-item">
        <a id="openSearchMobile" class="mobile-menu-item-link menu-item-search" href="#">
          <i class="iconfont">
            <svg version="1.1" viewBox="0 0 1024 1024"
  xmlns="http://www.w3.org/2000/svg" width="18" height="18"
  xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M973.81454219 973.81454219a91.78207815 91.78207815 0 0 1-129.80999631 0l-161.97482118-161.97482118a425.48527711 425.48527711 0 0 1-230.35931791 68.16531768 428.3346319 428.3346319 0 1 1 428.3346319-428.3346319 425.48527711 425.48527711 0 0 1-68.16531768 230.35931791l162.02961656 161.97482118a91.83687354 91.83687354 0 0 1-0.05479538 129.80999631zM451.67040679 145.69361559a305.97679241 305.97679241 0 1 0 0 611.95358361 305.97679241 305.97679241 0 0 0 0-611.95358361z">
  </path>
</svg>

          </i>
        </a>
      </li>
    
  </ul>
</nav>


  

  
    
<div class="modal-dialog">
    
    <div class="modal-content">
      <div id="closeSearch" title="Close" class="close">X</div>
      <div class="modal-header">
        <div class="modal-title">Search</div>
      </div>
      <div class="modal-body">
          <script>
            (function() {
              var cx = '57787f7f4d21d54fc';
              var gcse = document.createElement('script');
              gcse.type = 'text/javascript';
              gcse.async = true;
              gcse.src = (document.location.protocol == 'https:' ? 'https:' :
                  'http:') +
                '//cse.google.com/cse.js?cx=' + cx;
              var s = document.getElementsByTagName('script')[0];
              s.parentNode.insertBefore(gcse, s);
            })();
          </script>
          <gcse:search></gcse:search>
      </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      midFang's Blog
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/">首页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/post/">全部文章</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/about/">关于</a>
          

        

      </li>
    

    
    

    
      <li class="menu-item">
        <a id="openSearch" class="menu-item-link menu-item-search" href="#">
          <i class="iconfont">
            <svg version="1.1" viewBox="0 0 1024 1024"
  xmlns="http://www.w3.org/2000/svg" width="18" height="18"
  xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M973.81454219 973.81454219a91.78207815 91.78207815 0 0 1-129.80999631 0l-161.97482118-161.97482118a425.48527711 425.48527711 0 0 1-230.35931791 68.16531768 428.3346319 428.3346319 0 1 1 428.3346319-428.3346319 425.48527711 425.48527711 0 0 1-68.16531768 230.35931791l162.02961656 161.97482118a91.83687354 91.83687354 0 0 1-0.05479538 129.80999631zM451.67040679 145.69361559a305.97679241 305.97679241 0 1 0 0 611.95358361 305.97679241 305.97679241 0 0 0 0-611.95358361z">
  </path>
</svg>

          </i>
        </a>
      </li>
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">OkHttp 源码分析及网络优化</h1>
      
      <div class="post-meta">
        <time datetime="2021-01-28" class="post-time">
          2021-01-28
        </time>
        <div class="post-category">
            <a href="https://midFang.github.io/categories/android/"> Android </a>
            <a href="https://midFang.github.io/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"> 源码分析 </a>
            <a href="https://midFang.github.io/categories/okhttp/"> OKHttp </a>
            
          </div>
        

        
        
          <span id="busuanzi_container_page_pv">
            | 阅读 <span id="busuanzi_value_page_pv"></span>
          </span>
        

        
        
          <span id="/okhttp-source-code-analysis/" class="leancloud_visitors" data-flag-title="OkHttp 源码分析及网络优化">
            <span class="post-meta-item-text"> | 阅读 </span>
            <span class="leancloud-visitors-count"></span>
          </span>
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#使用">使用</a>
<ul>
<li><a href="#网络优化">网络优化</a></li>
<li><a href="#总结">总结</a></li>
<li><a href="#使用到的设计模式">使用到的设计模式</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <h2 id="使用">使用</h2>

<p>OKHttp 是作为 Android 开发人员使用最多的网络库之一， 接下来从最基础的使用来介绍 OkHttp 源码里面是如何工作的。</p>

<p>首先需要添加OKHttp的依赖</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">implementation &#39;com.squareup.okhttp3:okhttp:3.5.0&#39; </pre></td></tr></table>
</div>
</div>
<p>使用</p>

<blockquote>
<p>简单介绍基础使用，详细的使用参考官网文档： <a href="https://square.github.io/okhttp/">https://square.github.io/okhttp/</a></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="k">val</span> <span class="py">client</span> <span class="p">=</span> <span class="n">OkHttpClient</span><span class="p">.</span><span class="n">Builder</span><span class="p">()</span>
        <span class="p">.</span><span class="n">build</span><span class="p">()</span>

<span class="k">val</span> <span class="py">request</span> <span class="p">=</span> <span class="n">Request</span><span class="p">.</span><span class="n">Builder</span><span class="p">()</span>
        <span class="p">.</span><span class="n">url</span><span class="p">(</span><span class="s">&#34;https://www.baidu.com/&#34;</span><span class="p">)</span>
        <span class="p">.</span><span class="n">build</span><span class="p">()</span>

<span class="c1">// 直接请求
</span><span class="c1"></span> <span class="k">val</span> <span class="py">response</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="n">newCall</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="p">.</span><span class="n">execute</span><span class="p">()</span>

<span class="c1">// 异步请求
</span><span class="c1"></span><span class="n">client</span><span class="p">.</span><span class="n">newCall</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="p">.</span><span class="n">enqueue</span><span class="p">(</span><span class="k">object</span> <span class="err">: </span><span class="nc">Callback</span> <span class="p">{</span>
            <span class="k">override</span> <span class="k">fun</span> <span class="nf">onFailure</span><span class="p">(</span><span class="n">call</span><span class="p">:</span> <span class="n">Call</span><span class="p">?,</span> <span class="n">e</span><span class="p">:</span> <span class="n">IOException</span><span class="p">?)</span> <span class="p">{</span>
            <span class="p">}</span>

            <span class="k">override</span> <span class="k">fun</span> <span class="nf">onResponse</span><span class="p">(</span><span class="n">call</span><span class="p">:</span> <span class="n">Call</span><span class="p">?,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">?)</span> <span class="p">{</span>
            <span class="p">}</span>
        <span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
<p>从上面的使用中可以看出首先是构建了 OKHttpClient 对象， 然后构建了一个 Request 对象，都是通过 Builder 设计模式来构建的，然后可以通过方法 execute 直接（同步）请求并拿到响应的结果， 也可以通过 enqueue 方法异步请求的方式， 在回调中拿到请求结果。本文主要从这两个方法入手， 参数的构建不做过多的描述。接下来看看  enqueue  是如何实现的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="nd">@Override</span> <span class="kd">public</span> <span class="nf">void</span> <span class="n">enqueue</span><span class="p">(</span><span class="n">Callback</span> <span class="nf">responseCallback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">synchronized</span> <span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">executed</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&#34;Already Executed&#34;</span><span class="p">);</span>
      <span class="n">executed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">captureCallStackTrace</span><span class="p">();</span>
    <span class="n">client</span><span class="p">.</span><span class="na">dispatcher</span><span class="p">().</span><span class="na">enqueue</span><span class="p">(</span><span class="k">new</span> <span class="n">AsyncCall</span><span class="p">(</span><span class="n">responseCallback</span><span class="p">));</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>这里首先是判断了 executed 是否已经执行了，如果这个请求已经执行了，则抛出异常。然后是使用了 client.dispatcher() 对象调用了 enqueue 方法。client.dispatcher() 其实是 Dispatcher 类， 在我们首次构建 OkHttpClient.Builder() 就已经构建出来这个 Dispatcher 对象了。这里可以先说明一下，这个 Dispatcher 其实是用来切线程的，内部维护了一些最大请求数量，和同主机下的请求数量。大致如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">final</span> <span class="kd">class</span> <span class="nf">Dispatcher</span> <span class="p">{</span>
  <span class="c1">// 最大请求数 - 可修改
</span><span class="c1"></span>  <span class="kd">private</span> <span class="nf">int</span> <span class="n">maxRequests</span> <span class="o">=</span> <span class="n">64</span><span class="p">;</span>
  <span class="c1">// 同 host 主机下的请求数 - 可修改
</span><span class="c1"></span>  <span class="kd">private</span> <span class="nf">int</span> <span class="n">maxRequestsPerHost</span> <span class="o">=</span> <span class="n">5</span><span class="p">;</span>

  <span class="c1">// 线程池
</span><span class="c1"></span>  <span class="cm">/** Executes calls. Created lazily. */</span>
  <span class="kd">private</span> <span class="nf">ExecutorService</span> <span class="n">executorService</span><span class="p">;</span>

  <span class="c1">// 准备请求的队列
</span><span class="c1"></span>  <span class="cm">/** Ready async calls in the order they&#39;ll be run. */</span>
  <span class="kd">private</span> <span class="nf">final</span> <span class="n">Deque</span><span class="o">&lt;</span><span class="n">AsyncCall</span><span class="o">&gt;</span> <span class="nf">readyAsyncCalls</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayDeque</span><span class="o">&lt;&gt;</span><span class="p">();</span>

  <span class="c1">// 正在异步请求的队列
</span><span class="c1"></span>  <span class="cm">/** Running asynchronous calls. Includes canceled calls that haven&#39;t finished yet. */</span>
  <span class="kd">private</span> <span class="nf">final</span> <span class="n">Deque</span><span class="o">&lt;</span><span class="n">AsyncCall</span><span class="o">&gt;</span> <span class="nf">runningAsyncCalls</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayDeque</span><span class="o">&lt;&gt;</span><span class="p">();</span>

  <span class="c1">// 正在同步请求的队列
</span><span class="c1"></span>  <span class="cm">/** Running synchronous calls. Includes canceled calls that haven&#39;t finished yet. */</span>
  <span class="kd">private</span> <span class="nf">final</span> <span class="n">Deque</span><span class="o">&lt;</span><span class="n">RealCall</span><span class="o">&gt;</span> <span class="nf">runningSyncCalls</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayDeque</span><span class="o">&lt;&gt;</span><span class="p">();</span>

  <span class="c1">// 创建线程池
</span><span class="c1"></span>  <span class="kd">public</span> <span class="nf">synchronized</span> <span class="n">ExecutorService</span> <span class="nf">executorService</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">executorService</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">executorService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">0</span><span class="p">,</span> <span class="n">Integer</span><span class="p">.</span><span class="na">MAX_VALUE</span><span class="p">,</span> <span class="n">60</span><span class="p">,</span> <span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">,</span>
          <span class="k">new</span> <span class="n">SynchronousQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span><span class="p">(),</span> <span class="n">Util</span><span class="p">.</span><span class="na">threadFactory</span><span class="p">(</span><span class="s">&#34;OkHttp Dispatcher&#34;</span><span class="p">,</span> <span class="kc">false</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">executorService</span><span class="p">;</span>
  <span class="p">}</span>
  
  	<span class="c1">// 异步请求 
</span><span class="c1"></span>  <span class="kd">synchronized</span> <span class="nf">void</span> <span class="n">enqueue</span><span class="p">(</span><span class="n">AsyncCall</span> <span class="nf">call</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">runningAsyncCalls</span><span class="p">.</span><span class="na">size</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">maxRequests</span> <span class="o">&amp;&amp;</span> <span class="n">runningCallsForHost</span><span class="p">(</span><span class="n">call</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">maxRequestsPerHost</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">runningAsyncCalls</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">call</span><span class="p">);</span>
      <span class="n">executorService</span><span class="p">().</span><span class="na">execute</span><span class="p">(</span><span class="n">call</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">readyAsyncCalls</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">call</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="c1">// 同步请求
</span><span class="c1"></span>  <span class="kd">synchronized</span> <span class="nf">void</span> <span class="n">executed</span><span class="p">(</span><span class="n">RealCall</span> <span class="nf">call</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">runningSyncCalls</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">call</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<ul>
<li>Dispatcher 类中比较重要的信息就是这些了，首先是维护了 3 个队列，然后创建了一个包含阻塞队列的线程池 ThreadPoolExecutor，存在 0 个核心线程数量，说明没有被保留的线程，初始状态 0 个线程，也就是所有空闲的线程都会被终止，非核心线程数是最大数，即随时可以创建新的线程来满足需要。线程保活的时间是 60 S</li>
<li>同步请求的情况下会将 call 请求添加到了同步队列中</li>
<li>异步请求做的逻辑是当最大的请求数量小于 maxRequests（64） 和同个主机的正在请求的数量小于 maxRequestsPerHost（5） 则使用线程池继续请求，否则将会将这个请求添加到准备请求队列中</li>
</ul>

<p>那么如果是超过了这个范围就会被添加到 readyAsyncCalls 准备请求队列中，那么它后续这个队列中的请求又是在什么时候继续请求的呢？带着这个问题，稍后再看下</p>

<p>刚才分析的是 client.dispatcher().enqueue(new AsyncCall(responseCallback))  这个方法，目前已经知道是一个线程池，那么 enqueue 方法接受肯定也是一个 Runnable 对象，执行的是 run 方法中的代码，继续看看 AsyncCall 如何实现：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">final</span> <span class="nf">class</span> <span class="n">AsyncCall</span> <span class="nf">extends</span> <span class="n">NamedRunnable</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="nf">final</span> <span class="n">Callback</span> <span class="nf">responseCallback</span><span class="p">;</span>
  
    <span class="nd">@Override</span> <span class="kd">protected</span> <span class="nf">void</span> <span class="n">execute</span><span class="p">()</span> <span class="p">{</span>
      <span class="kt">boolean</span> <span class="nf">signalledCallback</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="n">Response</span> <span class="nf">response</span> <span class="o">=</span> <span class="n">getResponseWithInterceptorChain</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">retryAndFollowUpInterceptor</span><span class="p">.</span><span class="na">isCanceled</span><span class="p">())</span> <span class="p">{</span>
          <span class="n">signalledCallback</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="n">responseCallback</span><span class="p">.</span><span class="na">onFailure</span><span class="p">(</span><span class="n">RealCall</span><span class="p">.</span><span class="na">this</span><span class="p">,</span> <span class="k">new</span> <span class="n">IOException</span><span class="p">(</span><span class="s">&#34;Canceled&#34;</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">signalledCallback</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="n">responseCallback</span><span class="p">.</span><span class="na">onResponse</span><span class="p">(</span><span class="n">RealCall</span><span class="p">.</span><span class="na">this</span><span class="p">,</span> <span class="n">response</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="nf">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">signalledCallback</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// Do not signal the callback twice!
</span><span class="c1"></span>          <span class="n">Platform</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">log</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&#34;Callback failure for &#34;</span> <span class="o">+</span> <span class="n">toLoggableString</span><span class="p">(),</span> <span class="n">e</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">responseCallback</span><span class="p">.</span><span class="na">onFailure</span><span class="p">(</span><span class="n">RealCall</span><span class="p">.</span><span class="na">this</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
        <span class="c1">// 结束的时候调用
</span><span class="c1"></span>        <span class="n">client</span><span class="p">.</span><span class="na">dispatcher</span><span class="p">().</span><span class="na">finished</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>AsyncCall 类继承了 NamedRunnable 类，其中 NamedRunnable 类实现了 Runnable 接口，所以说 execute 就是在 run 方法中执行的。其中 OKHttp 重要的实现部分就是在这个地方了，getResponseWithInterceptorChain 通过拦截器链获取响应的结果，判断是成功还是失败的，通过接口回调到外部，最终 finally 中调用结束的方法。先看下 getResponseWithInterceptorChain 实现：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="n">Response</span> <span class="nf">getResponseWithInterceptorChain</span><span class="p">()</span> <span class="kd">throws</span> <span class="nf">IOException</span> <span class="p">{</span>
    <span class="c1">// Build a full stack of interceptors.
</span><span class="c1"></span>    <span class="n">List</span><span class="o">&lt;</span><span class="n">Interceptor</span><span class="o">&gt;</span> <span class="nf">interceptors</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
    <span class="c1">// 添加自己实现的 拦截器
</span><span class="c1"></span>    <span class="n">interceptors</span><span class="p">.</span><span class="na">addAll</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="na">interceptors</span><span class="p">());</span>
    <span class="c1">// 添加重试拦截器
</span><span class="c1"></span>    <span class="n">interceptors</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">retryAndFollowUpInterceptor</span><span class="p">);</span>
    <span class="c1">// 添加桥接拦截器 // tcp 
</span><span class="c1"></span>    <span class="n">interceptors</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span> <span class="n">BridgeInterceptor</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="na">cookieJar</span><span class="p">()));</span>
    <span class="c1">// 添加缓存拦截器
</span><span class="c1"></span>    <span class="n">interceptors</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span> <span class="n">CacheInterceptor</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="na">internalCache</span><span class="p">()));</span>
    <span class="c1">// 添加连接拦截器
</span><span class="c1"></span>    <span class="n">interceptors</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span> <span class="n">ConnectInterceptor</span><span class="p">(</span><span class="n">client</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">forWebSocket</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 网络拦截器 
</span><span class="c1"></span>      <span class="n">interceptors</span><span class="p">.</span><span class="na">addAll</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="na">networkInterceptors</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="c1">// 请求服务器拦截器
</span><span class="c1"></span>    <span class="n">interceptors</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span> <span class="n">CallServerInterceptor</span><span class="p">(</span><span class="n">forWebSocket</span><span class="p">));</span>

  	<span class="c1">// 将所有拦截器连在一起的形成一条链
</span><span class="c1"></span>    <span class="n">Interceptor</span><span class="p">.</span><span class="na">Chain</span> <span class="nf">chain</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RealInterceptorChain</span><span class="p">(</span>
        <span class="n">interceptors</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="n">0</span><span class="p">,</span> <span class="n">originalRequest</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">chain</span><span class="p">.</span><span class="na">proceed</span><span class="p">(</span><span class="n">originalRequest</span><span class="p">);</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>最终调用 RealInterceptorChain 的 proceed 方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="kd">public</span> <span class="nf">Response</span> <span class="n">proceed</span><span class="p">(</span><span class="n">Request</span> <span class="nf">request</span><span class="p">,</span> <span class="n">StreamAllocation</span> <span class="nf">streamAllocation</span><span class="p">,</span> <span class="n">HttpCodec</span> <span class="nf">httpCodec</span><span class="p">,</span>
      <span class="n">Connection</span> <span class="nf">connection</span><span class="p">)</span> <span class="kd">throws</span> <span class="nf">IOException</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">interceptors</span><span class="p">.</span><span class="na">size</span><span class="p">())</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">AssertionError</span><span class="p">();</span>

    <span class="n">calls</span><span class="o">++</span><span class="p">;</span>

    <span class="c1">// Call the next interceptor in the chain.
</span><span class="c1"></span>    <span class="n">RealInterceptorChain</span> <span class="nf">next</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RealInterceptorChain</span><span class="p">(</span>
        <span class="n">interceptors</span><span class="p">,</span> <span class="n">streamAllocation</span><span class="p">,</span> <span class="n">httpCodec</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">index</span> <span class="o">+</span> <span class="n">1</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
    <span class="n">Interceptor</span> <span class="nf">interceptor</span> <span class="o">=</span> <span class="n">interceptors</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
    
    <span class="n">Response</span> <span class="nf">response</span> <span class="o">=</span> <span class="n">interceptor</span><span class="p">.</span><span class="na">intercept</span><span class="p">(</span><span class="n">next</span><span class="p">);</span>

    <span class="c1">// Confirm that the intercepted response isn&#39;t null.
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">response</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="p">(</span><span class="s">&#34;interceptor &#34;</span> <span class="o">+</span> <span class="n">interceptor</span> <span class="o">+</span> <span class="s">&#34; returned null&#34;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">response</span><span class="p">;</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>假设这里的 interceptors 和 networkInterceptors 拦截器目前我们都没有添加。那么这里获取的第一个拦截器就是 retryAndFollowUpInterceptor 重试拦截器，接着会调用它的 intercept 方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="nd">@Override</span> <span class="kd">public</span> <span class="nf">Response</span> <span class="n">intercept</span><span class="p">(</span><span class="n">Chain</span> <span class="nf">chain</span><span class="p">)</span> <span class="kd">throws</span> <span class="nf">IOException</span> <span class="p">{</span>
    <span class="n">Request</span> <span class="nf">request</span> <span class="o">=</span> <span class="n">chain</span><span class="p">.</span><span class="na">request</span><span class="p">();</span>

    <span class="n">streamAllocation</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StreamAllocation</span><span class="p">(</span>
        <span class="n">client</span><span class="p">.</span><span class="na">connectionPool</span><span class="p">(),</span> <span class="n">createAddress</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">url</span><span class="p">()),</span> <span class="n">callStackTrace</span><span class="p">);</span>

    <span class="kt">int</span> <span class="nf">followUpCount</span> <span class="o">=</span> <span class="n">0</span><span class="p">;</span>
    <span class="n">Response</span> <span class="nf">priorResponse</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">canceled</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">streamAllocation</span><span class="p">.</span><span class="na">release</span><span class="p">();</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">IOException</span><span class="p">(</span><span class="s">&#34;Canceled&#34;</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="n">Response</span> <span class="nf">response</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="kt">boolean</span> <span class="nf">releaseConnection</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="n">response</span> <span class="o">=</span> <span class="p">((</span><span class="n">RealInterceptorChain</span><span class="p">)</span> <span class="n">chain</span><span class="p">).</span><span class="na">proceed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">streamAllocation</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
        <span class="n">releaseConnection</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">RouteException</span> <span class="nf">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// The attempt to connect via a route failed. The request will not have been sent.
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">recover</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">getLastConnectException</span><span class="p">(),</span> <span class="kc">false</span><span class="p">,</span> <span class="n">request</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="n">e</span><span class="p">.</span><span class="na">getLastConnectException</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="n">releaseConnection</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="nf">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// An attempt to communicate with a server failed. The request may have been sent.
</span><span class="c1"></span>        <span class="kt">boolean</span> <span class="nf">requestSendStarted</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">e</span> <span class="nf">instanceof</span> <span class="n">ConnectionShutdownException</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">recover</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">requestSendStarted</span><span class="p">,</span> <span class="n">request</span><span class="p">))</span> <span class="k">throw</span> <span class="n">e</span><span class="p">;</span>
        <span class="n">releaseConnection</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
        <span class="c1">// We&#39;re throwing an unchecked exception. Release any resources.
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">releaseConnection</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">streamAllocation</span><span class="p">.</span><span class="na">streamFailed</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
          <span class="n">streamAllocation</span><span class="p">.</span><span class="na">release</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="c1">// Attach the prior response if it exists. Such responses never have a body.
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">priorResponse</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span>
            <span class="p">.</span><span class="na">priorResponse</span><span class="p">(</span><span class="n">priorResponse</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span>
                    <span class="p">.</span><span class="na">body</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
                    <span class="p">.</span><span class="na">build</span><span class="p">())</span>
            <span class="p">.</span><span class="na">build</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="n">Request</span> <span class="nf">followUp</span> <span class="o">=</span> <span class="n">followUpRequest</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">followUp</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">forWebSocket</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">streamAllocation</span><span class="p">.</span><span class="na">release</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="n">closeQuietly</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">body</span><span class="p">());</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">followUpCount</span> <span class="o">&gt;</span> <span class="n">MAX_FOLLOW_UPS</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">streamAllocation</span><span class="p">.</span><span class="na">release</span><span class="p">();</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">ProtocolException</span><span class="p">(</span><span class="s">&#34;Too many follow-up requests: &#34;</span> <span class="o">+</span> <span class="n">followUpCount</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">followUp</span><span class="p">.</span><span class="na">body</span><span class="p">()</span> <span class="k">instanceof</span> <span class="n">UnrepeatableRequestBody</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">streamAllocation</span><span class="p">.</span><span class="na">release</span><span class="p">();</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">HttpRetryException</span><span class="p">(</span><span class="s">&#34;Cannot retry streamed HTTP body&#34;</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="na">code</span><span class="p">());</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sameConnection</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">followUp</span><span class="p">.</span><span class="na">url</span><span class="p">()))</span> <span class="p">{</span>
        <span class="n">streamAllocation</span><span class="p">.</span><span class="na">release</span><span class="p">();</span>
        <span class="n">streamAllocation</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StreamAllocation</span><span class="p">(</span>
            <span class="n">client</span><span class="p">.</span><span class="na">connectionPool</span><span class="p">(),</span> <span class="n">createAddress</span><span class="p">(</span><span class="n">followUp</span><span class="p">.</span><span class="na">url</span><span class="p">()),</span> <span class="n">callStackTrace</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">streamAllocation</span><span class="p">.</span><span class="na">codec</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&#34;Closing the body of &#34;</span> <span class="o">+</span> <span class="n">response</span>
            <span class="o">+</span> <span class="s">&#34; didn&#39;t close its backing stream. Bad interceptor?&#34;</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="n">request</span> <span class="o">=</span> <span class="n">followUp</span><span class="p">;</span>
      <span class="n">priorResponse</span> <span class="o">=</span> <span class="n">response</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>首先是创建了 StreamAllocation 对象，创建了一个连接池 connectionPool 和 Address 对象，主要做了一些参数的赋值，前期的预备工作，设置 host ，设置端口，设置 dns ，证书，代理等等。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="nf">Address</span> <span class="n">createAddress</span><span class="p">(</span><span class="n">HttpUrl</span> <span class="nf">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">SSLSocketFactory</span> <span class="nf">sslSocketFactory</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="n">HostnameVerifier</span> <span class="nf">hostnameVerifier</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="n">CertificatePinner</span> <span class="nf">certificatePinner</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">url</span><span class="p">.</span><span class="na">isHttps</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">sslSocketFactory</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="na">sslSocketFactory</span><span class="p">();</span>
      <span class="n">hostnameVerifier</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="na">hostnameVerifier</span><span class="p">();</span>
      <span class="n">certificatePinner</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="na">certificatePinner</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">new</span> <span class="n">Address</span><span class="p">(</span><span class="n">url</span><span class="p">.</span><span class="na">host</span><span class="p">(),</span> <span class="n">url</span><span class="p">.</span><span class="na">port</span><span class="p">(),</span> <span class="n">client</span><span class="p">.</span><span class="na">dns</span><span class="p">(),</span> <span class="n">client</span><span class="p">.</span><span class="na">socketFactory</span><span class="p">(),</span>
        <span class="n">sslSocketFactory</span><span class="p">,</span> <span class="n">hostnameVerifier</span><span class="p">,</span> <span class="n">certificatePinner</span><span class="p">,</span> <span class="n">client</span><span class="p">.</span><span class="na">proxyAuthenticator</span><span class="p">(),</span>
        <span class="n">client</span><span class="p">.</span><span class="na">proxy</span><span class="p">(),</span> <span class="n">client</span><span class="p">.</span><span class="na">protocols</span><span class="p">(),</span> <span class="n">client</span><span class="p">.</span><span class="na">connectionSpecs</span><span class="p">(),</span> <span class="n">client</span><span class="p">.</span><span class="na">proxySelector</span><span class="p">());</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>然后会调用了 RealInterceptorChain 的 proceed 方法，在这个方法中有一个变量，那就是 call++ ，那么到这里就会交给下一个拦截器进行处理了。其实后续的拦截器的大体逻辑都是这样的， proceed 表示就是去交给下一个拦截器处理，不过可以注意下，proceed 有一个前后的关系，也就是假如说现在交给下一个拦截器处理了，下一个拦截器处理完成了，还会返回回来继续处理当上一个拦截器的 proceed 后面部分代码的逻辑。有点像递归一样，具体可以看后面部分。</p>

<p>retryAndFollowUpInterceptor 中请求完成后，根据服务器返回的 code 请求，决定是否需要重试，主要的代码逻辑是 followUpRequest 这个里面，如果符合条件的话，然后再通过死循环的方式，继续重试当前的请求。看看 followUpRequest 是如何实现的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="kd">private</span> <span class="nf">Request</span> <span class="n">followUpRequest</span><span class="p">(</span><span class="n">Response</span> <span class="nf">userResponse</span><span class="p">)</span> <span class="kd">throws</span> <span class="nf">IOException</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">userResponse</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="p">();</span>
    <span class="n">Connection</span> <span class="nf">connection</span> <span class="o">=</span> <span class="n">streamAllocation</span><span class="p">.</span><span class="na">connection</span><span class="p">();</span>
    <span class="n">Route</span> <span class="nf">route</span> <span class="o">=</span> <span class="n">connection</span> <span class="o">!=</span> <span class="kc">null</span>
        <span class="o">?</span> <span class="n">connection</span><span class="p">.</span><span class="na">route</span><span class="p">()</span>
        <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kt">int</span> <span class="nf">responseCode</span> <span class="o">=</span> <span class="n">userResponse</span><span class="p">.</span><span class="na">code</span><span class="p">();</span>

    <span class="kd">final</span> <span class="nf">String</span> <span class="n">method</span> <span class="o">=</span> <span class="n">userResponse</span><span class="p">.</span><span class="na">request</span><span class="p">().</span><span class="na">method</span><span class="p">();</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">responseCode</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="n">HTTP_PROXY_AUTH</span><span class="o">:</span><span class="c1">// 407：请求要求代理的身份认证，与401类似，但请求者应当使用代理进行授权
</span><span class="c1"></span>        <span class="n">Proxy</span> <span class="nf">selectedProxy</span> <span class="o">=</span> <span class="n">route</span> <span class="o">!=</span> <span class="kc">null</span>
            <span class="o">?</span> <span class="n">route</span><span class="p">.</span><span class="na">proxy</span><span class="p">()</span>
            <span class="o">:</span> <span class="n">client</span><span class="p">.</span><span class="na">proxy</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">selectedProxy</span><span class="p">.</span><span class="na">type</span><span class="p">()</span> <span class="o">!=</span> <span class="n">Proxy</span><span class="p">.</span><span class="na">Type</span><span class="p">.</span><span class="na">HTTP</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="n">ProtocolException</span><span class="p">(</span><span class="s">&#34;Received HTTP_PROXY_AUTH (407) code while not using proxy&#34;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">client</span><span class="p">.</span><span class="na">proxyAuthenticator</span><span class="p">().</span><span class="na">authenticate</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="n">userResponse</span><span class="p">);</span>

      <span class="k">case</span> <span class="n">HTTP_UNAUTHORIZED</span><span class="o">:</span><span class="c1">// 401：请求要求用户的身份认证
</span><span class="c1"></span>        <span class="k">return</span> <span class="n">client</span><span class="p">.</span><span class="na">authenticator</span><span class="p">().</span><span class="na">authenticate</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="n">userResponse</span><span class="p">);</span>

      <span class="c1">// 3xx 重定向，需要进一步的操作以完成请求 
</span><span class="c1"></span>      <span class="k">case</span> <span class="n">HTTP_PERM_REDIRECT</span><span class="o">:</span> 
      <span class="k">case</span> <span class="n">HTTP_TEMP_REDIRECT</span><span class="o">:</span>
        <span class="c1">// &#34;If the 307 or 308 status code is received in response to a request other than GET
</span><span class="c1"></span>        <span class="c1">// or HEAD, the user agent MUST NOT automatically redirect the request&#34;
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">method</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&#34;GET&#34;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">method</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&#34;HEAD&#34;</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">// fall-through
</span><span class="c1"></span>      <span class="k">case</span> <span class="n">HTTP_MULT_CHOICE</span><span class="o">:</span>
      <span class="k">case</span> <span class="n">HTTP_MOVED_PERM</span><span class="o">:</span>
      <span class="k">case</span> <span class="n">HTTP_MOVED_TEMP</span><span class="o">:</span>
      <span class="k">case</span> <span class="n">HTTP_SEE_OTHER</span><span class="o">:</span>
        <span class="c1">// Does the client allow redirects?
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">.</span><span class="na">followRedirects</span><span class="p">())</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>

        <span class="n">String</span> <span class="nf">location</span> <span class="o">=</span> <span class="n">userResponse</span><span class="p">.</span><span class="na">header</span><span class="p">(</span><span class="s">&#34;Location&#34;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">location</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="n">HttpUrl</span> <span class="nf">url</span> <span class="o">=</span> <span class="n">userResponse</span><span class="p">.</span><span class="na">request</span><span class="p">().</span><span class="na">url</span><span class="p">().</span><span class="na">resolve</span><span class="p">(</span><span class="n">location</span><span class="p">);</span>

        <span class="c1">// Don&#39;t follow redirects to unsupported protocols.
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">url</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>

        <span class="c1">// If configured, don&#39;t follow redirects between SSL and non-SSL.
</span><span class="c1"></span>        <span class="kt">boolean</span> <span class="nf">sameScheme</span> <span class="o">=</span> <span class="n">url</span><span class="p">.</span><span class="na">scheme</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">userResponse</span><span class="p">.</span><span class="na">request</span><span class="p">().</span><span class="na">url</span><span class="p">().</span><span class="na">scheme</span><span class="p">());</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sameScheme</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">client</span><span class="p">.</span><span class="na">followSslRedirects</span><span class="p">())</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>

        <span class="c1">// Most redirects don&#39;t include a request body.
</span><span class="c1"></span>        <span class="n">Request</span><span class="p">.</span><span class="na">Builder</span> <span class="nf">requestBuilder</span> <span class="o">=</span> <span class="n">userResponse</span><span class="p">.</span><span class="na">request</span><span class="p">().</span><span class="na">newBuilder</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">HttpMethod</span><span class="p">.</span><span class="na">permitsRequestBody</span><span class="p">(</span><span class="n">method</span><span class="p">))</span> <span class="p">{</span>
          <span class="kd">final</span> <span class="nf">boolean</span> <span class="n">maintainBody</span> <span class="o">=</span> <span class="n">HttpMethod</span><span class="p">.</span><span class="na">redirectsWithBody</span><span class="p">(</span><span class="n">method</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">HttpMethod</span><span class="p">.</span><span class="na">redirectsToGet</span><span class="p">(</span><span class="n">method</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">requestBuilder</span><span class="p">.</span><span class="na">method</span><span class="p">(</span><span class="s">&#34;GET&#34;</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">RequestBody</span> <span class="nf">requestBody</span> <span class="o">=</span> <span class="n">maintainBody</span> <span class="o">?</span> <span class="n">userResponse</span><span class="p">.</span><span class="na">request</span><span class="p">().</span><span class="na">body</span><span class="p">()</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
            <span class="n">requestBuilder</span><span class="p">.</span><span class="na">method</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">requestBody</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">maintainBody</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">requestBuilder</span><span class="p">.</span><span class="na">removeHeader</span><span class="p">(</span><span class="s">&#34;Transfer-Encoding&#34;</span><span class="p">);</span>
            <span class="n">requestBuilder</span><span class="p">.</span><span class="na">removeHeader</span><span class="p">(</span><span class="s">&#34;Content-Length&#34;</span><span class="p">);</span>
            <span class="n">requestBuilder</span><span class="p">.</span><span class="na">removeHeader</span><span class="p">(</span><span class="s">&#34;Content-Type&#34;</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// When redirecting across hosts, drop all authentication headers. This
</span><span class="c1"></span>        <span class="c1">// is potentially annoying to the application layer since they have no
</span><span class="c1"></span>        <span class="c1">// way to retain them.
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sameConnection</span><span class="p">(</span><span class="n">userResponse</span><span class="p">,</span> <span class="n">url</span><span class="p">))</span> <span class="p">{</span>
          <span class="n">requestBuilder</span><span class="p">.</span><span class="na">removeHeader</span><span class="p">(</span><span class="s">&#34;Authorization&#34;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">requestBuilder</span><span class="p">.</span><span class="na">url</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="na">build</span><span class="p">();</span>

      <span class="k">case</span> <span class="n">HTTP_CLIENT_TIMEOUT</span><span class="o">:</span> <span class="c1">// 服务器等待客户端发送的请求时间过长，超时
</span><span class="c1"></span>        <span class="c1">// 408&#39;s are rare in practice, but some servers like HAProxy use this response code. The
</span><span class="c1"></span>        <span class="c1">// spec says that we may repeat the request without modifications. Modern browsers also
</span><span class="c1"></span>        <span class="c1">// repeat the request (even non-idempotent ones.)
</span><span class="c1"></span>        <span class="c1">// 根据返回的 body 判断是否是UnrepeatableRequestBody不可以重复请求，否则继续请求
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">userResponse</span><span class="p">.</span><span class="na">request</span><span class="p">().</span><span class="na">body</span><span class="p">()</span> <span class="k">instanceof</span> <span class="n">UnrepeatableRequestBody</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">userResponse</span><span class="p">.</span><span class="na">request</span><span class="p">();</span>
<span class="nl">
</span><span class="nl">      default:</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>在上述代码中当 code 返回是  407 401 时候，会尝试将 authenticate 身份验证，再次尝试请求，或者是遇到上述代码中 3xx 的类型重定向的请求，也会重新请求。</p>

<p>下一个拦截器的逻辑就是 BridgeInterceptor ：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="nd">@Override</span> <span class="kd">public</span> <span class="nf">Response</span> <span class="n">intercept</span><span class="p">(</span><span class="n">Chain</span> <span class="nf">chain</span><span class="p">)</span> <span class="kd">throws</span> <span class="nf">IOException</span> <span class="p">{</span>
    <span class="n">Request</span> <span class="nf">userRequest</span> <span class="o">=</span> <span class="n">chain</span><span class="p">.</span><span class="na">request</span><span class="p">();</span>
    <span class="n">Request</span><span class="p">.</span><span class="na">Builder</span> <span class="nf">requestBuilder</span> <span class="o">=</span> <span class="n">userRequest</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">();</span>

    <span class="n">RequestBody</span> <span class="nf">body</span> <span class="o">=</span> <span class="n">userRequest</span><span class="p">.</span><span class="na">body</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">body</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">MediaType</span> <span class="nf">contentType</span> <span class="o">=</span> <span class="n">body</span><span class="p">.</span><span class="na">contentType</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">contentType</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">requestBuilder</span><span class="p">.</span><span class="na">header</span><span class="p">(</span><span class="s">&#34;Content-Type&#34;</span><span class="p">,</span> <span class="n">contentType</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span>
      <span class="p">}</span>

      <span class="kt">long</span> <span class="nf">contentLength</span> <span class="o">=</span> <span class="n">body</span><span class="p">.</span><span class="na">contentLength</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">contentLength</span> <span class="o">!=</span> <span class="o">-</span><span class="n">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">requestBuilder</span><span class="p">.</span><span class="na">header</span><span class="p">(</span><span class="s">&#34;Content-Length&#34;</span><span class="p">,</span> <span class="n">Long</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">contentLength</span><span class="p">));</span>
        <span class="n">requestBuilder</span><span class="p">.</span><span class="na">removeHeader</span><span class="p">(</span><span class="s">&#34;Transfer-Encoding&#34;</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">requestBuilder</span><span class="p">.</span><span class="na">header</span><span class="p">(</span><span class="s">&#34;Transfer-Encoding&#34;</span><span class="p">,</span> <span class="s">&#34;chunked&#34;</span><span class="p">);</span>
        <span class="n">requestBuilder</span><span class="p">.</span><span class="na">removeHeader</span><span class="p">(</span><span class="s">&#34;Content-Length&#34;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">userRequest</span><span class="p">.</span><span class="na">header</span><span class="p">(</span><span class="s">&#34;Host&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">requestBuilder</span><span class="p">.</span><span class="na">header</span><span class="p">(</span><span class="s">&#34;Host&#34;</span><span class="p">,</span> <span class="n">hostHeader</span><span class="p">(</span><span class="n">userRequest</span><span class="p">.</span><span class="na">url</span><span class="p">(),</span> <span class="kc">false</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">userRequest</span><span class="p">.</span><span class="na">header</span><span class="p">(</span><span class="s">&#34;Connection&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">requestBuilder</span><span class="p">.</span><span class="na">header</span><span class="p">(</span><span class="s">&#34;Connection&#34;</span><span class="p">,</span> <span class="s">&#34;Keep-Alive&#34;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// If we add an &#34;Accept-Encoding: gzip&#34; header field we&#39;re responsible for also decompressing
</span><span class="c1"></span>    <span class="c1">// the transfer stream.
</span><span class="c1"></span>    <span class="kt">boolean</span> <span class="nf">transparentGzip</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">userRequest</span><span class="p">.</span><span class="na">header</span><span class="p">(</span><span class="s">&#34;Accept-Encoding&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">transparentGzip</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="n">requestBuilder</span><span class="p">.</span><span class="na">header</span><span class="p">(</span><span class="s">&#34;Accept-Encoding&#34;</span><span class="p">,</span> <span class="s">&#34;gzip&#34;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">Cookie</span><span class="o">&gt;</span> <span class="nf">cookies</span> <span class="o">=</span> <span class="n">cookieJar</span><span class="p">.</span><span class="na">loadForRequest</span><span class="p">(</span><span class="n">userRequest</span><span class="p">.</span><span class="na">url</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cookies</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">requestBuilder</span><span class="p">.</span><span class="na">header</span><span class="p">(</span><span class="s">&#34;Cookie&#34;</span><span class="p">,</span> <span class="n">cookieHeader</span><span class="p">(</span><span class="n">cookies</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">userRequest</span><span class="p">.</span><span class="na">header</span><span class="p">(</span><span class="s">&#34;User-Agent&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">requestBuilder</span><span class="p">.</span><span class="na">header</span><span class="p">(</span><span class="s">&#34;User-Agent&#34;</span><span class="p">,</span> <span class="n">Version</span><span class="p">.</span><span class="na">userAgent</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="n">Response</span> <span class="nf">networkResponse</span> <span class="o">=</span> <span class="n">chain</span><span class="p">.</span><span class="na">proceed</span><span class="p">(</span><span class="n">requestBuilder</span><span class="p">.</span><span class="na">build</span><span class="p">());</span>

    <span class="n">HttpHeaders</span><span class="p">.</span><span class="na">receiveHeaders</span><span class="p">(</span><span class="n">cookieJar</span><span class="p">,</span> <span class="n">userRequest</span><span class="p">.</span><span class="na">url</span><span class="p">(),</span> <span class="n">networkResponse</span><span class="p">.</span><span class="na">headers</span><span class="p">());</span>

    <span class="n">Response</span><span class="p">.</span><span class="na">Builder</span> <span class="nf">responseBuilder</span> <span class="o">=</span> <span class="n">networkResponse</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span>
        <span class="p">.</span><span class="na">request</span><span class="p">(</span><span class="n">userRequest</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">transparentGzip</span>
        <span class="o">&amp;&amp;</span> <span class="s">&#34;gzip&#34;</span><span class="p">.</span><span class="na">equalsIgnoreCase</span><span class="p">(</span><span class="n">networkResponse</span><span class="p">.</span><span class="na">header</span><span class="p">(</span><span class="s">&#34;Content-Encoding&#34;</span><span class="p">))</span>
        <span class="o">&amp;&amp;</span> <span class="n">HttpHeaders</span><span class="p">.</span><span class="na">hasBody</span><span class="p">(</span><span class="n">networkResponse</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">GzipSource</span> <span class="nf">responseBody</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GzipSource</span><span class="p">(</span><span class="n">networkResponse</span><span class="p">.</span><span class="na">body</span><span class="p">().</span><span class="na">source</span><span class="p">());</span>
      <span class="n">Headers</span> <span class="nf">strippedHeaders</span> <span class="o">=</span> <span class="n">networkResponse</span><span class="p">.</span><span class="na">headers</span><span class="p">().</span><span class="na">newBuilder</span><span class="p">()</span>
          <span class="p">.</span><span class="na">removeAll</span><span class="p">(</span><span class="s">&#34;Content-Encoding&#34;</span><span class="p">)</span>
          <span class="p">.</span><span class="na">removeAll</span><span class="p">(</span><span class="s">&#34;Content-Length&#34;</span><span class="p">)</span>
          <span class="p">.</span><span class="na">build</span><span class="p">();</span>
      <span class="n">responseBuilder</span><span class="p">.</span><span class="na">headers</span><span class="p">(</span><span class="n">strippedHeaders</span><span class="p">);</span>
      <span class="n">responseBuilder</span><span class="p">.</span><span class="na">body</span><span class="p">(</span><span class="k">new</span> <span class="n">RealResponseBody</span><span class="p">(</span><span class="n">strippedHeaders</span><span class="p">,</span> <span class="n">Okio</span><span class="p">.</span><span class="na">buffer</span><span class="p">(</span><span class="n">responseBody</span><span class="p">)));</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">responseBuilder</span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>BridgeInterceptor 中做的逻辑主要做的一些 Http 的一些 Header 设置、 contentLength 的计算、Content-Type 的设置，和 gzip 的解包解压缩，proceed 后做的操作主要是解包的操作。</p>

<p>接着下一个拦截器的逻辑就是 CacheInterceptor ：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="nd">@Override</span> <span class="kd">public</span> <span class="nf">Response</span> <span class="n">intercept</span><span class="p">(</span><span class="n">Chain</span> <span class="nf">chain</span><span class="p">)</span> <span class="kd">throws</span> <span class="nf">IOException</span> <span class="p">{</span>
    <span class="n">Response</span> <span class="nf">cacheCandidate</span> <span class="o">=</span> <span class="n">cache</span> <span class="o">!=</span> <span class="kc">null</span>
        <span class="o">?</span> <span class="n">cache</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">chain</span><span class="p">.</span><span class="na">request</span><span class="p">())</span>
        <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>

    <span class="kt">long</span> <span class="nf">now</span> <span class="o">=</span> <span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span>

    <span class="c1">// 工厂设计模式定义缓存策略
</span><span class="c1"></span>    <span class="n">CacheStrategy</span> <span class="nf">strategy</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CacheStrategy</span><span class="p">.</span><span class="na">Factory</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">chain</span><span class="p">.</span><span class="na">request</span><span class="p">(),</span> <span class="n">cacheCandidate</span><span class="p">).</span><span class="na">get</span><span class="p">();</span>
    <span class="n">Request</span> <span class="nf">networkRequest</span> <span class="o">=</span> <span class="n">strategy</span><span class="p">.</span><span class="na">networkRequest</span><span class="p">;</span>
    <span class="n">Response</span> <span class="nf">cacheResponse</span> <span class="o">=</span> <span class="n">strategy</span><span class="p">.</span><span class="na">cacheResponse</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">cache</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">cache</span><span class="p">.</span><span class="na">trackResponse</span><span class="p">(</span><span class="n">strategy</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">cacheCandidate</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">cacheResponse</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">closeQuietly</span><span class="p">(</span><span class="n">cacheCandidate</span><span class="p">.</span><span class="na">body</span><span class="p">());</span> <span class="c1">// The cache candidate wasn&#39;t applicable. Close it.
</span><span class="c1"></span>    <span class="p">}</span>

    <span class="c1">// 返回失败的 Response
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">networkRequest</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">cacheResponse</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="n">Response</span><span class="p">.</span><span class="na">Builder</span><span class="p">()</span>
          <span class="p">.</span><span class="na">request</span><span class="p">(</span><span class="n">chain</span><span class="p">.</span><span class="na">request</span><span class="p">())</span>
          <span class="p">.</span><span class="na">protocol</span><span class="p">(</span><span class="n">Protocol</span><span class="p">.</span><span class="na">HTTP_1_1</span><span class="p">)</span>
          <span class="p">.</span><span class="na">code</span><span class="p">(</span><span class="n">504</span><span class="p">)</span>
          <span class="p">.</span><span class="na">message</span><span class="p">(</span><span class="s">&#34;Unsatisfiable Request (only-if-cached)&#34;</span><span class="p">)</span>
          <span class="p">.</span><span class="na">body</span><span class="p">(</span><span class="n">Util</span><span class="p">.</span><span class="na">EMPTY_RESPONSE</span><span class="p">)</span>
          <span class="p">.</span><span class="na">sentRequestAtMillis</span><span class="p">(</span><span class="o">-</span><span class="n">1L</span><span class="p">)</span>
          <span class="p">.</span><span class="na">receivedResponseAtMillis</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">())</span>
          <span class="p">.</span><span class="na">build</span><span class="p">();</span>
    <span class="p">}</span>
 
    <span class="c1">// 如果 networkRequest 为 null ，将缓存返回
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">networkRequest</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">cacheResponse</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span>
          <span class="p">.</span><span class="na">cacheResponse</span><span class="p">(</span><span class="n">stripBody</span><span class="p">(</span><span class="n">cacheResponse</span><span class="p">))</span>
          <span class="p">.</span><span class="na">build</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">Response</span> <span class="nf">networkResponse</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="c1">// 交给下一个拦截器处理
</span><span class="c1"></span>      <span class="n">networkResponse</span> <span class="o">=</span> <span class="n">chain</span><span class="p">.</span><span class="na">proceed</span><span class="p">(</span><span class="n">networkRequest</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
      <span class="c1">// If we&#39;re crashing on I/O or otherwise, don&#39;t leak the cache body.
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">networkResponse</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">cacheCandidate</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">closeQuietly</span><span class="p">(</span><span class="n">cacheCandidate</span><span class="p">.</span><span class="na">body</span><span class="p">());</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// If we have a cache response too, then we&#39;re doing a conditional get.
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">cacheResponse</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 数据未发生改变的情况下，将缓存返回
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">networkResponse</span><span class="p">.</span><span class="na">code</span><span class="p">()</span> <span class="o">==</span> <span class="n">HTTP_NOT_MODIFIED</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Response</span> <span class="nf">response</span> <span class="o">=</span> <span class="n">cacheResponse</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span>
            <span class="p">.</span><span class="na">headers</span><span class="p">(</span><span class="n">combine</span><span class="p">(</span><span class="n">cacheResponse</span><span class="p">.</span><span class="na">headers</span><span class="p">(),</span> <span class="n">networkResponse</span><span class="p">.</span><span class="na">headers</span><span class="p">()))</span>
            <span class="p">.</span><span class="na">sentRequestAtMillis</span><span class="p">(</span><span class="n">networkResponse</span><span class="p">.</span><span class="na">sentRequestAtMillis</span><span class="p">())</span>
            <span class="p">.</span><span class="na">receivedResponseAtMillis</span><span class="p">(</span><span class="n">networkResponse</span><span class="p">.</span><span class="na">receivedResponseAtMillis</span><span class="p">())</span>
            <span class="p">.</span><span class="na">cacheResponse</span><span class="p">(</span><span class="n">stripBody</span><span class="p">(</span><span class="n">cacheResponse</span><span class="p">))</span>
            <span class="p">.</span><span class="na">networkResponse</span><span class="p">(</span><span class="n">stripBody</span><span class="p">(</span><span class="n">networkResponse</span><span class="p">))</span>
            <span class="p">.</span><span class="na">build</span><span class="p">();</span>
        <span class="n">networkResponse</span><span class="p">.</span><span class="na">body</span><span class="p">().</span><span class="na">close</span><span class="p">();</span>

        <span class="c1">// 更新缓存
</span><span class="c1"></span>        <span class="n">cache</span><span class="p">.</span><span class="na">trackConditionalCacheHit</span><span class="p">();</span>
        <span class="n">cache</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="n">cacheResponse</span><span class="p">,</span> <span class="n">response</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">closeQuietly</span><span class="p">(</span><span class="n">cacheResponse</span><span class="p">.</span><span class="na">body</span><span class="p">());</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">Response</span> <span class="nf">response</span> <span class="o">=</span> <span class="n">networkResponse</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span>
        <span class="p">.</span><span class="na">cacheResponse</span><span class="p">(</span><span class="n">stripBody</span><span class="p">(</span><span class="n">cacheResponse</span><span class="p">))</span>
        <span class="p">.</span><span class="na">networkResponse</span><span class="p">(</span><span class="n">stripBody</span><span class="p">(</span><span class="n">networkResponse</span><span class="p">))</span>
        <span class="p">.</span><span class="na">build</span><span class="p">();</span>

    <span class="c1">// 缓存起来 response
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">HttpHeaders</span><span class="p">.</span><span class="na">hasBody</span><span class="p">(</span><span class="n">response</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">CacheRequest</span> <span class="nf">cacheRequest</span> <span class="o">=</span> <span class="n">maybeCache</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">networkResponse</span><span class="p">.</span><span class="na">request</span><span class="p">(),</span> <span class="n">cache</span><span class="p">);</span>
      <span class="n">response</span> <span class="o">=</span> <span class="n">cacheWritingResponse</span><span class="p">(</span><span class="n">cacheRequest</span><span class="p">,</span> <span class="n">response</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">response</span><span class="p">;</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>这里主要做的逻辑是缓存 response ，首先是请求前，使用工厂设计模式定义缓存策略，然后其中有两个比较重要的变量，起着比较重要的作用</p>

<ul>
<li>networkRequest：无网络即为 null，有网络则为将要发送的请求在的网络部分</li>
<li>cacheResponse：无缓存即为 null，有缓存则为缓存的响应，用来返回或验证</li>
</ul>

<p>然后就是 proceed 后请求到结果之后根据 cacheResponse 不为空和 code =  HTTP_NOT_MODIFIED 是否需要使用缓存，更新缓存，并将响应返回。反之将此次结果给缓存起来。</p>

<p>接下来的拦截器就是 ConnectInterceptor ：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="nd">@Override</span> <span class="kd">public</span> <span class="nf">Response</span> <span class="n">intercept</span><span class="p">(</span><span class="n">Chain</span> <span class="nf">chain</span><span class="p">)</span> <span class="kd">throws</span> <span class="nf">IOException</span> <span class="p">{</span>
    <span class="n">RealInterceptorChain</span> <span class="nf">realChain</span> <span class="o">=</span> <span class="p">(</span><span class="n">RealInterceptorChain</span><span class="p">)</span> <span class="n">chain</span><span class="p">;</span>
    <span class="n">Request</span> <span class="nf">request</span> <span class="o">=</span> <span class="n">realChain</span><span class="p">.</span><span class="na">request</span><span class="p">();</span>
    <span class="n">StreamAllocation</span> <span class="nf">streamAllocation</span> <span class="o">=</span> <span class="n">realChain</span><span class="p">.</span><span class="na">streamAllocation</span><span class="p">();</span>

    <span class="c1">// We need the network to satisfy this request. Possibly for validating a conditional GET.
</span><span class="c1"></span>    <span class="kt">boolean</span> <span class="nf">doExtensiveHealthChecks</span> <span class="o">=</span> <span class="o">!</span><span class="n">request</span><span class="p">.</span><span class="na">method</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="s">&#34;GET&#34;</span><span class="p">);</span>
    <span class="n">HttpCodec</span> <span class="nf">httpCodec</span> <span class="o">=</span> <span class="n">streamAllocation</span><span class="p">.</span><span class="na">newStream</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">doExtensiveHealthChecks</span><span class="p">);</span>
    <span class="n">RealConnection</span> <span class="nf">connection</span> <span class="o">=</span> <span class="n">streamAllocation</span><span class="p">.</span><span class="na">connection</span><span class="p">();</span>

    <span class="k">return</span> <span class="n">realChain</span><span class="p">.</span><span class="na">proceed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">streamAllocation</span><span class="p">,</span> <span class="n">httpCodec</span><span class="p">,</span> <span class="n">connection</span><span class="p">);</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>首先是这里 proceed 没有后续操作，主要的操作都在 newStream 中， 看看这个方法都干了什么：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="kd">public</span> <span class="nf">HttpCodec</span> <span class="n">newStream</span><span class="p">(</span><span class="n">OkHttpClient</span> <span class="nf">client</span><span class="p">,</span> <span class="kt">boolean</span> <span class="nf">doExtensiveHealthChecks</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="nf">connectTimeout</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="na">connectTimeoutMillis</span><span class="p">();</span>
    <span class="kt">int</span> <span class="nf">readTimeout</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="na">readTimeoutMillis</span><span class="p">();</span>
    <span class="kt">int</span> <span class="nf">writeTimeout</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="na">writeTimeoutMillis</span><span class="p">();</span>
    <span class="kt">boolean</span> <span class="nf">connectionRetryEnabled</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="na">retryOnConnectionFailure</span><span class="p">();</span>

    <span class="k">try</span> <span class="p">{</span>
      <span class="n">RealConnection</span> <span class="nf">resultConnection</span> <span class="o">=</span> <span class="n">findHealthyConnection</span><span class="p">(</span><span class="n">connectTimeout</span><span class="p">,</span> <span class="n">readTimeout</span><span class="p">,</span>
          <span class="n">writeTimeout</span><span class="p">,</span> <span class="n">connectionRetryEnabled</span><span class="p">,</span> <span class="n">doExtensiveHealthChecks</span><span class="p">);</span>

      <span class="n">HttpCodec</span> <span class="nf">resultCodec</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">resultConnection</span><span class="p">.</span><span class="na">http2Connection</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">resultCodec</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Http2Codec</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">resultConnection</span><span class="p">.</span><span class="na">http2Connection</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">resultConnection</span><span class="p">.</span><span class="na">socket</span><span class="p">().</span><span class="na">setSoTimeout</span><span class="p">(</span><span class="n">readTimeout</span><span class="p">);</span>
        <span class="n">resultConnection</span><span class="p">.</span><span class="na">source</span><span class="p">.</span><span class="na">timeout</span><span class="p">().</span><span class="na">timeout</span><span class="p">(</span><span class="n">readTimeout</span><span class="p">,</span> <span class="n">MILLISECONDS</span><span class="p">);</span>
        <span class="n">resultConnection</span><span class="p">.</span><span class="na">sink</span><span class="p">.</span><span class="na">timeout</span><span class="p">().</span><span class="na">timeout</span><span class="p">(</span><span class="n">writeTimeout</span><span class="p">,</span> <span class="n">MILLISECONDS</span><span class="p">);</span>
        <span class="n">resultCodec</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Http1Codec</span><span class="p">(</span>
            <span class="n">client</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">resultConnection</span><span class="p">.</span><span class="na">source</span><span class="p">,</span> <span class="n">resultConnection</span><span class="p">.</span><span class="na">sink</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="kd">synchronized</span> <span class="p">(</span><span class="n">connectionPool</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">codec</span> <span class="o">=</span> <span class="n">resultCodec</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">resultCodec</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="nf">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="n">RouteException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>这个拦截器主要做的事情是负责建⽴连接。在这⾥，OkHttp 会创建出⽹络请求所需要的，TCP 连接，或者是 Https 连接，并且会创建出用于 HTTP 编码解码HttpCodec 对象</p>

<p>接下来的拦截器就是 CallServerInterceptor ：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="nd">@Override</span> <span class="kd">public</span> <span class="nf">Response</span> <span class="n">intercept</span><span class="p">(</span><span class="n">Chain</span> <span class="nf">chain</span><span class="p">)</span> <span class="kd">throws</span> <span class="nf">IOException</span> <span class="p">{</span>
    <span class="n">HttpCodec</span> <span class="nf">httpCodec</span> <span class="o">=</span> <span class="p">((</span><span class="n">RealInterceptorChain</span><span class="p">)</span> <span class="n">chain</span><span class="p">).</span><span class="na">httpStream</span><span class="p">();</span>
    <span class="n">StreamAllocation</span> <span class="nf">streamAllocation</span> <span class="o">=</span> <span class="p">((</span><span class="n">RealInterceptorChain</span><span class="p">)</span> <span class="n">chain</span><span class="p">).</span><span class="na">streamAllocation</span><span class="p">();</span>
    <span class="n">Request</span> <span class="nf">request</span> <span class="o">=</span> <span class="n">chain</span><span class="p">.</span><span class="na">request</span><span class="p">();</span>

    <span class="kt">long</span> <span class="nf">sentRequestMillis</span> <span class="o">=</span> <span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span>
    <span class="n">httpCodec</span><span class="p">.</span><span class="na">writeRequestHeaders</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">HttpMethod</span><span class="p">.</span><span class="na">permitsRequestBody</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">method</span><span class="p">())</span> <span class="o">&amp;&amp;</span> <span class="n">request</span><span class="p">.</span><span class="na">body</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">Sink</span> <span class="nf">requestBodyOut</span> <span class="o">=</span> <span class="n">httpCodec</span><span class="p">.</span><span class="na">createRequestBody</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="na">body</span><span class="p">().</span><span class="na">contentLength</span><span class="p">());</span>
      <span class="n">BufferedSink</span> <span class="nf">bufferedRequestBody</span> <span class="o">=</span> <span class="n">Okio</span><span class="p">.</span><span class="na">buffer</span><span class="p">(</span><span class="n">requestBodyOut</span><span class="p">);</span>
      <span class="n">request</span><span class="p">.</span><span class="na">body</span><span class="p">().</span><span class="na">writeTo</span><span class="p">(</span><span class="n">bufferedRequestBody</span><span class="p">);</span>
      <span class="n">bufferedRequestBody</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">httpCodec</span><span class="p">.</span><span class="na">finishRequest</span><span class="p">();</span>

    <span class="n">Response</span> <span class="nf">response</span> <span class="o">=</span> <span class="n">httpCodec</span><span class="p">.</span><span class="na">readResponseHeaders</span><span class="p">()</span>
        <span class="p">.</span><span class="na">request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="p">.</span><span class="na">handshake</span><span class="p">(</span><span class="n">streamAllocation</span><span class="p">.</span><span class="na">connection</span><span class="p">().</span><span class="na">handshake</span><span class="p">())</span>
        <span class="p">.</span><span class="na">sentRequestAtMillis</span><span class="p">(</span><span class="n">sentRequestMillis</span><span class="p">)</span>
        <span class="p">.</span><span class="na">receivedResponseAtMillis</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">())</span>
        <span class="p">.</span><span class="na">build</span><span class="p">();</span>

    <span class="kt">int</span> <span class="nf">code</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="na">code</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">forWebSocket</span> <span class="o">&amp;&amp;</span> <span class="n">code</span> <span class="o">==</span> <span class="n">101</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Connection is upgrading, but we need to ensure interceptors see a non-null response body.
</span><span class="c1"></span>      <span class="n">response</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span>
          <span class="p">.</span><span class="na">body</span><span class="p">(</span><span class="n">Util</span><span class="p">.</span><span class="na">EMPTY_RESPONSE</span><span class="p">)</span>
          <span class="p">.</span><span class="na">build</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">response</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span>
          <span class="p">.</span><span class="na">body</span><span class="p">(</span><span class="n">httpCodec</span><span class="p">.</span><span class="na">openResponseBody</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
          <span class="p">.</span><span class="na">build</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="s">&#34;close&#34;</span><span class="p">.</span><span class="na">equalsIgnoreCase</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">request</span><span class="p">().</span><span class="na">header</span><span class="p">(</span><span class="s">&#34;Connection&#34;</span><span class="p">))</span>
        <span class="o">||</span> <span class="s">&#34;close&#34;</span><span class="p">.</span><span class="na">equalsIgnoreCase</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">header</span><span class="p">(</span><span class="s">&#34;Connection&#34;</span><span class="p">)))</span> <span class="p">{</span>
      <span class="n">streamAllocation</span><span class="p">.</span><span class="na">noNewStreams</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">code</span> <span class="o">==</span> <span class="n">204</span> <span class="o">||</span> <span class="n">code</span> <span class="o">==</span> <span class="n">205</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">response</span><span class="p">.</span><span class="na">body</span><span class="p">().</span><span class="na">contentLength</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="n">ProtocolException</span><span class="p">(</span>
          <span class="s">&#34;HTTP &#34;</span> <span class="o">+</span> <span class="n">code</span> <span class="o">+</span> <span class="s">&#34; had non-zero Content-Length: &#34;</span> <span class="o">+</span> <span class="n">response</span><span class="p">.</span><span class="na">body</span><span class="p">().</span><span class="na">contentLength</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">response</span><span class="p">;</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>这个拦截器就是实际发生的网络请求了，完成实际的网络流操作，利用 OKIO 将网络请求写入。和读取网络结果的响应，将结果的 response 返回，注意这里没有再调用 proceed 方法了，意味着不会再交给下一个拦截器处理了。然后就是返回给上一个拦截器也就是之前分析的 proceed 后面部分的代码逻辑了，整体的调用大致是这个样子的：</p>

<p><img src="https://raw.githubusercontent.com/checkFang/img/master/20210128200737.png" alt="" /></p>

<p>首先是从 interceptors 最先开始出发，先走自身拦截器的 process 的前半部分，然后调用 proceed 交给下一个拦截器，当最后一个拦截器都调用完毕后，再一级一级的返回请求的响应结果。最终回到 interceptors</p>

<h3 id="网络优化">网络优化</h3>

<p>前面提到的拦截器大部分都是 OKHttp 内部已有的实现，其中有两个 interceptors 和 networkInterceptors 是我们可以在外部实现的，如果按照上图的调用顺序的话，networkInterceptors 的前面是 ConnectInterceptor 拦截器，后面是 CallServerInterceptor 拦截器，所以如果我们添加 networkInterceptors 拦截器，可以看到最原始的请求数据，当然 content-type，content-length 都是已经添加好的，并且拿到的响应数据也是最原始的。那么 interceptors 由于位置不相同，会有点不一样， interceptors 拦截器就是最初有这个请求的意图的起始点，proceed 后面部分就可以获取到响应结果了，就是已经解压好的 gzip 包，或者说是已经解码好的数据响应结果。那么如果这个时候，如果我们想知道当前的接口是那个 url， 请求了多少时间，请求的结果是什么，那么根据上面的分析，我们就可以添加的是 interceptors 拦截器，那么就是这样的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-kotlin" data-lang="kotlin">    <span class="k">private</span> <span class="k">val</span> <span class="py">client</span><span class="p">:</span> <span class="n">OkHttpClient</span>
        <span class="k">get</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">val</span> <span class="py">builder</span> <span class="p">=</span> <span class="n">OkHttpClient</span><span class="p">.</span><span class="n">Builder</span><span class="p">()</span>
            <span class="k">val</span> <span class="py">logging</span> <span class="p">=</span> <span class="n">HttpLoggingInterceptor</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">BuildConfig</span><span class="p">.</span><span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">logging</span><span class="p">.</span><span class="n">level</span> <span class="p">=</span> <span class="n">HttpLoggingInterceptor</span><span class="p">.</span><span class="n">Level</span><span class="p">.</span><span class="n">BODY</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">logging</span><span class="p">.</span><span class="n">level</span> <span class="p">=</span> <span class="n">HttpLoggingInterceptor</span><span class="p">.</span><span class="n">Level</span><span class="p">.</span><span class="n">BASIC</span>
            <span class="p">}</span>
            <span class="n">builder</span><span class="p">.</span><span class="n">addInterceptor</span><span class="p">(</span><span class="n">logging</span><span class="p">)</span>
                    <span class="p">.</span><span class="n">addInterceptor</span><span class="p">(</span><span class="n">mLoggingInterceptor</span><span class="p">)</span>
                    <span class="p">.</span><span class="n">connectTimeout</span><span class="p">(</span><span class="n">TIME_OUT</span><span class="p">.</span><span class="n">toLong</span><span class="p">(),</span> <span class="n">TimeUnit</span><span class="p">.</span><span class="n">SECONDS</span><span class="p">)</span>
                    <span class="p">.</span><span class="n">readTimeout</span><span class="p">(</span><span class="n">TIME_OUT</span><span class="p">.</span><span class="n">toLong</span><span class="p">(),</span> <span class="n">TimeUnit</span><span class="p">.</span><span class="n">SECONDS</span><span class="p">)</span>
            <span class="n">handleBuilder</span><span class="p">(</span><span class="n">builder</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">builder</span><span class="p">.</span><span class="n">build</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="n">@SuppressLint</span><span class="p">(</span><span class="s">&#34;BinaryOperationInTimber&#34;</span><span class="p">)</span>
    <span class="k">private</span> <span class="k">val</span> <span class="py">mLoggingInterceptor</span> <span class="p">=</span> <span class="n">Interceptor</span> <span class="p">{</span> <span class="n">chain</span> <span class="p">-&gt;</span>
        <span class="k">val</span> <span class="py">request</span> <span class="p">=</span> <span class="n">chain</span><span class="p">.</span><span class="n">request</span><span class="p">()</span>
        <span class="k">val</span> <span class="py">t1</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">nanoTime</span><span class="p">()</span>
        <span class="k">val</span> <span class="py">response</span> <span class="p">=</span> <span class="n">chain</span><span class="p">.</span><span class="n">proceed</span><span class="p">(</span><span class="n">chain</span><span class="p">.</span><span class="n">request</span><span class="p">())</span>
        <span class="k">val</span> <span class="py">t2</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">nanoTime</span><span class="p">()</span>
        <span class="k">val</span> <span class="py">contentType</span> <span class="p">=</span> <span class="n">response</span><span class="p">.</span><span class="n">body</span><span class="o">?.</span><span class="n">contentType</span><span class="p">()</span>
        <span class="k">val</span> <span class="py">content</span> <span class="p">=</span> <span class="n">response</span><span class="p">.</span><span class="n">body</span><span class="o">?.</span><span class="n">string</span><span class="p">()</span>
        <span class="n">Logger</span><span class="p">.</span><span class="n">d</span><span class="p">(</span><span class="s">&#34;-okhttp-debug&#34;</span><span class="p">,</span> <span class="s">&#34;request \nurl:&#34;</span> <span class="p">+</span> <span class="n">request</span><span class="p">.</span><span class="n">url</span> <span class="p">+</span> <span class="s">&#34;\ntime:&#34;</span> <span class="p">+</span> <span class="p">(</span><span class="n">t2</span> <span class="p">-</span> <span class="n">t1</span><span class="p">)</span> <span class="p">/</span> <span class="m">1</span><span class="n">e6</span> <span class="p">+</span> <span class="s">&#34;\nbody:&#34;</span> <span class="p">+</span> <span class="n">content</span> <span class="p">+</span> <span class="s">&#34;\n&#34;</span><span class="p">)</span>

        <span class="n">response</span><span class="p">.</span><span class="n">newBuilder</span><span class="p">()</span>
                <span class="p">.</span><span class="n">body</span><span class="p">(</span><span class="n">content</span><span class="o">?.</span><span class="n">toResponseBody</span><span class="p">(</span><span class="n">contentType</span><span class="p">))</span>
                <span class="p">.</span><span class="n">build</span><span class="p">()</span>
    <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>基本所有的拦截器逻辑基本上就是这些了，到这里我们还遗留了一个问题，那就是准备请求的这个队列中的请求是在什么时候请求的，其实就是在当前的请求执行完成后，会调用 client.dispatcher().finished(this) 方法，那么最终会调用是这样的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="kd">private</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">void</span> <span class="n">finished</span><span class="p">(</span><span class="n">Deque</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">calls</span><span class="p">,</span> <span class="n">T</span> <span class="nf">call</span><span class="p">,</span> <span class="kt">boolean</span> <span class="nf">promoteCalls</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="nf">runningCallsCount</span><span class="p">;</span>
    <span class="n">Runnable</span> <span class="nf">idleCallback</span><span class="p">;</span>
    <span class="kd">synchronized</span> <span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">calls</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">call</span><span class="p">))</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">AssertionError</span><span class="p">(</span><span class="s">&#34;Call wasn&#39;t in-flight!&#34;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">promoteCalls</span><span class="p">)</span> <span class="n">promoteCalls</span><span class="p">();</span>
      <span class="n">runningCallsCount</span> <span class="o">=</span> <span class="n">runningCallsCount</span><span class="p">();</span>
      <span class="n">idleCallback</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">idleCallback</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">runningCallsCount</span> <span class="o">==</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="n">idleCallback</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">idleCallback</span><span class="p">.</span><span class="na">run</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>然后会调用 promoteCalls 方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="kd">private</span> <span class="nf">void</span> <span class="n">promoteCalls</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">runningAsyncCalls</span><span class="p">.</span><span class="na">size</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">maxRequests</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span> <span class="c1">// Already running max capacity.
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">readyAsyncCalls</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span> <span class="k">return</span><span class="p">;</span> <span class="c1">// No ready calls to promote.
</span><span class="c1"></span>
    <span class="k">for</span> <span class="p">(</span><span class="n">Iterator</span><span class="o">&lt;</span><span class="n">AsyncCall</span><span class="o">&gt;</span> <span class="nf">i</span> <span class="o">=</span> <span class="n">readyAsyncCalls</span><span class="p">.</span><span class="na">iterator</span><span class="p">();</span> <span class="n">i</span><span class="p">.</span><span class="na">hasNext</span><span class="p">();</span> <span class="p">)</span> <span class="p">{</span>
      <span class="n">AsyncCall</span> <span class="nf">call</span> <span class="o">=</span> <span class="n">i</span><span class="p">.</span><span class="na">next</span><span class="p">();</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">runningCallsForHost</span><span class="p">(</span><span class="n">call</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">maxRequestsPerHost</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">i</span><span class="p">.</span><span class="na">remove</span><span class="p">();</span>
        <span class="n">runningAsyncCalls</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">call</span><span class="p">);</span>
        <span class="c1">// 执行请求
</span><span class="c1"></span>        <span class="n">executorService</span><span class="p">().</span><span class="na">execute</span><span class="p">(</span><span class="n">call</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">runningAsyncCalls</span><span class="p">.</span><span class="na">size</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">maxRequests</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span> <span class="c1">// Reached max capacity.
</span><span class="c1"></span>    <span class="p">}</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>最终调用到 executorService().execute(call)  执行 readyAsyncCalls 队列中的请求，其实 execute 方法和 enqueue 中最终调用的逻辑基本是一样的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="nd">@Override</span> <span class="kd">protected</span> <span class="nf">void</span> <span class="n">execute</span><span class="p">()</span> <span class="p">{</span>
      <span class="kt">boolean</span> <span class="nf">signalledCallback</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="n">Response</span> <span class="nf">response</span> <span class="o">=</span> <span class="n">getResponseWithInterceptorChain</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">retryAndFollowUpInterceptor</span><span class="p">.</span><span class="na">isCanceled</span><span class="p">())</span> <span class="p">{</span>
          <span class="n">signalledCallback</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="n">responseCallback</span><span class="p">.</span><span class="na">onFailure</span><span class="p">(</span><span class="n">RealCall</span><span class="p">.</span><span class="na">this</span><span class="p">,</span> <span class="k">new</span> <span class="n">IOException</span><span class="p">(</span><span class="s">&#34;Canceled&#34;</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">signalledCallback</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="n">responseCallback</span><span class="p">.</span><span class="na">onResponse</span><span class="p">(</span><span class="n">RealCall</span><span class="p">.</span><span class="na">this</span><span class="p">,</span> <span class="n">response</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="nf">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">signalledCallback</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// Do not signal the callback twice!
</span><span class="c1"></span>          <span class="n">Platform</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">log</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&#34;Callback failure for &#34;</span> <span class="o">+</span> <span class="n">toLoggableString</span><span class="p">(),</span> <span class="n">e</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">responseCallback</span><span class="p">.</span><span class="na">onFailure</span><span class="p">(</span><span class="n">RealCall</span><span class="p">.</span><span class="na">this</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
        <span class="n">client</span><span class="p">.</span><span class="na">dispatcher</span><span class="p">().</span><span class="na">finished</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="总结">总结</h3>

<ul>
<li>Dispatcher 线程调度器，用于后台执行网络请求，维护最大请求数量和同主机下的请求数量</li>
<li>interceptors 外部添加的拦截器，主要可以获取到最终的网络响应结果</li>
<li>retryAndFollowUpInterceptor 网络失败时重试，以及重定向，对用户是无感知的</li>
<li>BridgeInterceptor 主要是添加 header 、content-type 类型确定、content-length 的计算</li>
<li>CacheInterceptor 网络缓存的处理，根据有无网络，http 的响应码来具体返回缓存策略</li>
<li>ConnectInterceptor 负责 TCP HTTPS 的连接建立</li>
<li>networkInterceptors 外部添加的拦截器，可以看到原始的 HTTP 请求和响应</li>
<li>CallServerInterceptor 负责实质的请求与响应的 I/O 操作，即往 Socket ⾥写⼊请求数据，和从 Socket ⾥读取响应数据</li>
</ul>

<h3 id="使用到的设计模式">使用到的设计模式</h3>

<ul>
<li>Builder 设计模式

<ul>
<li>OkHttpClient 的构建</li>
<li>Request 的构建</li>
</ul></li>
<li>工厂设计模式

<ul>
<li>CacheInterceptor 中的缓存策略工厂</li>
</ul></li>
<li>享元设计模式

<ul>
<li>ConnectInterceptor 中的连接池</li>
</ul></li>
<li>责任链设计模式

<ul>
<li>RealInterceptorChain</li>
</ul></li>
</ul>
    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">midFang</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
      2021-01-28
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://midFang.github.io/tags/android/">Android</a>
          <a href="https://midFang.github.io/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a>
          <a href="https://midFang.github.io/tags/okhttp/">OKHttp</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/android-process-ipc/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">独立进程通信之悬浮下拉状态栏实践</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/android-motionevent-sliding-conflict/">
            <span class="next-text nav-default">Android 事件分发的冲突解决方案</span>
            <span class="prev-text nav-mobile">Next</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "midFang/blog-comments"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="https://github.com/midFang" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="https://stackoverflow.com/users/14331888/midfang" rel="me noopener" class="iconfont"
      title="stack-overflow"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M809.714286 932.571429l-638.857143 0 0-274.285714-91.428571 0 0 365.714286 821.714286 0 0-365.714286-91.428571 0 0 274.285714zm-538.285714-299.428571l18.857143-89.714286 447.428571 94.285714-18.857143 89.142857zm58.857143-213.714286l38.285714-83.428571 414.285714 193.714286-38.285714 82.857143zm114.857143-203.428571l58.285714-70.285714 350.857143 293.142857-58.285714 70.285714zm226.857143-216l272.571429 366.285714-73.142857 54.857143-272.571429-366.285714zm-410.285714 840.571429l0-90.857143 457.142857 0 0 90.857143-457.142857 0z"></path>
</svg>

    </a>
  
    <a href="https://www.douban.com/people/194654920/" rel="me noopener" class="iconfont"
      title="douban"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M926.917973 37.80608C959.65184 37.80608 986.19392 64.34816 986.19392 97.082027L986.19392 926.917973C986.19392 959.65184 959.65184 986.19392 926.917973 986.19392L97.082027 986.19392C64.34816 986.19392 37.80608 959.65184 37.80608 926.917973L37.80608 97.082027C37.80608 64.34816 64.34816 37.80608 97.082027 37.80608zM176.653653 176.19968 176.653653 252.678827 825.658027 252.678827 825.658027 176.19968zM217.719467 316.146347 217.719467 628.08064 273.524053 628.08064 341.292373 770.39616 157.259093 770.39616 157.259093 845.417813 842.949973 845.417813 842.949973 770.39616 654.226773 770.39616 722.899627 628.08064 783.67744 628.08064 783.67744 316.146347zM684.885333 392.891733 684.885333 553.987413 312.576 553.987413 312.576 392.891733zM570.770773 770.39616 426.653013 770.39616 359.621973 628.08064 639.443627 628.08064z"></path>
</svg>

    </a>


<a href="https://midFang.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2020 -
    2024
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        midFang
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>















  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script type="text/javascript">
    AV.initialize( null ,  null );
  </script>

  <script>
    function showHitCount(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push($(this).attr("id").trim());
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var hits = item.get('hits');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(hits);
          }
          for (var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if (countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function (results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("hits");
            counter.save(null, {
              success: function (counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('hits'));
              },
              error: function (counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
             
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
             
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("hits", 1);
            newcounter.save(null, {
              success: function (newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('hits'));
              },
              error: function (newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function (error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function () {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        
        addCount(Counter);
      } else if ($('.post-link').length > 1) {
        
        showHitCount(Counter);
      }
    });
  </script>





  <script>
    $("#openSearch, #openSearchMobile").click(function(){
      $(".modal-dialog").addClass("visible");
    });

    $("#closeSearch").click(function(){
      $(".modal-dialog").removeClass("visible");
    });

    $(document).click(function(event) {
    
      if (!$(event.target).closest(".modal-content, #openSearch, #openSearchMobile").length) {
        $("body").find(".modal-dialog").removeClass("visible");
      }
    });
  </script>





</body>
</html>
