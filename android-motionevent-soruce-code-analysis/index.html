<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Android 事件分发机制源码流程分析 - midFang&#39;s Blog</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="midFang" />
  <meta name="description" content="假设我们的 Activity 中的布局是这样的
" />

  <meta name="keywords" content="Hugo, theme, jane" />






<meta name="generator" content="Hugo 0.58.3" />


<link rel="canonical" href="https://midFang.github.io/android-motionevent-soruce-code-analysis/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.af20b78e95c84de86b00a0242a4a77bd2601700e1b250edf27537d957ac0041d.css" integrity="sha256-ryC3jpXITehrAKAkKkp3vSYBcA4bJQ7fJ1N9lXrABB0=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="Android 事件分发机制源码流程分析" />
<meta property="og:description" content="假设我们的 Activity 中的布局是这样的

" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://midFang.github.io/android-motionevent-soruce-code-analysis/" />
<meta property="article:published_time" content="2020-12-02T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-12-02T00:00:00+00:00" />
<meta itemprop="name" content="Android 事件分发机制源码流程分析">
<meta itemprop="description" content="假设我们的 Activity 中的布局是这样的

">


<meta itemprop="datePublished" content="2020-12-02T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2020-12-02T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="3657">



<meta itemprop="keywords" content="Android,源码分析,事件分发," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Android 事件分发机制源码流程分析"/>
<meta name="twitter:description" content="假设我们的 Activity 中的布局是这样的

"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">midFang's Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/">首页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/post/">全部文章</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/about/">关于</a>
          
        
      </li>
    

    
      <li class="mobile-menu-item">
        <a id="openSearchMobile" class="mobile-menu-item-link menu-item-search" href="#">
          <i class="iconfont">
            <svg version="1.1" viewBox="0 0 1024 1024"
  xmlns="http://www.w3.org/2000/svg" width="18" height="18"
  xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M973.81454219 973.81454219a91.78207815 91.78207815 0 0 1-129.80999631 0l-161.97482118-161.97482118a425.48527711 425.48527711 0 0 1-230.35931791 68.16531768 428.3346319 428.3346319 0 1 1 428.3346319-428.3346319 425.48527711 425.48527711 0 0 1-68.16531768 230.35931791l162.02961656 161.97482118a91.83687354 91.83687354 0 0 1-0.05479538 129.80999631zM451.67040679 145.69361559a305.97679241 305.97679241 0 1 0 0 611.95358361 305.97679241 305.97679241 0 0 0 0-611.95358361z">
  </path>
</svg>

          </i>
        </a>
      </li>
    
  </ul>
</nav>


  

  
    
<div class="modal-dialog">
    
    <div class="modal-content">
      <div id="closeSearch" title="Close" class="close">X</div>
      <div class="modal-header">
        <div class="modal-title">Search</div>
      </div>
      <div class="modal-body">
          <script>
            (function() {
              var cx = '57787f7f4d21d54fc';
              var gcse = document.createElement('script');
              gcse.type = 'text/javascript';
              gcse.async = true;
              gcse.src = (document.location.protocol == 'https:' ? 'https:' :
                  'http:') +
                '//cse.google.com/cse.js?cx=' + cx;
              var s = document.getElementsByTagName('script')[0];
              s.parentNode.insertBefore(gcse, s);
            })();
          </script>
          <gcse:search></gcse:search>
      </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      midFang's Blog
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/">首页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/post/">全部文章</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://midFang.github.io/about/">关于</a>
          

        

      </li>
    

    
    

    
      <li class="menu-item">
        <a id="openSearch" class="menu-item-link menu-item-search" href="#">
          <i class="iconfont">
            <svg version="1.1" viewBox="0 0 1024 1024"
  xmlns="http://www.w3.org/2000/svg" width="18" height="18"
  xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M973.81454219 973.81454219a91.78207815 91.78207815 0 0 1-129.80999631 0l-161.97482118-161.97482118a425.48527711 425.48527711 0 0 1-230.35931791 68.16531768 428.3346319 428.3346319 0 1 1 428.3346319-428.3346319 425.48527711 425.48527711 0 0 1-68.16531768 230.35931791l162.02961656 161.97482118a91.83687354 91.83687354 0 0 1-0.05479538 129.80999631zM451.67040679 145.69361559a305.97679241 305.97679241 0 1 0 0 611.95358361 305.97679241 305.97679241 0 0 0 0-611.95358361z">
  </path>
</svg>

          </i>
        </a>
      </li>
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">Android 事件分发机制源码流程分析</h1>
      
      <div class="post-meta">
        <time datetime="2020-12-02" class="post-time">
          2020-12-02
        </time>
        <div class="post-category">
            <a href="https://midFang.github.io/categories/android/"> Android </a>
            <a href="https://midFang.github.io/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"> 源码分析 </a>
            <a href="https://midFang.github.io/categories/%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91/"> 事件分发 </a>
            
          </div>
        

        
        
          <span id="busuanzi_container_page_pv">
            | 阅读 <span id="busuanzi_value_page_pv"></span>
          </span>
        

        
        
          <span id="/android-motionevent-soruce-code-analysis/" class="leancloud_visitors" data-flag-title="Android 事件分发机制源码流程分析">
            <span class="post-meta-item-text"> | 阅读 </span>
            <span class="leancloud-visitors-count"></span>
          </span>
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#viewgroup-的事件处理过程">ViewGroup 的事件处理过程</a></li>
<li><a href="#view-对点击事件处理过程">View 对点击事件处理过程</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <p>假设我们的 Activity 中的布局是这样的</p>

<p><img src="https://raw.githubusercontent.com/midFang/imgSource/main/20201129231947.png" alt="" /></p>

<h3 id="viewgroup-的事件处理过程">ViewGroup 的事件处理过程</h3>

<p>当在屏幕中手指按下，首先事件分发的流程最初都是从 Activity 的 dispatchTouchEvent 开始的，假设如上的界面中，我们点击了 Button 控件，看下此次流程是怎么样的，看下 Activity 中里面做了什么</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">boolean</span> <span class="n">dispatchTouchEvent</span><span class="p">(</span><span class="n">MotionEvent</span> <span class="nf">ev</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="na">getAction</span><span class="p">()</span> <span class="o">==</span> <span class="n">MotionEvent</span><span class="p">.</span><span class="na">ACTION_DOWN</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">onUserInteraction</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">getWindow</span><span class="p">().</span><span class="na">superDispatchTouchEvent</span><span class="p">(</span><span class="n">ev</span><span class="p">))</span> <span class="p">{</span> 
        <span class="c1">// 如果改事件未处理，返回了 false ，则会回调 activity 自己的 onTouchEvent 方法中处理
</span><span class="c1"></span>        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">onTouchEvent</span><span class="p">(</span><span class="n">ev</span><span class="p">);</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>onUserInteraction 方法是一个空的实现，并没有做什么处理，紧接着是调用了 getWindow 中的 superDispatchTouchEvent 方法。进入到 Window 的抽象类中，可以发现官方的解释，Window 的唯一实现类就是 PhoneWindow， 所以这里调用的就是 PhoneWindow 中的方法了，看下这里做了什么处理</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="nf">boolean</span> <span class="n">superDispatchTouchEvent</span><span class="p">(</span><span class="n">MotionEvent</span> <span class="nf">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">mDecor</span><span class="p">.</span><span class="na">superDispatchTouchEvent</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>这里调用的 mDecor.superDispatchTouchEvent(event) 方法， 这里如果了解 Activity 的视图结构的话，其实就会知道 mDecor 就是 DecorView ，再看下这个类的具体实现是什么</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">boolean</span> <span class="n">superDispatchTouchEvent</span><span class="p">(</span><span class="n">MotionEvent</span> <span class="nf">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">super</span><span class="p">.</span><span class="na">dispatchTouchEvent</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>由于 DecorView 继承自 FrameLayout ，而 FrameLayout 继承自 ViewGroup ，所以最终的调用也就是到了 ViewGroup 当中，其实可以发现，这里从 Activity 整个流程下来，并没有做什么逻辑上的判断处理，都只是交给另外一个类去处理。既然如此，就看下 ViewGroup 中的代码是如何实现的吧，不过 ViewGroup 中的代码比较复杂，我们先可以看下一段伪代码的实现，大致流程是这样的，代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="nf">boolean</span> <span class="n">dispatchTouchEvent</span><span class="p">(</span><span class="n">MotionEvent</span> <span class="nf">ev</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">boolean</span> <span class="nf">consume</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">onInterceptTouchEvent</span><span class="p">(</span><span class="n">ev</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">consume</span> <span class="o">=</span> <span class="n">onTouchEvent</span><span class="p">(</span><span class="n">ev</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">consume</span> <span class="o">=</span> <span class="n">child</span><span class="p">.</span><span class="na">dispatchTouchEvent</span><span class="p">(</span><span class="n">ev</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">consume</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>这段代码其实就可以很直观的表现出 ViewGroup 的传递流程，基本上是算递归的层层调用，首先在当前的 ViewGroup 的话，会经过自己的 dispatchTouchEvent 方法，然后再询问经过 onInterceptTouchEvent 方法，确认事件是否需要拦截，如果返回 true 代表拦截当前事件，那么会经过自己的 onTouchEvent 方法。如果返回 false，不拦截，那么会传递到子 View 的 dispatchTouchEvent 方法中，如此反复，直到事件结束。</p>

<p>接着我们再看下 ViewGroup 中具体的实现，由于这个方法比较长，先看部分的实现，做分段说明，先看下面这一点，很显然，它描述的逻辑是是否拦截点击事件这个逻辑，代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">boolean</span> <span class="n">dispatchTouchEvent</span><span class="p">(</span><span class="n">MotionEvent</span> <span class="nf">ev</span><span class="p">)</span> <span class="p">{</span> 
		<span class="kd">final</span> <span class="nf">boolean</span> <span class="n">intercepted</span><span class="p">;</span>
		 <span class="k">if</span> <span class="p">(</span><span class="n">actionMasked</span> <span class="o">==</span> <span class="n">MotionEvent</span><span class="p">.</span><span class="na">ACTION_DOWN</span>
		         <span class="o">||</span> <span class="n">mFirstTouchTarget</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
		     <span class="kd">final</span> <span class="nf">boolean</span> <span class="n">disallowIntercept</span> <span class="o">=</span> <span class="p">(</span><span class="n">mGroupFlags</span> <span class="o">&amp;</span> <span class="n">FLAG_DISALLOW_INTERCEPT</span><span class="p">)</span> <span class="o">!=</span> <span class="n">0</span><span class="p">;</span>
		   
		    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disallowIntercept</span><span class="p">)</span> <span class="p">{</span>
		        <span class="n">intercepted</span> <span class="o">=</span> <span class="n">onInterceptTouchEvent</span><span class="p">(</span><span class="n">ev</span><span class="p">);</span>
		        <span class="n">ev</span><span class="p">.</span><span class="na">setAction</span><span class="p">(</span><span class="n">action</span><span class="p">);</span> <span class="c1">// restore action in case it was changed
</span><span class="c1"></span>		    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		        <span class="n">intercepted</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
		    <span class="p">}</span>
		   
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="n">intercepted</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
		<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<ol>
<li><p>从这段代码可以看出来，ViewGroup 会判断是否需要拦截当前事件，<code>这里说的当前事件一般是指的某一个事件，最先开始的也就是 down 事件，一般一组事件，叫一组事件序列，也就是按下，移动，抬起</code>有两个条件，一个是当前的事件类型为 ACTION_DOWN，然后就是  mFirstTouchTarget != null ，这个 mFirstTouchTarget 是什么意思呢，从下面后续的源码中可以看出来，只要是当事件<code>经过了</code> ViewGroup 的子元素时候，那么 mFirstTouchTarget 会被赋值，所以，如果再后后续事件 ACTION_MOVE 和 ACTION_UP 事件，那么这个判断条件也会成立。同理，如果当前事件未传递到子 View 上，那么 mFirstTouchTarget 就会为 null，那么后续的 move 和 up 事件都不会再经过 onInterceptTouchEvent 方法。其实这也就间接的说明了，onInterceptTouchEvent 不是每次都会被调用的，所以在处理事件冲突的时候，要注意这个情况，可以将自己的处理事件冲突的方法放在 dispatchTouchEvent 方法中</p></li>

<li><p>不过这里还有一个参数，那就是 FLAG_DISALLOW_INTERCEPT 标记位，一般情况下，如果不设置的话，disallowIntercept 一般为 false，一般修改这个值的话，是在子 View 中通过 requestDisallowInterceptTouchEvent 方法，来修改这个标记位的。这个标记位一旦被设置，也就是 disallowIntercept 某种条件下为 true 的时候，那么就会导致除了 ACTION_DOWN 的以外事件无法接受，为什么说除了 ACTION_DOWN 的以外事件呢 ？因为 ViewGroup 在事件分发时候，如果是 ACTION_DOWN 的时候，会重置这个状态，导致子view设置的这个标记位无效。因此，当面对 ACTION_DOWN 事件时，ViewGroup 总是会询问自己的 onInterceptTouchEvent 方法是否需要拦截事件。那么在 ACTION_DOWN 的时候，是怎么恢复的呢 ?</p></li>
</ol>

<p>代码如下 :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="k">if</span> <span class="p">(</span><span class="n">actionMasked</span> <span class="o">==</span> <span class="n">MotionEvent</span><span class="p">.</span><span class="na">ACTION_DOWN</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cancelAndClearTouchTargets</span><span class="p">(</span><span class="n">ev</span><span class="p">);</span>
    <span class="n">resetTouchState</span><span class="p">();</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>如上所示，每次在 ACTION_DOWN 的时候，都会在调用 resetTouchState 方法，然后重置这个标记位。</p>

<p>接着再看看 ViewGroup <code>不拦截事件</code>的时候，事件会向下分发给它的子 View 进行处理，看看源码是怎么处理的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">canceled</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">intercepted</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 事件没有被拦截            
</span><span class="c1"></span>			<span class="kd">final</span> <span class="nf">View</span><span class="p">[]</span> <span class="n">children</span> <span class="o">=</span> <span class="n">mChildren</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="nf">i</span> <span class="o">=</span> <span class="n">childrenCount</span> <span class="o">-</span> <span class="n">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">final</span> <span class="nf">int</span> <span class="n">childIndex</span> <span class="o">=</span> <span class="n">getAndVerifyPreorderedIndex</span><span class="p">(</span>
                 <span class="n">childrenCount</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">customOrder</span><span class="p">);</span>
         <span class="kd">final</span> <span class="nf">View</span> <span class="n">child</span> <span class="o">=</span> <span class="n">getAndVerifyPreorderedView</span><span class="p">(</span>
                 <span class="n">preorderedList</span><span class="p">,</span> <span class="n">children</span><span class="p">,</span> <span class="n">childIndex</span><span class="p">);</span>

         <span class="k">if</span> <span class="p">(</span><span class="n">childWithAccessibilityFocus</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
             <span class="k">if</span> <span class="p">(</span><span class="n">childWithAccessibilityFocus</span> <span class="o">!=</span> <span class="n">child</span><span class="p">)</span> <span class="p">{</span>
                 <span class="k">continue</span><span class="p">;</span>
             <span class="p">}</span>
             <span class="n">childWithAccessibilityFocus</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
             <span class="n">i</span> <span class="o">=</span> <span class="n">childrenCount</span> <span class="o">-</span> <span class="n">1</span><span class="p">;</span>
         <span class="p">}</span>

         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">canViewReceivePointerEvents</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                                    <span class="o">||</span> <span class="o">!</span><span class="n">isTransformedTouchPointInView</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="kc">null</span><span class="p">))</span> <span class="p">{</span>
			    <span class="n">ev</span><span class="p">.</span><span class="na">setTargetAccessibilityFocus</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
			    <span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">newTouchTarget</span> <span class="o">=</span> <span class="n">getTouchTarget</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">newTouchTarget</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
			    <span class="n">newTouchTarget</span><span class="p">.</span><span class="na">pointerIdBits</span> <span class="o">|=</span> <span class="n">idBitsToAssign</span><span class="p">;</span>
			    <span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">resetCancelNextUpFlag</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dispatchTransformedTouchEvent</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">idBitsToAssign</span><span class="p">))</span> <span class="p">{</span>
        
          <span class="n">newTouchTarget</span> <span class="o">=</span> <span class="n">addTouchTarget</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">idBitsToAssign</span><span class="p">);</span>
          <span class="n">alreadyDispatchedToNewTouchTarget</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>上述代码首先是遍历 ViewGroup 中的所有子 View，然后判断子 View <code>是否能够接受到事件</code>，是否能够接受到事件有两点可以来衡量，一个是子 View 是否正在播放动画和点击事件的坐标是否在子 View 的区域内。如果都不符合，continue 后继续询问下一个子元素。其中 dispatchTransformedTouchEvent 方法其实就是事件往子 View 进行分发的方法，在他的内部有如下一段代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">handled</span> <span class="o">=</span> <span class="kd">super</span><span class="p">.</span><span class="na">dispatchTouchEvent</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
     <span class="n">handled</span> <span class="o">=</span> <span class="n">child</span><span class="p">.</span><span class="na">dispatchTouchEvent</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>其实就是根据 dispatchTransformedTouchEvent 方法传递的 child 来做的区分，如果 child 为null，那么将会调用自身 View 的 dispatchTouchEvent 方法，如果不为 null ，那么将会调用子 View 的  dispatchTouchEvent 方法，这样就算是完成了一轮的事件分发。</p>

<p>如果子 View 的 dispatchTouchEvent 返回 true，也就是当前事件被消费了，那么 dispatchTransformedTouchEvent 就会为 true，那么就会调用如下代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="k">if</span> <span class="p">(</span><span class="n">dispatchTransformedTouchEvent</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">idBitsToAssign</span><span class="p">))</span> <span class="p">{</span> 
     <span class="c1">// 事件被消费，返回 true
</span><span class="c1"></span>     <span class="n">newTouchTarget</span> <span class="o">=</span> <span class="n">addTouchTarget</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">idBitsToAssign</span><span class="p">);</span>
     <span class="n">alreadyDispatchedToNewTouchTarget</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
     <span class="k">break</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>其中，addTouchTarget 方法中，其实是<code>给 mFirstTouchTarget 给赋值</code>了，这里的 mFirstTouchTarget 和 newTouchTarget 其实是相等的， mFirstTouchTarget 这个值也就是我们上面提到过的，在 ViewGroup 当前事件传递到了子 View 中，也就是调用 handled = child.dispatchTouchEvent(event) 返回了 true，那么 mFirstTouchTarget 就<code>不会为 null</code>， 那么后续如果有 ACTION_MOVE 和 ACTION_UP 事件，那么也可以收到事件了。看看  addTouchTarget 内部是如何实现的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="nf">TouchTarget</span> <span class="n">addTouchTarget</span><span class="p">(</span><span class="nd">@NonNull</span> <span class="n">View</span> <span class="nf">child</span><span class="p">,</span> <span class="kt">int</span> <span class="nf">pointerIdBits</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">final</span> <span class="nf">TouchTarget</span> <span class="n">target</span> <span class="o">=</span> <span class="n">TouchTarget</span><span class="p">.</span><span class="na">obtain</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">pointerIdBits</span><span class="p">);</span>
    <span class="n">target</span><span class="p">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">mFirstTouchTarget</span><span class="p">;</span> <span class="c1">// 下一个子元素，进行赋值，是一个单链表结构
</span><span class="c1"></span>    <span class="n">mFirstTouchTarget</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">target</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>上述代码可以很明显的看到，mFirstTouchTarget 被赋值，<code>mFirstTouchTarget 是否被赋值，将直接影响到 ViewGroup 对事件的拦截策略，如果mFirstTouchTarget 为 null ，那么 ViewGroup 默认拦截接下来同一事件序列中所有的点击事件，也就是后续 ACTION_MOVE 和 ACTION_UP 事件被拦截了</code></p>

<p>需要注意的是，如果上面代码中的 for 循环遍历所有的子元素如果都没有被处理的话，这包含了两种情况，<strong>第一种是 ViewGroup 没有子元素；第二种是子元素在 dispatchTouchEvent 中返回了 false，这一般是因为子元素中 onTouchEvent 中返回了 false</strong>（其实也就说明了这两种情况都是导致 mFirstTouchTarget 为 null 的情况发生的原因）也就是对应上面的源码部分 dispatchTransformedTouchEvent 返回了 false。这种情况下，ViewGroup 会处理自己的点击事件。然后会调用如下的代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="k">if</span> <span class="p">(</span><span class="n">mFirstTouchTarget</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// No touch targets so treat this as an ordinary view.
</span><span class="c1"></span>    <span class="n">handled</span> <span class="o">=</span> <span class="n">dispatchTransformedTouchEvent</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="n">canceled</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span>
                        <span class="n">TouchTarget</span><span class="p">.</span><span class="na">ALL_POINTER_IDS</span><span class="p">);</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>到了这里 child 传递的 null 了，从上面的分析可以看出，那么调用的就是 super.dispatchTouchEvent(event) 的方法了，其实，也就是调动到了 View 的 super.dispatchTouchEvent 方法了，即点击事件开始交给 View 来处理了。这里也就可以说明一个情况了，只有 ViewGroup 会传递事件一级一级的往下分发，当这个 View <code>没有子元素</code>(View 没有子元素，ViewGroup 可以没有子元素)，随即也就切回到 View 的事件处理过程了。</p>

<h3 id="view-对点击事件处理过程">View 对点击事件处理过程</h3>

<p>View 对点击事件的处理过程会简单一些，注意这里是 View， 而不是 ViewGroup，看下他的 dispatchTouchEvent 方法实现</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="k">if</span> <span class="p">(</span><span class="n">onFilterTouchEventForSecurity</span><span class="p">(</span><span class="n">event</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">mViewFlags</span> <span class="o">&amp;</span> <span class="n">ENABLED_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">ENABLED</span> <span class="o">&amp;&amp;</span> <span class="n">handleScrollBarDragging</span><span class="p">(</span><span class="n">event</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="c1">//noinspection SimplifiableIfStatement
</span><span class="c1"></span>            <span class="n">ListenerInfo</span> <span class="nf">li</span> <span class="o">=</span> <span class="n">mListenerInfo</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">li</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">li</span><span class="p">.</span><span class="na">mOnTouchListener</span> <span class="o">!=</span> <span class="kc">null</span>
                    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mViewFlags</span> <span class="o">&amp;</span> <span class="n">ENABLED_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">ENABLED</span>
                    <span class="o">&amp;&amp;</span> <span class="n">li</span><span class="p">.</span><span class="na">mOnTouchListener</span><span class="p">.</span><span class="na">onTouch</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">event</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span> <span class="o">&amp;&amp;</span> <span class="n">onTouchEvent</span><span class="p">(</span><span class="n">event</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>这里的事件处理会比较简单，因为 View （不是 ViewGroup）是一个<code>单独的元素</code>，它没有子元素，无法向下传递事件，所以它只能够自己处理，这里唯一要注意的就是几个优先级了，首先是会判断有没有设置 mOnTouchListener 事件，如果外部设置了，并且在 onTouch 方法中返回了 true，那么 onTouchEvent 方法将不会被调用，如果返回 false，则会调用 onTouchEvent 方法，所以说 onTouch 方法比 onTouchEvent 方法优先级高一些。再看看 View 中的 onTouchEvent 是如何实现的，这里我们也进行一点点的拆分，代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">final</span> <span class="nf">boolean</span> <span class="n">clickable</span> <span class="o">=</span> <span class="p">((</span><span class="n">viewFlags</span> <span class="o">&amp;</span> <span class="n">CLICKABLE</span><span class="p">)</span> <span class="o">==</span> <span class="n">CLICKABLE</span>
                <span class="o">||</span> <span class="p">(</span><span class="n">viewFlags</span> <span class="o">&amp;</span> <span class="n">LONG_CLICKABLE</span><span class="p">)</span> <span class="o">==</span> <span class="n">LONG_CLICKABLE</span><span class="p">)</span>
                <span class="o">||</span> <span class="p">(</span><span class="n">viewFlags</span> <span class="o">&amp;</span> <span class="n">CONTEXT_CLICKABLE</span><span class="p">)</span> <span class="o">==</span> <span class="n">CONTEXT_CLICKABLE</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">viewFlags</span> <span class="o">&amp;</span> <span class="n">ENABLED_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">DISABLED</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">MotionEvent</span><span class="p">.</span><span class="na">ACTION_UP</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mPrivateFlags</span> <span class="o">&amp;</span> <span class="n">PFLAG_PRESSED</span><span class="p">)</span> <span class="o">!=</span> <span class="n">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">setPressed</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">mPrivateFlags3</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PFLAG3_FINGER_DOWN</span><span class="p">;</span>
            <span class="c1">// A disabled view that is clickable still consumes the touch
</span><span class="c1"></span>            <span class="c1">// events, it just doesn&#39;t respond to them.
</span><span class="c1"></span>            <span class="k">return</span> <span class="n">clickable</span><span class="p">;</span>
        <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>可以看到，View 如果是 DISABLED 不可用的状态的，仍然会根据 clickable （根据控件点击事件状态） 的结果值，去消费响应事件的。尽管这个控件是不可用的。</p>

<p>紧接着会调用如下代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="k">if</span> <span class="p">(</span><span class="n">mTouchDelegate</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mTouchDelegate</span><span class="p">.</span><span class="na">onTouchEvent</span><span class="p">(</span><span class="n">event</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>如果 View 设置有代理，那么会执行 mTouchDelegate.onTouchEvent 方法</p>

<p>再看下 onTouchEvent  中对事件处理的具体事件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="k">if</span> <span class="p">(</span><span class="n">clickable</span> <span class="o">||</span> <span class="p">(</span><span class="n">viewFlags</span> <span class="o">&amp;</span> <span class="n">TOOLTIP</span><span class="p">)</span> <span class="o">==</span> <span class="n">TOOLTIP</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">case</span> <span class="n">MotionEvent</span><span class="p">.</span><span class="na">ACTION_UP</span><span class="o">:</span>
                            <span class="c1">// Only perform take click actions if we were in the pressed state
</span><span class="c1"></span>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">focusTaken</span><span class="p">)</span> <span class="p">{</span>
                                <span class="c1">// Use a Runnable and post this rather than calling
</span><span class="c1"></span>                                <span class="c1">// performClick directly. This lets other visual state
</span><span class="c1"></span>                                <span class="c1">// of the view update before click actions start.
</span><span class="c1"></span>                                <span class="k">if</span> <span class="p">(</span><span class="n">mPerformClick</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                                    <span class="n">mPerformClick</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PerformClick</span><span class="p">();</span>
                                <span class="p">}</span>
                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">post</span><span class="p">(</span><span class="n">mPerformClick</span><span class="p">))</span> <span class="p">{</span>
                                    <span class="n">performClickInternal</span><span class="p">();</span>
                                <span class="p">}</span>
                            <span class="p">}</span>
                        
                    <span class="k">break</span><span class="p">;</span>

                <span class="k">case</span> <span class="n">MotionEvent</span><span class="p">.</span><span class="na">ACTION_DOWN</span><span class="o">:</span>
            		<span class="c1">// ...
</span><span class="c1"></span>                 
                    <span class="k">break</span><span class="p">;</span>

                <span class="k">case</span> <span class="n">MotionEvent</span><span class="p">.</span><span class="na">ACTION_MOVE</span><span class="o">:</span>
                <span class="c1">// ...
</span><span class="c1"></span>                    
                    <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="c1">// 最终消费了事件
</span><span class="c1"></span> <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>根据上面的 clickable 状态可以知道，只要 CLICKABLE 或者是 LONG_CLICKABLE 有一个状态为 true， 那么 onTouchEvent 就会返回为 true，那么代表它消费了事件，不管他是不是 DISABLE 的状态。其中这里当手指抬起的时候，那么就会进入  ACTION_UP 代码块中，然后调用 performClickInternal 方法，然后再调用 performClick 方法，如果 View 设置了 OnClickListener 的话，那么就会触发 onClick 方法执行。performClick 方法代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">boolean</span> <span class="n">performClick</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// We still need to call this method to handle the cases where performClick() was called
</span><span class="c1"></span>        <span class="c1">// externally, instead of through performClickInternal()
</span><span class="c1"></span>        <span class="n">notifyAutofillManagerOnClick</span><span class="p">();</span>

        <span class="kd">final</span> <span class="nf">boolean</span> <span class="n">result</span><span class="p">;</span>
        <span class="kd">final</span> <span class="nf">ListenerInfo</span> <span class="n">li</span> <span class="o">=</span> <span class="n">mListenerInfo</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">li</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">li</span><span class="p">.</span><span class="na">mOnClickListener</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">playSoundEffect</span><span class="p">(</span><span class="n">SoundEffectConstants</span><span class="p">.</span><span class="na">CLICK</span><span class="p">);</span>
            <span class="c1">// 最终调用 onClick 方法，将 View 对象传递出去
</span><span class="c1"></span>            <span class="n">li</span><span class="p">.</span><span class="na">mOnClickListener</span><span class="p">.</span><span class="na">onClick</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">sendAccessibilityEvent</span><span class="p">(</span><span class="n">AccessibilityEvent</span><span class="p">.</span><span class="na">TYPE_VIEW_CLICKED</span><span class="p">);</span>

        <span class="n">notifyEnterOrExitForAutoFillIfNeeded</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>从 ViewGroup 的事件分发，到最后直接给到 View 处理，点击事件的分发机制源码就已经分析完了。</p>

<p>掌握了事件分发是如何进行的，那么就可以很容易的解决事件冲突了，其实针对于事件冲突，也是有套路轨迹可循的，下一节，将分析事件冲突如何解决。</p>
    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">midFang</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
      2020-12-02
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://midFang.github.io/tags/android/">Android</a>
          <a href="https://midFang.github.io/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a>
          <a href="https://midFang.github.io/tags/%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91/">事件分发</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/android-motionevent-sliding-conflict/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">Android 事件分发的冲突解决方案</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/android-kotlin-thread-coroutine/">
            <span class="next-text nav-default">Android 协程编写高效的并发程序</span>
            <span class="prev-text nav-mobile">Next</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "midFang/blog-comments"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="https://github.com/midFang" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="https://stackoverflow.com/users/14331888/midfang" rel="me noopener" class="iconfont"
      title="stack-overflow"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M809.714286 932.571429l-638.857143 0 0-274.285714-91.428571 0 0 365.714286 821.714286 0 0-365.714286-91.428571 0 0 274.285714zm-538.285714-299.428571l18.857143-89.714286 447.428571 94.285714-18.857143 89.142857zm58.857143-213.714286l38.285714-83.428571 414.285714 193.714286-38.285714 82.857143zm114.857143-203.428571l58.285714-70.285714 350.857143 293.142857-58.285714 70.285714zm226.857143-216l272.571429 366.285714-73.142857 54.857143-272.571429-366.285714zm-410.285714 840.571429l0-90.857143 457.142857 0 0 90.857143-457.142857 0z"></path>
</svg>

    </a>
  
    <a href="https://www.douban.com/people/194654920/" rel="me noopener" class="iconfont"
      title="douban"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M926.917973 37.80608C959.65184 37.80608 986.19392 64.34816 986.19392 97.082027L986.19392 926.917973C986.19392 959.65184 959.65184 986.19392 926.917973 986.19392L97.082027 986.19392C64.34816 986.19392 37.80608 959.65184 37.80608 926.917973L37.80608 97.082027C37.80608 64.34816 64.34816 37.80608 97.082027 37.80608zM176.653653 176.19968 176.653653 252.678827 825.658027 252.678827 825.658027 176.19968zM217.719467 316.146347 217.719467 628.08064 273.524053 628.08064 341.292373 770.39616 157.259093 770.39616 157.259093 845.417813 842.949973 845.417813 842.949973 770.39616 654.226773 770.39616 722.899627 628.08064 783.67744 628.08064 783.67744 316.146347zM684.885333 392.891733 684.885333 553.987413 312.576 553.987413 312.576 392.891733zM570.770773 770.39616 426.653013 770.39616 359.621973 628.08064 639.443627 628.08064z"></path>
</svg>

    </a>


<a href="https://midFang.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2020 -
    2024
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        midFang
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>















  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script type="text/javascript">
    AV.initialize( null ,  null );
  </script>

  <script>
    function showHitCount(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push($(this).attr("id").trim());
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var hits = item.get('hits');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(hits);
          }
          for (var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if (countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function (results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("hits");
            counter.save(null, {
              success: function (counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('hits'));
              },
              error: function (counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
             
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
             
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("hits", 1);
            newcounter.save(null, {
              success: function (newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('hits'));
              },
              error: function (newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function (error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function () {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        
        addCount(Counter);
      } else if ($('.post-link').length > 1) {
        
        showHitCount(Counter);
      }
    });
  </script>





  <script>
    $("#openSearch, #openSearchMobile").click(function(){
      $(".modal-dialog").addClass("visible");
    });

    $("#closeSearch").click(function(){
      $(".modal-dialog").removeClass("visible");
    });

    $(document).click(function(event) {
    
      if (!$(event.target).closest(".modal-content, #openSearch, #openSearchMobile").length) {
        $("body").find(".modal-dialog").removeClass("visible");
      }
    });
  </script>





</body>
</html>
